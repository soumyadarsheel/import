var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}return target;};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}(function(){var _this=this;var Bot=function Bot(botState){var _=botState._;var R=botState.R;var D=botState.developer;botState.runProfile=Developer.PROD();var LAST_LOGIN='lastLogin';var PREVIOUS_INTENT='previousIntent';var NLPId='FMBot';var appName='FrontM';if(botState.currentUserDomain==='onship'){NLPId='onshipAssistant';appName='onship';}if(botState.currentUserDomain==='shair'){NLPId='shAir_Assistant';appName='ShAir';}var smartSuggestionsConstants={EMAILHISTORY:'Email me usage history',CHECKCALLRATES:'Check calling rates',WHYUSEFRONTMCALLS:'Why use '+appName+' voice calling'};var INMARSAT='Inmarsat';var IRIDIUM='Iridium';var SAT_PHONE='SAT_PHONE';var YES='Yes, sure';var NO='No';var SELECT_POLLING_STRATEGY='Internet usage settings';var TERRESTRIAL_POLLING_STRATEGY='Terrestrial';var SATELLITE_POLLING_STRATEGY='Satellite';var MANUAL_POLLING_STRATEGY='Manual';var AUTOMATIC_POLLING_STRATEGY='Automatic';var CANCEL_POLLING_STRATEGY='Leave it as it is';var MY_ACCOUNT='My Account';var CANCEL_MY_ACCOUNT='Leave my account as is';var CHANGE_PASSWORD='Change Password';var LOGOUT='Logout';var ACTIVE_PUSH_NOTIFICATIONS='Activate Notifications';var DEACTIVE_PUSH_NOTIFICATIONS='Deactivate Notifications';var LOGOUT_INTENT='logoutIntent';var DEREGISTER_PUSH_ON_EDGE='deregisterPushOnEdge';var DEREGISTER_PUSH_ON_BACKEND='deregisterPushOnBackend';var AUTO_INSTALLATION_STATUS='autoInstallationStatus';var NOTIFICATION_CHANGES_IN_PROGRESS='notificationsChangesInProgress';var COMPLAINT_FORM='COMPLAINT_FORM';var CHANGE_PASSWORD_FORM='passwordForm';var ALL_QUESTIONS='allQuestions';var HOW_TO_USE_FRONTM='How to use '+appName+'?';var HOW_DO_I_MAKE_CALLS='How do I make calls?';var HOW_DO_I_ADD_CALL_CREDIT='How do I add call credit?';var HOW_DO_I_ADD_CONTACTS='How do I add contacts?';var WHAT_ARE_CHANNELS='What are groups?';var INVITE_PEOPLE_TO_FRONTM='How do I invite people to '+appName+'?';var WELCOME_MESSAGE='Welcome to '+appName+' Assistant. I am here to assist you with setup and answer your questions. All you need to do is chat with me here.';var suggestionsArrayForPredictions=function suggestionsArrayForPredictions(){return[Intent.SPEECH(),Intent.NO_INTENT(),main.intentId,yesPush.intentId,automaticPollingStrategy.intentId,satellitePollingStrategy.intentId,terrestrialPollingStrategy.intentId,manualPollingStrategy.intentId,cancelPollingStrategySelection.intentId,cancelMyAccount.intentId,noLogout.intentId,noBackend.intentId,deregisterPushOnBackend.intentId,tariffCheck.intentId,tariffCheckSat.intentId,emailUsageHistory.intentId,callSatFailed.intentId,inviteQuestion,howToUseFrontM.intentId,howDoIAddCallCredits.intentId,howDoIAddContacts.intentId,whatIsFrontM.intentId,howToAccessApps.intentId,cannotFindApp.intentId,howToChat.intentId,dunno.intentId,howToMakeCalls.intentId,inviteQuestion.intentId,chgPasswordForm.intentId,complaintForm.intentId];};var complaintForm=new Form2(COMPLAINT_FORM,{title:'Support Request',description:'Click here to enter details',confirm:'Save',cancel:'Cancel'});complaintForm.runOnCloud();var title=new Form2Field('title',{form:complaintForm,title:'Title',type:FormFieldTypes.TEXT_FIELD()});var description=new Form2Field('description',{form:complaintForm,title:'Description',type:FormFieldTypes.TEXT_AREA(),mandatory:true});complaintForm.onSubmit=function _callee(){var ticket,supportId,body,clientBody;return regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:ticket=Form2.formResponseAsObject(botState.messageFromUser);supportId=Math.round(Math.random()*(99999999-1)+1);body='Support request; support id: '+supportId+'\n                Title: '+ticket.title+'\n                Description: '+ticket.description+'\n                User Email: '+botState.user.userEmail;clientBody='Thank you for contacting '+appName+' Platform.\nWe have opened case \u201C'+supportId+'\u201D to address your issue.\nThe details of your case are as follows:\n\nCase ID: '+supportId+'\nSubject: '+botState.messageFromUser.title+'\n\nTo contact us again about this issue, please email us to support@frontm.com with the case ID in your subject.\n\nSincerely,\nThe '+appName+' Platform Team\n\n*Please note: this e-mail was sent from an address that cannot accept incoming e-mail. Please use support@frontm.com if you need to contact us again about this same issue.\n\nSome of the content and links in this email may have been generated by a '+appName+' customer. '+appName+' is not responsible for the contents or links within.';return _context.abrupt('return',botState.notification.sendEmail('support@frontm.com','Support request from '+botState.user.userEmail,body).then(function(response){return botState.notification.sendEmail(botState.user.userEmail,'Confirmation',clientBody);}).then(function(response){botState.addStringResponse('I have informed our team about your concern, they will contact you soon.');botState.addStringResponse('Your case number is '+supportId);}).catch(function(err){botState.developer.debug('Error while sending mail to support message: '+err);}));case 5:case'end':return _context.stop();}}},null,_this);};var chgPasswordForm=new Form2(CHANGE_PASSWORD_FORM,{title:'Change Password Form',description:'Open this form to change the password',confirm:'Submit',cancel:'Cancel'});var oldPassword=new Form2Field('oldPassword',{form:chgPasswordForm,title:'Old Password',type:FormFieldTypes.PASSWORD_FIELD(),mandatory:true});oldPassword.onMoveOut=function _callee2(){return regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:botState.setField('oldPassword',botState.messageFromUser.currentFieldValue);case 1:case'end':return _context2.stop();}}},null,_this);};var newPassword1=new Form2Field('newPassword1',{form:chgPasswordForm,title:'New Password',info:'Different from the previous passwords. Minimal 8 characters long. At least one capital letter, number and special character',type:FormFieldTypes.PASSWORD_FIELD(),mandatory:true,validation:true});newPassword1.onMoveOut=function _callee3(){var value,response,oldPassword;return regeneratorRuntime.async(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:value=botState.messageFromUser.currentFieldValue;botState.setField('newPassword1',value);response={field:'newPassword1',validationResult:true};oldPassword=botState.getField('oldPassword');if(oldPassword===value){response.validationResult=false;response.validationMessage='Your new password must be different than your old Password';}else if(value.length<8){response.validationResult=false;response.validationMessage='Your new password must be minimal 8 characters long';}botState.addFormChangeResponse(chgPasswordForm.message('validation',response));case 6:case'end':return _context3.stop();}}},null,_this);};var newPassword2=new Form2Field('newPassword2',{form:chgPasswordForm,title:'Repeat Password',info:'For security repeat the password from the previous field',type:FormFieldTypes.PASSWORD_FIELD(),mandatory:true,validation:true});newPassword2.onMoveOut=function _callee4(){var value,newPassword1,response;return regeneratorRuntime.async(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:value=botState.messageFromUser.currentFieldValue;botState.setField('newPassword2',value);newPassword1=botState.getField('newPassword1');response={field:'newPassword2',validationResult:true};if(newPassword1!==value){response.validationResult=false;response.validationMessage="The new password fields don't match";}botState.addFormChangeResponse(chgPasswordForm.message('validation',response));case 6:case'end':return _context4.stop();}}},null,_this);};chgPasswordForm.onSubmit=function _callee5(){var form;return regeneratorRuntime.async(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:form=Form2.formResponseAsObject(botState.messageFromUser);if(form.newPassword1!==form.newPassword2){botState.addErrorToStack(1002,"The new password fields don't match");}else if(form.oldPassword===form.newPassword1){botState.addErrorToStack(1003,'Your new password must be different than your old Password');}else if(botState._.size(form.newPassword1)<8){botState.addErrorToStack(1004,'Your new password must be minimal 8 characters long');}if(!botState.inError){_context5.next=6;break;}botState.addFormResponse(chgPasswordForm.message());_context5.next=7;break;case 6:return _context5.abrupt('return',botState.updatePassword(form.oldPassword,form.newPassword1).then(function(){if(!botState.inError){botState.addStringResponse('Your password have been updated');}}));case 7:case'end':return _context5.stop();}}},null,_this);};botState.nlp.addNlp(NLPId);var main=new Intent('main');main.onResolution=function _callee6(){return regeneratorRuntime.async(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:botState.runFunctionOnceAnHour(function(){var autoInstallationStatus=botState.getField(AUTO_INSTALLATION_STATUS);var lastLogin=botState.getField(LAST_LOGIN);if(!autoInstallationStatus&&!lastLogin||autoInstallationStatus&&lastLogin){if(!lastLogin){botState.addStringResponse('Hello! '+botState.userName);sendWelcomeMessages(botState);botState.setField(LAST_LOGIN,new Date().toUTCString());if(botState.client===State.MOBILECLIENT()){botState.developer.debug('User is on mobile device');if(botState.amIOnline){botState.developer.debug('User is online');}else{botState.developer.debug('User is offline');botState.addStringResponse("You don't appear to have Internet connection at this moment. In order to personalise the app configuration, I need to be online. Let us skip this for now.");}}else{botState.developer.debug('User is on web');}}else{botState.developer.debug('User logged in before');}}});case 1:case'end':return _context6.stop();}}},null,_this);};var showErrorsToUser=function showErrorsToUser(botState){botState.defaultOnError();botState.clearField(NOTIFICATION_CHANGES_IN_PROGRESS);};var yesPush=new Intent('yesPush');yesPush.suggestionsArray=[{lang:'en',list:[ACTIVE_PUSH_NOTIFICATIONS]}];yesPush.onMatching=function(botState){return botState.messageFromUser===ACTIVE_PUSH_NOTIFICATIONS||botState.getNlpResultsForId(NLPId).action==='ActivatePush';};yesPush.onError=function(botState){showErrorsToUser(botState);};yesPush.onResolution=function _callee7(botState){return regeneratorRuntime.async(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:botState.notification.registerDeviceForPushOnEdge();botState.addStringResponse('Push notifications are now active');botState.clearField(PREVIOUS_INTENT);case 3:case'end':return _context7.stop();}}},null,_this);};yesPush.onPrediction=function _callee8(){var notificationsActive;return regeneratorRuntime.async(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:notificationsActive=true;if(!(botState.client===State.MOBILECLIENT()&&botState.location===Intent.EDGE())){_context8.next=5;break;}_context8.next=4;return regeneratorRuntime.awrap(botState.notification.isDeviceRegisteredForPush());case 4:notificationsActive=_context8.sent;case 5:if(!([myAccount.intentId].indexOf(botState.activeIntent)>-1&&!notificationsActive)){_context8.next=7;break;}return _context8.abrupt('return',1);case 7:return _context8.abrupt('return',0);case 8:case'end':return _context8.stop();}}},null,_this);};var yesLogout=new Intent('yesLogout');yesLogout.onMatching=function(botState){var previousIntent=botState.getField(PREVIOUS_INTENT);return(botState.messageFromUser===YES||botState.getNlpResultsForId(NLPId).action==='yes')&&previousIntent===LOGOUT_INTENT;};yesLogout.onError=function(botState){botState.addStringResponse('Logout request failed');_this._.forEach(_this.errorStack,function(error){_this.addStringResponse(error.errorMessage);});botState.clearError();};yesLogout.onResolution=function _callee9(botState){return regeneratorRuntime.async(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:botState.clearField(PREVIOUS_INTENT);return _context9.abrupt('return',botState.logout());case 2:case'end':return _context9.stop();}}},null,_this);};var yes=new Intent('yes');yes.suggestionsArray=[{lang:'en',list:[YES]}];yes.onPrediction=function _callee10(){return regeneratorRuntime.async(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:if(!(botState.getField(NOTIFICATION_CHANGES_IN_PROGRESS)===null&&[logout.intentId].indexOf(botState.activeIntent)>-1)){_context10.next=2;break;}return _context10.abrupt('return',1);case 2:return _context10.abrupt('return',0);case 3:case'end':return _context10.stop();}}},null,_this);};var yesBackend=new Intent('yesBackend');yesBackend.onMatching=function(botState){var previousIntent=botState.getField(PREVIOUS_INTENT);return!previousIntent&&botState.getNlpResultsForId(NLPId).action==='yes';};yesBackend.onResolution=function _callee11(botState){return regeneratorRuntime.async(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:botState.addStringResponse('Say yes to you!');case 1:case'end':return _context11.stop();}}},null,_this);};var deActivatePushNotifications=new Intent('deActivatePushNotifications');deActivatePushNotifications.suggestionsArray=[{lang:'en',list:[DEACTIVE_PUSH_NOTIFICATIONS]}];deActivatePushNotifications.onMatching=function(botState){return(botState.messageTypeFromUser==='string'&&botState.messageFromUser===DEACTIVE_PUSH_NOTIFICATIONS||botState.getNlpResultsForId(NLPId).action==='DeactivateNotifications'||botState.messageTypeFromUser==='object'&&botState.messageFromUser.intentId===DEREGISTER_PUSH_ON_EDGE)&&botState.client===State.MOBILECLIENT();};deActivatePushNotifications.onError=function(botState){showErrorsToUser(botState);};deActivatePushNotifications.onResolution=function _callee12(botState){var callNextIntent;return regeneratorRuntime.async(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:callNextIntent=function callNextIntent(notificationDeviceInfo){var forLogOut=false;if(botState.messageTypeFromUser==='object'){forLogOut=true;}if(notificationDeviceInfo){botState.processIntentWithIdAndMessage(DEREGISTER_PUSH_ON_BACKEND,{notificationDeviceInfo:notificationDeviceInfo,forLogOut:forLogOut});}else{if(forLogOut){botState.processIntentWithId(LOGOUT);}}};return _context12.abrupt('return',botState.notification.isDeviceRegisteredForPush().then(function(isRegistered){if(isRegistered){return botState.notification.deregisterDeviceForPushOnEdge().then(function(notificationDeviceInfo){callNextIntent(notificationDeviceInfo);});}else{callNextIntent();}}));case 2:case'end':return _context12.stop();}}},null,_this);};deActivatePushNotifications.onPrediction=function _callee13(){var notificationsActive;return regeneratorRuntime.async(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:notificationsActive=true;if(!(botState.client===State.MOBILECLIENT()&&botState.location===Intent.EDGE())){_context13.next=5;break;}_context13.next=4;return regeneratorRuntime.awrap(botState.notification.isDeviceRegisteredForPush());case 4:notificationsActive=_context13.sent;case 5:if(!([myAccount.intentId].indexOf(botState.activeIntent)>-1&&notificationsActive)){_context13.next=7;break;}return _context13.abrupt('return',1);case 7:return _context13.abrupt('return',0);case 8:case'end':return _context13.stop();}}},null,_this);};var deregisterPushOnBackend=new Intent(DEREGISTER_PUSH_ON_BACKEND);deregisterPushOnBackend.runOnCloud();deregisterPushOnBackend.onMatching=function(botState){return botState.messageTypeFromUser==='object'&&botState.messageFromUser.intentId===DEREGISTER_PUSH_ON_BACKEND;};deregisterPushOnBackend.onError=function(botState){showErrorsToUser(botState);};deregisterPushOnBackend.onResolution=function _callee14(botState){return regeneratorRuntime.async(function _callee14$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:return _context14.abrupt('return',botState.notification.deregisterDeviceForPushOnBackend(botState.messageFromUser.notificationDeviceInfo).then(function(){if(botState.messageFromUser.forLogOut){botState.processIntentWithId(LOGOUT);}else{botState.addStringResponse('Notifications are now deactivated');}botState.clearField(NOTIFICATION_CHANGES_IN_PROGRESS);}));case 1:case'end':return _context14.stop();}}},null,_this);};var noLogout=new Intent('noLogout');noLogout.onMatching=function(botState){var previousIntent=botState.getField(PREVIOUS_INTENT);return(botState.messageFromUser===NO||botState.getNlpResultsForId(NLPId).action==='no')&&previousIntent===LOGOUT_INTENT;};noLogout.onResolution=function _callee15(botState){return regeneratorRuntime.async(function _callee15$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:botState.addStringResponse('Ok');botState.clearField(PREVIOUS_INTENT);case 2:case'end':return _context15.stop();}}},null,_this);};var no=new Intent('no');no.suggestionsArray=[{lang:'en',list:[NO]}];no.onPrediction=function _callee16(){return regeneratorRuntime.async(function _callee16$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:if(!(botState.getField(NOTIFICATION_CHANGES_IN_PROGRESS)===null&&[logout.intentId].indexOf(botState.activeIntent)>-1)){_context16.next=2;break;}return _context16.abrupt('return',1);case 2:return _context16.abrupt('return',0);case 3:case'end':return _context16.stop();}}},null,_this);};var noBackend=new Intent('noBackend');noBackend.onMatching=function(botState){return botState.messageFromUser==='TEST';};noBackend.onResolution=function _callee17(botState){return regeneratorRuntime.async(function _callee17$(_context17){while(1){switch(_context17.prev=_context17.next){case 0:botState.addStringResponse('Testing testing');case 1:case'end':return _context17.stop();}}},null,_this);};var sendWelcomeMessages=function sendWelcomeMessages(botState){botState.addStringResponse(WELCOME_MESSAGE);if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('To start using the app, touch the back button to go to the home screen. Explore Contacts, Groups and Apps to start collaborating!');}else{if(botState.currentWorkspace==='gns'){botState.addStringResponse('To start using the app, simply add credit to make calls to satellite numbers – use the dialpad or add contacts on the left menu');}else{botState.addStringResponse('To start using the app, simply add credit to make calls to satellite numbers, use the dialpad or add contacts on the left menu. Join Groups for group messages, and browse our Apps for other add ons');}}};var amIinGNS=function amIinGNS(){return botState.client===State.WEBCLIENT()&&botState.currentWorkspace==='gns';};var allQuestions=new Intent(ALL_QUESTIONS);allQuestions.setEnglishSmartSuggestionsWithCondition([HOW_TO_USE_FRONTM,HOW_DO_I_MAKE_CALLS,HOW_DO_I_ADD_CALL_CREDIT,HOW_DO_I_ADD_CONTACTS,WHAT_ARE_CHANNELS,INVITE_PEOPLE_TO_FRONTM,smartSuggestionsConstants.CHECKCALLRATES,smartSuggestionsConstants.EMAILHISTORY,smartSuggestionsConstants.WHYUSEFRONTMCALLS],[HOW_TO_USE_FRONTM,HOW_DO_I_MAKE_CALLS,HOW_DO_I_ADD_CALL_CREDIT,HOW_DO_I_ADD_CONTACTS,INVITE_PEOPLE_TO_FRONTM,smartSuggestionsConstants.CHECKCALLRATES,smartSuggestionsConstants.EMAILHISTORY,smartSuggestionsConstants.WHYUSEFRONTMCALLS],amIinGNS);allQuestions.onPrediction=function _callee18(){return regeneratorRuntime.async(function _callee18$(_context18){while(1){switch(_context18.prev=_context18.next){case 0:if(!(suggestionsArrayForPredictions().indexOf(botState.activeIntent)>-1)){_context18.next=2;break;}return _context18.abrupt('return',1);case 2:return _context18.abrupt('return',0);case 3:case'end':return _context18.stop();}}},null,_this);};var selectPollingStrategy=new Intent('selectPollingStrategy');selectPollingStrategy.suggestionsArray=[{lang:'en',list:[SELECT_POLLING_STRATEGY]}];selectPollingStrategy.onMatching=function(botState){return botState.messageFromUser===SELECT_POLLING_STRATEGY||botState.getNlpResultsForId(NLPId).action==='Polling Strategy';};selectPollingStrategy.onResolution=function _callee19(botState){return regeneratorRuntime.async(function _callee19$(_context19){while(1){switch(_context19.prev=_context19.next){case 0:botState.addStringResponse('Uniquely, '+appName+' helps you control how you use your available internet. This is particularly useful when you\'re on in-flight WiFi or on a Ship.');botState.addStringResponse('Select a setting from below suggestions');case 2:case'end':return _context19.stop();}}},null,_this);};selectPollingStrategy.onPrediction=function _callee20(){var lastLogin;return regeneratorRuntime.async(function _callee20$(_context20){while(1){switch(_context20.prev=_context20.next){case 0:lastLogin=botState.getField(LAST_LOGIN);if(!(suggestionsArrayForPredictions().indexOf(botState.activeIntent)>-1&&lastLogin)){_context20.next=3;break;}return _context20.abrupt('return',1);case 3:return _context20.abrupt('return',0);case 4:case'end':return _context20.stop();}}},null,_this);};var automaticPollingStrategy=new Intent('automaticPollingStrategy');automaticPollingStrategy.suggestionsArray=[{lang:'en',list:[AUTOMATIC_POLLING_STRATEGY]}];automaticPollingStrategy.onMatching=function(botState){return(botState.messageFromUser===AUTOMATIC_POLLING_STRATEGY||botState.getNlpResultsForId(NLPId).action==='AutomaticNetworkMode')&&botState.client===State.MOBILECLIENT();};automaticPollingStrategy.onResolution=function _callee21(botState){return regeneratorRuntime.async(function _callee21$(_context21){while(1){switch(_context21.prev=_context21.next){case 0:return _context21.abrupt('return',botState.setNetworkModeTo('automatic').then(function(){botState.addStringResponse('I will be detecting automatically the type of network you are using');}));case 1:case'end':return _context21.stop();}}},null,_this);};automaticPollingStrategy.onPrediction=function _callee22(){return regeneratorRuntime.async(function _callee22$(_context22){while(1){switch(_context22.prev=_context22.next){case 0:if(!([selectPollingStrategy.intentId].indexOf(botState.activeIntent)>-1)){_context22.next=2;break;}return _context22.abrupt('return',1);case 2:return _context22.abrupt('return',0);case 3:case'end':return _context22.stop();}}},null,_this);};var terrestrialPollingStrategy=new Intent('terrestrialPollingStrategy');terrestrialPollingStrategy.suggestionsArray=[{lang:'en',list:[TERRESTRIAL_POLLING_STRATEGY]}];terrestrialPollingStrategy.onMatching=function(botState){return(botState.messageFromUser===TERRESTRIAL_POLLING_STRATEGY||botState.getNlpResultsForId(NLPId).action==='TerrestrialMode')&&botState.client===State.MOBILECLIENT();};terrestrialPollingStrategy.onResolution=function _callee23(botState){return regeneratorRuntime.async(function _callee23$(_context23){while(1){switch(_context23.prev=_context23.next){case 0:return _context23.abrupt('return',botState.setNetworkModeTo('gsm').then(function(){botState.addStringResponse('I will be assuming you are in a terrestrial network all the time. If you are connected over a satellite the screen will turn pink to let you know');}));case 1:case'end':return _context23.stop();}}},null,_this);};terrestrialPollingStrategy.onPrediction=function _callee24(){return regeneratorRuntime.async(function _callee24$(_context24){while(1){switch(_context24.prev=_context24.next){case 0:if(!([selectPollingStrategy.intentId].indexOf(botState.activeIntent)>-1)){_context24.next=2;break;}return _context24.abrupt('return',1);case 2:return _context24.abrupt('return',0);case 3:case'end':return _context24.stop();}}},null,_this);};var satellitePollingStrategy=new Intent('satellitePollingStrategy');satellitePollingStrategy.suggestionsArray=[{lang:'en',list:[SATELLITE_POLLING_STRATEGY]}];satellitePollingStrategy.onMatching=function(botState){return(botState.messageFromUser===SATELLITE_POLLING_STRATEGY||botState.getNlpResultsForId(NLPId).action==='SatelliteMode')&&botState.client===State.MOBILECLIENT();};satellitePollingStrategy.onResolution=function _callee25(botState){return regeneratorRuntime.async(function _callee25$(_context25){while(1){switch(_context25.prev=_context25.next){case 0:return _context25.abrupt('return',botState.setNetworkModeTo('satellite').then(function(){botState.addStringResponse('I will be assuming you are connected over a satellite all the time saving data as much as possible');}));case 1:case'end':return _context25.stop();}}},null,_this);};satellitePollingStrategy.onPrediction=function _callee26(){return regeneratorRuntime.async(function _callee26$(_context26){while(1){switch(_context26.prev=_context26.next){case 0:if(!([selectPollingStrategy.intentId].indexOf(botState.activeIntent)>-1)){_context26.next=2;break;}return _context26.abrupt('return',1);case 2:return _context26.abrupt('return',0);case 3:case'end':return _context26.stop();}}},null,_this);};var manualPollingStrategy=new Intent('manualPollingStrategy');manualPollingStrategy.suggestionsArray=[{lang:'en',list:[MANUAL_POLLING_STRATEGY]}];manualPollingStrategy.onMatching=function(botState){return(botState.messageFromUser===MANUAL_POLLING_STRATEGY||botState.getNlpResultsForId(NLPId).action==='ManualNetworkMode')&&botState.client===State.MOBILECLIENT();};manualPollingStrategy.onResolution=function _callee27(botState){return regeneratorRuntime.async(function _callee27$(_context27){while(1){switch(_context27.prev=_context27.next){case 0:return _context27.abrupt('return',botState.setNetworkModeTo('manual').then(function(){botState.addStringResponse('You are in Manual Network Mode. You are consuming 0KB background data currently. You will need to touch the refresh button to fetch messages.');}));case 1:case'end':return _context27.stop();}}},null,_this);};manualPollingStrategy.onPrediction=function _callee28(){return regeneratorRuntime.async(function _callee28$(_context28){while(1){switch(_context28.prev=_context28.next){case 0:if(!([selectPollingStrategy.intentId].indexOf(botState.activeIntent)>-1)){_context28.next=2;break;}return _context28.abrupt('return',1);case 2:return _context28.abrupt('return',0);case 3:case'end':return _context28.stop();}}},null,_this);};var cancelPollingStrategySelection=new Intent('cancelPollingStrategySelection');cancelPollingStrategySelection.suggestionsArray=[{lang:'en',list:[CANCEL_POLLING_STRATEGY]}];cancelPollingStrategySelection.onMatching=function(botState){return botState.messageFromUser===CANCEL_POLLING_STRATEGY;};cancelPollingStrategySelection.onResolution=function _callee29(botState){return regeneratorRuntime.async(function _callee29$(_context29){while(1){switch(_context29.prev=_context29.next){case 0:botState.addStringResponse('Ok');case 1:case'end':return _context29.stop();}}},null,_this);};cancelPollingStrategySelection.onPrediction=function _callee30(){return regeneratorRuntime.async(function _callee30$(_context30){while(1){switch(_context30.prev=_context30.next){case 0:if(!([selectPollingStrategy.intentId].indexOf(botState.activeIntent)>-1)){_context30.next=2;break;}return _context30.abrupt('return',1);case 2:return _context30.abrupt('return',0);case 3:case'end':return _context30.stop();}}},null,_this);};var myAccount=new Intent('myAccount');myAccount.suggestionsArray=[{lang:'en',list:[MY_ACCOUNT]}];myAccount.onMatching=function(botState){return botState.messageFromUser===MY_ACCOUNT||botState.getNlpResultsForId(NLPId).action==='MyAccount';};myAccount.onResolution=function _callee31(botState){return regeneratorRuntime.async(function _callee31$(_context31){while(1){switch(_context31.prev=_context31.next){case 0:botState.addStringResponse('Select from the suggestions below');case 1:case'end':return _context31.stop();}}},null,_this);};myAccount.onPrediction=function _callee32(){var lastLogin;return regeneratorRuntime.async(function _callee32$(_context32){while(1){switch(_context32.prev=_context32.next){case 0:lastLogin=botState.getField(LAST_LOGIN);if(!(suggestionsArrayForPredictions().indexOf(botState.activeIntent)>-1&&lastLogin)){_context32.next=3;break;}return _context32.abrupt('return',1);case 3:return _context32.abrupt('return',0);case 4:case'end':return _context32.stop();}}},null,_this);};var cancelMyAccount=new Intent('cancelMyAccount');cancelMyAccount.suggestionsArray=[{lang:'en',list:[CANCEL_MY_ACCOUNT]}];cancelMyAccount.onMatching=function(botState){return botState.messageFromUser===CANCEL_MY_ACCOUNT;};cancelMyAccount.onResolution=function _callee33(botState){return regeneratorRuntime.async(function _callee33$(_context33){while(1){switch(_context33.prev=_context33.next){case 0:botState.addStringResponse('Ok');case 1:case'end':return _context33.stop();}}},null,_this);};cancelMyAccount.onPrediction=function _callee34(){return regeneratorRuntime.async(function _callee34$(_context34){while(1){switch(_context34.prev=_context34.next){case 0:if(!([myAccount.intentId,changePassword.intentId].indexOf(botState.activeIntent)>-1&&botState.client===State.MOBILECLIENT())){_context34.next=2;break;}return _context34.abrupt('return',1);case 2:return _context34.abrupt('return',0);case 3:case'end':return _context34.stop();}}},null,_this);};var changePassword=new Intent('changePassword');changePassword.suggestionsArray=[{lang:'en',list:[CHANGE_PASSWORD]}];changePassword.onMatching=function(botState){return botState.messageFromUser===CHANGE_PASSWORD||botState.getNlpResultsForId(NLPId).action==='ChangePassword';};changePassword.onResolution=function _callee35(botState){var provider;return regeneratorRuntime.async(function _callee35$(_context35){while(1){switch(_context35.prev=_context35.next){case 0:provider='';if(botState.client===State.MOBILECLIENT()){provider=_.trim(botState.user.provider.name);}if(provider!=='google'&&provider!=='facebook'){if(botState.client===State.MOBILECLIENT()){botState.addFormResponse(chgPasswordForm.message());}else{botState.addStringResponse('You can change your password from your profile screen that can be reached at the top right of the page');}}else{botState.addStringResponse('You have used '+provider+' to register in '+appName+', if you wish to change your password you need to do it there');}case 3:case'end':return _context35.stop();}}},null,_this);};changePassword.onPrediction=function _callee36(){var provider;return regeneratorRuntime.async(function _callee36$(_context36){while(1){switch(_context36.prev=_context36.next){case 0:provider='';if(botState.client===State.MOBILECLIENT()){provider=_.trim(botState.user.provider.name);}if(!(provider!=='google'&&[myAccount.intentId].indexOf(botState.activeIntent)>-1)){_context36.next=4;break;}return _context36.abrupt('return',1);case 4:return _context36.abrupt('return',0);case 5:case'end':return _context36.stop();}}},null,_this);};var logout=new Intent(LOGOUT);logout.suggestionsArray=[{lang:'en',list:[LOGOUT]}];logout.onMatching=function(botState){return botState.messageTypeFromUser==='string'&&botState.messageFromUser===LOGOUT||botState.messageTypeFromUser==='object'&&botState.messageFromUser.intentId===LOGOUT||botState.getNlpResultsForId(NLPId).action==='logout';};logout.onResolution=function _callee37(botState){return regeneratorRuntime.async(function _callee37$(_context37){while(1){switch(_context37.prev=_context37.next){case 0:if(!(botState.messageTypeFromUser==='string'||botState.getNlpResultsForId(NLPId).action==='logout')){_context37.next=4;break;}if(botState.getField(NOTIFICATION_CHANGES_IN_PROGRESS)===null){botState.setField(PREVIOUS_INTENT,LOGOUT_INTENT);botState.addStringResponse('Are you sure you would like to logout?');}else{botState.addStringResponse('Your notification settings are still being updated. Please try me again in just a moment.');}_context37.next=5;break;case 4:return _context37.abrupt('return',botState.logout());case 5:case'end':return _context37.stop();}}},null,_this);};logout.onPrediction=function _callee38(){return regeneratorRuntime.async(function _callee38$(_context38){while(1){switch(_context38.prev=_context38.next){case 0:if(!([myAccount.intentId].indexOf(botState.activeIntent)>-1)){_context38.next=2;break;}return _context38.abrupt('return',1);case 2:return _context38.abrupt('return',0);case 3:case'end':return _context38.stop();}}},null,_this);};var support=new Intent('support');support.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='support';};support.onResolution=function _callee39(botState){return regeneratorRuntime.async(function _callee39$(_context39){while(1){switch(_context39.prev=_context39.next){case 0:botState.addFormResponse(complaintForm.message());case 1:case'end':return _context39.stop();}}},null,_this);};var inviteQuestion=new Intent('inviteQuestion');inviteQuestion.runOnCloud();inviteQuestion.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='inviteQuestion';};inviteQuestion.onResolution=function _callee40(botState){return regeneratorRuntime.async(function _callee40$(_context40){while(1){switch(_context40.prev=_context40.next){case 0:if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('Go back to your timeline, then touch the Contacts tab at the bottom of the screen, then touch the + button at the top right and follow the instructions on screen');}else{botState.addStringResponse('Click "Add Contact" under Contacts on the left menu. Then choose "Send an email invitation to a friend"');}case 1:case'end':return _context40.stop();}}},null,_this);};var InvitationCode=new Intent('InvitationCode');InvitationCode.runOnCloud();InvitationCode.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='InvitationCode';};InvitationCode.onResolution=function _callee41(botState){return regeneratorRuntime.async(function _callee41$(_context41){while(1){switch(_context41.prev=_context41.next){case 0:if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('To activate a new service provider, please touch on the Apps catalogue tab at the bottom of the home screen then touch Providers section at the top and you will find the button to activate a new provider');}else{botState.addStringResponse('Open the drop down at the top left of this page and then click on +');}case 1:case'end':return _context41.stop();}}},null,_this);};var callingRates=new Intent('checkCallingRates');callingRates.onMatching=function(botState){return botState.messageFromUser===smartSuggestionsConstants.CHECKCALLRATES||botState.messageFromUser===smartSuggestionsConstants.CHECKCALLINGRATESOTHER||botState.getNlpResultsForId(NLPId).action==='checkCallingRates';};callingRates.onResolution=function _callee42(botState){return regeneratorRuntime.async(function _callee42$(_context42){while(1){switch(_context42.prev=_context42.next){case 0:botState.addStringResponse('Sure, let me know which destination you want the call rates for?');case 1:case'end':return _context42.stop();}}},null,_this);};var tariffCheck=new Intent('1_tariffCheck');tariffCheck.runOnCloud();tariffCheck.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='1_tariffCheck';};tariffCheck.onResolution=function _callee43(botState){var _,isoCountry;return regeneratorRuntime.async(function _callee43$(_context43){while(1){switch(_context43.prev=_context43.next){case 0:_=botState._;isoCountry=_.get(botState.getNlpResultsForId(NLPId),'nlpParameters.geo-country-code.alpha-2');if(!isoCountry){botState.addStringResponse('Sorry, could you confirm the destination country name?');}return _context43.abrupt('return',botState.accounts.getCallRates(isoCountry).then(function(tariffsArray){_.each(tariffsArray,function(tariff){botState.addStringResponse('Calling rates to '+tariff.planName+' is $'+tariff.currentPrice+' per minute');});}));case 4:case'end':return _context43.stop();}}},null,_this);};var tariffCheckSat=new Intent('1_tariffCheckSat');tariffCheckSat.suggestionsArray=[{lang:'en',list:['India','Argentina','France',INMARSAT,IRIDIUM]}];tariffCheckSat.runOnCloud();tariffCheckSat.onMatching=function(){return botState.messageFromUser===INMARSAT||botState.messageFromUser===IRIDIUM||botState.getNlpResultsForId(NLPId).action==='qs_IridiumCallingcosts'||botState.getNlpResultsForId(NLPId).action==='qs_InmarsatCallingCosts';};tariffCheckSat.onResolution=function _callee44(botState){return regeneratorRuntime.async(function _callee44$(_context44){while(1){switch(_context44.prev=_context44.next){case 0:return _context44.abrupt('return',botState.accounts.getCallRates(SAT_PHONE).then(function(tariffsArray){_.each(tariffsArray,function(tariff){var platform='Inmarsat';if(botState.getNlpResultsForId(NLPId).action==='qs_IridiumCallingcosts'){platform='Iridium';}botState.addStringResponse('Calling rate to '+platform+' is $'+tariff.currentPrice+' per minute');});}));case 1:case'end':return _context44.stop();}}},null,_this);};tariffCheckSat.onPrediction=function _callee45(){return regeneratorRuntime.async(function _callee45$(_context45){while(1){switch(_context45.prev=_context45.next){case 0:if(!([callingRates.intentId].indexOf(botState.activeIntent)>-1)){_context45.next=2;break;}return _context45.abrupt('return',1);case 2:return _context45.abrupt('return',0);case 3:case'end':return _context45.stop();}}},null,_this);};var callSatFailed=new Intent('callSatFailed');callSatFailed.runOnCloud();callSatFailed.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='8_CheckCallFailure'&&botState.messageFromUser!==INMARSAT&&botState.messageFromUser!==IRIDIUM;};callSatFailed.onResolution=function _callee46(botState){return regeneratorRuntime.async(function _callee46$(_context46){while(1){switch(_context46.prev=_context46.next){case 0:return _context46.abrupt('return',botState.accounts.getBalance('pstn-balance').then(function(responseBalance){var balance=_.get(responseBalance,'pstn-balance.available',0);if(balance<=0){botState.addStringResponse('Sorry, but you do not have sufficient balance to call Satellite Numbers. Please top up and try again');}else{botState.sendMessage({intentId:'emailSupport',title:'Support Request with Satphone numbers',description:botState.messageFromUser,priority:1});botState.addResponse('silent',{});}}));case 1:case'end':return _context46.stop();}}},null,_this);};var formattedHistory=function formattedHistory(botState,callHistoryArray){var callEntriesArray=[];botState._.each(callHistoryArray,function(callEntry){var newCallForCard={title:'Call data',To:callEntry.callTo,Duration:callEntry.duration+' minutes',Charge:'$'+Math.round(_.get(callEntry,'callCharge',0)*100)/100,Time:new Date(callEntry.callTimestamp).toLocaleString(),Balance:'$'+Math.round(_.get(callEntry,'currentBalance',0)*100)/100};callEntriesArray.push(newCallForCard);});return callEntriesArray;};var emailUsageHistory=new Intent('6_emailUsageHistory');emailUsageHistory.runOnCloud();emailUsageHistory.onMatching=function(botState){return botState.messageFromUser===smartSuggestionsConstants.EMAILHISTORY||botState.getNlpResultsForId(NLPId).action==='6_emailUsageHistory';};emailUsageHistory.onResolution=function _callee47(botState){return regeneratorRuntime.async(function _callee47$(_context47){while(1){switch(_context47.prev=_context47.next){case 0:return _context47.abrupt('return',botState.accounts.getCallHistory().then(function(callHistoryArray){if(botState._.size(callHistoryArray)>0){var body='Hi '+botState.userName+('!\n\nAttached you can find the call history with the phone numbers you called using '+appName+'.\n\n'+appName+' Team');var attachment={name:appName+'CallHistory.txt',content:formattedHistory(botState,callHistoryArray)};return botState.notification.sendEmail(botState.user.userEmail,appName+' Call History',body,attachment).then(function(response){botState.addStringResponse('I have sent you the email');});}else{botState.addStringResponse('Sorry but you have not made any calls so far ');}}));case 1:case'end':return _context47.stop();}}},null,_this);};var howToUseFrontM=new Intent('howToUseFrontM');howToUseFrontM.runOnCloud();howToUseFrontM.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howToUseFrontM';};howToUseFrontM.onResolution=function _callee48(){return regeneratorRuntime.async(function _callee48$(_context48){while(1){switch(_context48.prev=_context48.next){case 0:botState.addStringResponse('You can use '+appName+' to make low cost calls to satellite phones and other numbers. Top up credit to use the dialpad or call numbers you have saved as Contacts. You can also connect with other app users to make free app-to-app calls over the internet.');if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('You can also send instant messages to contacts who have accepted your request, join or create groups for group chat, and install other helper applications. You can also use '+appName+' online at app.frontm.com');}else{if(botState.currentWorkspace==='gns'){botState.addStringResponse('You can also download our mobile app from the Apple or Google Play app stores');}else{botState.addStringResponse('You can also sent instant messages to contacts who have accepted your request, join or create groups for group chat, and install other apps');botState.addStringResponse('You can also download our mobile app from the Apple of Google Play app stores');}}case 2:case'end':return _context48.stop();}}},null,_this);};var howToMakeCalls=new Intent('howToMakeCalls');howToMakeCalls.runOnCloud();howToMakeCalls.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howToMakeCalls';};howToMakeCalls.onResolution=function _callee49(){return regeneratorRuntime.async(function _callee49$(_context49){while(1){switch(_context49.prev=_context49.next){case 0:if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('You can enter numbers using the dialpad, or call saved contacts. First, click back, and then click on the phone button');botState.addStringResponse("To dial directly, select the dialpad. You'll need to dial the full international number including the code for the country or Iridium/Inmarsat (e.g. +870)");botState.addStringResponse('To call a contact from your list, click their name and click the phone button next to the number to call');botState.addStringResponse('If you do not have any call credit, you will need to top up by selecting Top Up first');}else{botState.addStringResponse('You can enter numbers using the dialpad, or call saved contacts. If you do not have any call credit, you will need to top up by selecting Top Up first');botState.addStringResponse("To dial directly, click on the dialpad above. You'll need to dial the full international number including the code for the country or Iridium/Inmarsat (e.g. +870)");botState.addStringResponse('To call a contact, click their name on the contacts button, and click the phone button next to their name or number');}case 1:case'end':return _context49.stop();}}},null,_this);};var howDoIAddCallCredits=new Intent('howDoIAddCallCredits');howDoIAddCallCredits.runOnCloud();howDoIAddCallCredits.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howDoIAddCallCredits';};howDoIAddCallCredits.onResolution=function _callee50(){return regeneratorRuntime.async(function _callee50$(_context50){while(1){switch(_context50.prev=_context50.next){case 0:if(botState.client===State.MOBILECLIENT()){botState.addStringResponse('You will be prompted to top up when you try to make a call. You can then top up using in-app payments. You can also make card payments using our app.frontm.com web app');}else{botState.addStringResponse('Click "Top Up" above and choose an amount to top up. You will then be able to add payment details to make a card payment');}case 1:case'end':return _context50.stop();}}},null,_this);};var howDoIAddContacts=new Intent('howDoIAddContacts');howDoIAddCallCredits.runOnCloud();howDoIAddContacts.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howDoIAddContacts';};howDoIAddContacts.onResolution=function _callee51(){return regeneratorRuntime.async(function _callee51$(_context51){while(1){switch(_context51.prev=_context51.next){case 0:if(botState.client===State.WEBCLIENT()){if(botState.currentWorkspace==='gns'){botState.addStringResponse('Click "Add Contact" under "Contacts" on the left menu. From here, you can create a new contact using their phone number, invite your friends by email or search existing app users to request a direct connection. Install the '+appName+' mobile app to import your existing mobile contacts');}else{botState.addStringResponse('Click "Add Contact" under "Contacts" on the left menu. From here, you can create a new contact using their phone number, invite your friends by email or search existing app users and request a direct connection to make app-to-app calls or send instant messages. Install the '+appName+' mobile app to import your existing mobile contacts');}}else{botState.addStringResponse('Go back, and tap "Contacts" at the bottom. From here, you can import your phone book contacts, create a new contact using their phone number, invite your friends by email or search existing app users and request a direct connection to make app-to-app calls or send instant messages');}case 1:case'end':return _context51.stop();}}},null,_this);};var whatIsFrontM=new Intent('whatIsFrontM');whatIsFrontM.runOnCloud();whatIsFrontM.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='whatIsFrontM';};whatIsFrontM.onResolution=function _callee52(){return regeneratorRuntime.async(function _callee52$(_context52){while(1){switch(_context52.prev=_context52.next){case 0:if(botState.client===State.WEBCLIENT()&&botState.currentWorkspace==='gns'){botState.addStringResponse(appName+' app is for communication, collaboration and easy access to information in remote spaces, and low cost calls to satellite phones. Use this app for calling satellite phone numbers and for messaging, voice calling and other interactions from sea, mid air or in remote places');}else{botState.addStringResponse(appName+' app is for low cost calls to satellite phones. Use this app for calling from shore and HQ to ships bridges or other satellite phones');}case 1:case'end':return _context52.stop();}}},null,_this);};var howToAccessApps=new Intent('howToAccessApps');howToAccessApps.runOnCloud();howToAccessApps.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howToAccessApps';};howToAccessApps.onResolution=function _callee53(){return regeneratorRuntime.async(function _callee53$(_context53){while(1){switch(_context53.prev=_context53.next){case 0:if(botState.client===State.WEBCLIENT()){if(botState.currentWorkspace==='gns'){botState.addStringResponse('You are already using '+appName+' assistant! Ask me anything and I will try to help. There are currently no other apps available to use on this workspace');}else{botState.addStringResponse('The '+appName+' applications are accessed by clicking Apps on the left navigation menu');}}else{botState.addStringResponse('Go back and touch on Apps on the bottom menu');}case 1:case'end':return _context53.stop();}}},null,_this);};var cannotFindApp=new Intent('cannotFindApp');cannotFindApp.runOnCloud();cannotFindApp.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='cannotFindApp';};cannotFindApp.onResolution=function _callee54(){return regeneratorRuntime.async(function _callee54$(_context54){while(1){switch(_context54.prev=_context54.next){case 0:if(botState.client===State.WEBCLIENT()&&botState.currentWorkspace==='gns'){botState.addStringResponse('Only the '+appName+' Assistant is available on this workspace');}else{botState.addStringResponse('Sorry, you can\'t find what you are looking for. If you have been invited by a partner, you may need to enter an Access Code. Otherwise, please raise a Customer Feature Request with '+appName+' below');}case 1:case'end':return _context54.stop();}}},null,_this);};var howToChat=new Intent('howToChat');howToChat.runOnCloud();howToChat.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='howToChat';};howToChat.onResolution=function _callee55(){return regeneratorRuntime.async(function _callee55$(_context55){while(1){switch(_context55.prev=_context55.next){case 0:if(botState.client===State.WEBCLIENT()&&botState.currentWorkspace==='gns'){botState.addStringResponse('Chats are disabled in this workspace');}else{botState.addStringResponse('If the contact is a '+appName+' user and they have authorised your connection request, you will be able to chat with them by clicking on them in your Contacts list, and then clicking the chat icon next to their name. You can also start or join groups for group chat.');}case 1:case'end':return _context55.stop();}}},null,_this);};var dunno=new Intent('dunno');dunno.runOnCloud();dunno.onMatching=function(){return botState.getNlpResultsForId(NLPId).action==='dunno';};dunno.onResolution=function _callee56(){return regeneratorRuntime.async(function _callee56$(_context56){while(1){switch(_context56.prev=_context56.next){case 0:botState.addStringResponse("I am sorry to hear that. I am here to help you as far as I can, with your enquiries. If I can't, you always have the option of requesting help from our Support team.");if(botState.client===State.WEBCLIENT()&&botState.currentWorkspace==='gns'){botState.addEnglishSmartSuggestions(['Raise a Support Request','What is this app for','How to make phone calls']);}else{botState.addEnglishSmartSuggestions(['Raise a Support Request','What is this app for','How to make phone calls','How to chat']);}case 2:case'end':return _context56.stop();}}},null,_this);};if(botState.client===State.MOBILECLIENT()){return[main,inviteQuestion,InvitationCode,callingRates,tariffCheck,tariffCheckSat,callSatFailed,yes,yesPush,yesLogout,no,noLogout,noBackend,selectPollingStrategy,automaticPollingStrategy,terrestrialPollingStrategy,satellitePollingStrategy,manualPollingStrategy,cancelPollingStrategySelection,deActivatePushNotifications,deregisterPushOnBackend,myAccount,cancelMyAccount,changePassword,logout,support,allQuestions,emailUsageHistory,howToMakeCalls,howToUseFrontM,howDoIAddCallCredits,howDoIAddContacts,whatIsFrontM,howToAccessApps,cannotFindApp,howToChat,dunno,chgPasswordForm,oldPassword,newPassword1,newPassword2,complaintForm,title,description];}else{return[main,inviteQuestion,InvitationCode,callSatFailed,callingRates,tariffCheck,tariffCheckSat,yesBackend,changePassword,noBackend,cancelMyAccount,support,allQuestions,emailUsageHistory,howToMakeCalls,howToUseFrontM,howDoIAddCallCredits,howDoIAddContacts,whatIsFrontM,howToAccessApps,cannotFindApp,howToChat,dunno,chgPasswordForm,oldPassword,newPassword1,newPassword2,complaintForm,title,description];}};var NLP=function(){_createClass(NLP,null,[{key:'DIALOGFLOW',value:function DIALOGFLOW(){return'dialogflow';}},{key:'LEX',value:function LEX(){return'lex';}}]);function NLP(botState){_classCallCheck(this,NLP);this['_botState']=botState;this._nlpEngine=NLP.DIALOGFLOW();this._nlpIds=[];this._nlpAlias='';}_createClass(NLP,[{key:'addNlp',value:function addNlp(nlpId){var _=this._botState._;var index=_.findIndex(this.nlpIds,function(existingId){return existingId===nlpId;});if(index===-1){this._nlpIds.push(nlpId);}}},{key:'getNlpParameters',value:function getNlpParameters(nlpParameters){var _this2=this;return nlpParameters;var parsedParameters={};var fields=nlpParameters.fields;var _=this._botState._;var processFields=function processFields(field){switch(fields[field].kind){case'stringValue':{parsedParameters[field]=fields[field].stringValue;break;}case'numberValue':{parsedParameters[field]=fields[field].numberValue;break;}case'structValue':{parsedParameters[field]=_this2.getNlpParameters(fields[field].structValue);break;}case'listValue':{var listFromNLP=_.get(fields[field],'listValue.values');var listToBot=[];_.each(listFromNLP,function(value){if(_.get(value,'structValue')){listToBot.push(_this2.getNlpParameters(_.get(value,'structValue')));}else{listToBot.push(_.get(value,'stringValue')||_.get(value,'numberValue')||'unknownType');}});parsedParameters[field]=listToBot;break;}default:break;}};this._botState.R.forEach(processFields,this._botState.R.keys(fields));return parsedParameters;}},{key:'runNlpForMessage',value:function runNlpForMessage(message){var _this3=this;var state=this._botState;var D=state.developer;var _=state._;var R=state.R;console.log('Inside runNLP');var nlpBotsList=this.nlpIds;D.info({message:'Starting NLP event',data:nlpBotsList});if(this.nlpEngine===NLP.DIALOGFLOW()){if(nlpBotsList.length>0){var params={capability:'NLP2',capabilityFileName:'nlpv2',queryString:message,nlpIds:nlpBotsList,sync:true,userId:state.user.userId,conversation:state.conversation};console.log('Calling NLP saying '+message);return state.callCapability(params).then(function(dataArray){var startNLP=Date.now();_.each(dataArray,function(nlpResponse){D.info({message:'Response from NLP',data:nlpResponse});if(nlpResponse.error==='Invalid NLP ID'){state.addSystemErrorToStack(24,nlpResponse.nlpId);return;}var nlpParameters='';var action=nlpResponse.action;var nlpId=nlpResponse.nlpId;D.info({message:'Found NLP action: ',data:action});if(nlpResponse.parameters&&_.size(nlpResponse.parameters)>0){nlpParameters=nlpResponse.parameters;D.info({message:'Found NLP parameters: ',data:nlpParameters});}var suggestions=[];if(nlpResponse.messages){_.forEach(nlpResponse.messages,function(entry){if(entry.type===4){if(entry.payload.messages){state.addSmartSuggestionsArray([{lang:state.lang,list:entry.payload.messages}]);suggestions=entry.payload.messages;}}});}state.nlpResults[nlpId]={speech:''};if(nlpResponse.speech&&nlpResponse.speech!==''){state.nlpResults[nlpId].speech=nlpResponse.speech;}state.nlpResults[nlpId].action=action;state.nlpResults[nlpId].nlpParameters=_this3.getNlpParameters(nlpParameters);state.nlpResults[nlpId].nlpSuggestions=suggestions;});D.logCurrentEventDurationWithStartTime('nlpAnalysis',startNLP,Date.now());});}else{D.warning({message:'No NLP Engine added to the bot'});}}return[];}},{key:'nlpEngine',set:function set(nlpEngine){this._nlpEngine=nlpEngine;},get:function get(){return this._nlpEngine;}},{key:'nlpIds',get:function get(){return this._nlpIds;}},{key:'nlpAlias',get:function get(){return this._nlpAlias;},set:function set(nlpAlias){this._nlpAlias=nlpAlias;}}]);return NLP;}();var Intent=function(){_createClass(Intent,null,[{key:'EDGE',value:function EDGE(){return'Edge';}},{key:'CLOUD',value:function CLOUD(){return'Cloud';}},{key:'NO_INTENT',value:function NO_INTENT(){return'input.unknown';}},{key:'SPEECH',value:function SPEECH(){return'speech';}},{key:'LOCATION',value:function LOCATION(){return'__location_';}},{key:'CONTACT',value:function CONTACT(){return'__contact_';}},{key:'IMAGE',value:function IMAGE(){return'__image_';}},{key:'VIDEO',value:function VIDEO(){return'__video_';}},{key:'FILE',value:function FILE(){return'__file_';}}]);function Intent(intentId){_classCallCheck(this,Intent);this['_intentId']=intentId;this['_runLocation']=Intent.EDGE();this['_nlpId']='';this['_smartSuggestions']=[];this['_botFlow']='';this['_botFlowStartIntent']=false;this['_dependencies']=[];this['_logHistory']=true;this['_silentIntent']=false;}_createClass(Intent,[{key:'runOnCloud',value:function runOnCloud(){this._runLocation=Intent.CLOUD();}},{key:'runOnEdge',value:function runOnEdge(){this._runLocation=Intent.EDGE();}},{key:'disableHistoryLogging',value:function disableHistoryLogging(){this._logHistory=false;}},{key:'silenceIntent',value:function silenceIntent(){this._silentIntent=true;}},{key:'setEnglishSmartSuggestions',value:function setEnglishSmartSuggestions(suggestions){this._smartSuggestions=[{lang:'en',list:suggestions.reverse()}];}},{key:'setEnglishSmartSuggestionsWithCondition',value:function setEnglishSmartSuggestionsWithCondition(defaultSuggestions,newSuggestions,conditionBlock){if(Array.isArray(newSuggestions)&&Array.isArray(defaultSuggestions)){if(conditionBlock()){this._smartSuggestions=[{lang:'en',list:newSuggestions.reverse()}];}else{this._smartSuggestions=[{lang:'en',list:defaultSuggestions.reverse()}];}}else{this._smartSuggestions=[{lang:'en',list:['Invalid smart suggestion type. Must be array']}];}}},{key:'setSmartSuggestions',value:function setSmartSuggestions(lang,suggestions){this._smartSuggestions=[{lang:lang,list:suggestions}];}},{key:'matchSuggestions',value:function matchSuggestions(message){if(typeof message==='string'){console.log(message);console.log(JSON.stringify(this._smartSuggestions));var findSuggestion=function findSuggestion(suggestion){var list=suggestion.list;return list.includes(message);};console.log(JSON.stringify(this._smartSuggestions.find(findSuggestion)));return!!this._smartSuggestions.find(findSuggestion);}return false;}},{key:'silentIntent',get:function get(){return this._silentIntent;}},{key:'logHistory',get:function get(){return this._logHistory;}},{key:'runLocation',get:function get(){return this._runLocation;}},{key:'onValidation',get:function get(){return this._onValidation;},set:function set(onValidationBlock){this._onValidation=onValidationBlock;}},{key:'onError',get:function get(){return this._onError;},set:function set(onErrorBlock){this._onError=onErrorBlock;}},{key:'intentId',get:function get(){return this._intentId;}},{key:'nlpId',set:function set(nlpId){this._nlpId=nlpId;},get:function get(){return this._nlpId;}},{key:'suggestionsArray',get:function get(){return this._smartSuggestions;},set:function set(suggestions){this._smartSuggestions=suggestions;}},{key:'onMatching',get:function get(){return this._onMatching;},set:function set(matcher){this._onMatching=matcher;}},{key:'onResolution',get:function get(){return this['_onResolution'];},set:function set(resolver){this['_onResolution']=resolver;}}]);return Intent;}();var VideoCall=function(_Intent){_inherits(VideoCall,_Intent);_createClass(VideoCall,null,[{key:'VIDEO_RESPONSE',value:function VIDEO_RESPONSE(){return'video_response';}},{key:'START_VIDEO_ACTION',value:function START_VIDEO_ACTION(){return'startVideo';}},{key:'RING_START_ACTION',value:function RING_START_ACTION(){return'ringStart';}},{key:'RING_STOP_ACTION',value:function RING_STOP_ACTION(){return'ringStop';}},{key:'TEXT_ACTION',value:function TEXT_ACTION(){return'text';}},{key:'PEER_REQUEST_ACTION',value:function PEER_REQUEST_ACTION(){return'peerRequest';}},{key:'BUSY_LINE_ACTION',value:function BUSY_LINE_ACTION(){return'busyLine';}},{key:'CALL_ACTIVE_ACTION',value:function CALL_ACTIVE_ACTION(){return'callActive';}},{key:'CALL_END_ACTION',value:function CALL_END_ACTION(){return'callEnd';}},{key:'CALL_ERROR_ACTION',value:function CALL_ERROR_ACTION(){return'error';}},{key:'CALL_PICKUP_ACTION',value:function CALL_PICKUP_ACTION(){return'pickup';}},{key:'CALL_MISSED_ACTION',value:function CALL_MISSED_ACTION(){return'missed';}},{key:'CALL_REJECTED_ACTION',value:function CALL_REJECTED_ACTION(){return'callRejected';}},{key:'callVideoCap',value:function callVideoCap(botState,callData,action){var params={capability:'VoiceCallCapability',capabilityFileName:'voiceCallCapability',action:action,videoSessionId:callData.videoSessionId,callInitiatorUserId:callData.userId,callConnectedUserId:callData.drId,metadata:{callData:callData}};return botState.callCapability(params);}},{key:'startVideoCallRequest',value:function startVideoCallRequest(botState,callData){return VideoCall.callVideoCap(botState,callData,'initiateVideoCall');}},{key:'videoCallConnected',value:function videoCallConnected(botState,callData){return VideoCall.callVideoCap(botState,callData,'connectSuccessVideoCall');}},{key:'endVideoCall',value:function endVideoCall(botState,callData){return VideoCall.callVideoCap(botState,callData,'endVideoCall');}}]);function VideoCall(intentId,botState){var _this5=this;_classCallCheck(this,VideoCall);var _this4=_possibleConstructorReturn(this,(VideoCall.__proto__||Object.getPrototypeOf(VideoCall)).call(this,intentId));_this4.onPeerRequest=function _callee57(){return regeneratorRuntime.async(function _callee57$(_context57){while(1){switch(_context57.prev=_context57.next){case 0:case'end':return _context57.stop();}}},null,_this5);};_this4.onBusyLine=function _callee58(){return regeneratorRuntime.async(function _callee58$(_context58){while(1){switch(_context58.prev=_context58.next){case 0:case'end':return _context58.stop();}}},null,_this5);};_this4.onCallActive=function _callee59(){return regeneratorRuntime.async(function _callee59$(_context59){while(1){switch(_context59.prev=_context59.next){case 0:case'end':return _context59.stop();}}},null,_this5);};_this4.onCallEnd=function _callee60(){return regeneratorRuntime.async(function _callee60$(_context60){while(1){switch(_context60.prev=_context60.next){case 0:case'end':return _context60.stop();}}},null,_this5);};_this4.onCallRejected=function _callee61(){return regeneratorRuntime.async(function _callee61$(_context61){while(1){switch(_context61.prev=_context61.next){case 0:case'end':return _context61.stop();}}},null,_this5);};_this4._botState=botState;_this4._video=true;_this4.action=VideoCall.START_VIDEO_ACTION();return _this4;}_createClass(VideoCall,[{key:'message',value:function message(action){return{controlId:this.intentId,action:action,userDomain:this._botState.currentUserDomain,botId:this._botState.conversation.bot,conversationId:this._botState.conversation.conversationId,userId:this._botState.user.userId,userEmail:this._botState.user.userEmail,video:this._video,videoSessionId:this._videoSessionId,text:action===VideoCall.TEXT_ACTION()||action===VideoCall.CALL_PICKUP_ACTION()||action===VideoCall.START_VIDEO_ACTION()?this._text:null};}},{key:'video',set:function set(video){this._video=video;}},{key:'text',set:function set(text){this._text=text;}},{key:'videoSessionId',set:function set(videoSessionId){this._videoSessionId=videoSessionId;}},{key:'onMatching',get:function get(){var _this6=this;return function(state){return state.messageTypeFromUser===VideoCall.VIDEO_RESPONSE()&&state.messageFromUser.controlId===_this6.intentId;};}},{key:'onResolution',get:function get(){var _this7=this;return function _callee62(state){return regeneratorRuntime.async(function _callee62$(_context62){while(1){switch(_context62.prev=_context62.next){case 0:state.currentControlId=_this7.intentId;console.log('Started VideoCall onResolution');if(!(state.messageFromUser.action===VideoCall.PEER_REQUEST_ACTION())){_context62.next=7;break;}_context62.next=5;return regeneratorRuntime.awrap(_this7.onPeerRequest());case 5:_context62.next=28;break;case 7:if(!(state.messageFromUser.action===VideoCall.BUSY_LINE_ACTION())){_context62.next=12;break;}_context62.next=10;return regeneratorRuntime.awrap(_this7.onBusyLine());case 10:_context62.next=28;break;case 12:if(!(state.messageFromUser.action===VideoCall.CALL_ACTIVE_ACTION())){_context62.next=17;break;}_context62.next=15;return regeneratorRuntime.awrap(_this7.onCallActive());case 15:_context62.next=28;break;case 17:if(!(state.messageFromUser.action===VideoCall.CALL_END_ACTION())){_context62.next=22;break;}_context62.next=20;return regeneratorRuntime.awrap(_this7.onCallEnd());case 20:_context62.next=28;break;case 22:if(!(state.messageFromUser.action===VideoCall.CALL_REJECTED_ACTION())){_context62.next=27;break;}_context62.next=25;return regeneratorRuntime.awrap(_this7.onCallRejected());case 25:_context62.next=28;break;case 27:if(state.messageFromUser.action===VideoCall.CALL_ERROR_ACTION()){state.addSystemErrorToStack(30,state.messageFromUser.errorMessage);}else{state.addSystemErrorToStack(30,Error.getErrorMessageforCodeAndLang(30));}case 28:if(state.responsesArray.length===0){state.addSilentResponse();}case 29:case'end':return _context62.stop();}}},null,_this7);};}}]);return VideoCall;}(Intent);var GallerySelection=function(_Intent2){_inherits(GallerySelection,_Intent2);_createClass(GallerySelection,null,[{key:'GALLERY_SELECTION_RESPONSE',value:function GALLERY_SELECTION_RESPONSE(){return'gallerySelection_response';}},{key:'GALLERY_SELECTION_MESSAGE',value:function GALLERY_SELECTION_MESSAGE(){return'gallerySelection';}}]);function GallerySelection(intentId){var _this9=this;_classCallCheck(this,GallerySelection);var _this8=_possibleConstructorReturn(this,(GallerySelection.__proto__||Object.getPrototypeOf(GallerySelection)).call(this,intentId));_this8._gallery=[];_this8._onEnd=function _callee63(){return regeneratorRuntime.async(function _callee63$(_context63){while(1){switch(_context63.prev=_context63.next){case 0:case'end':return _context63.stop();}}},null,_this9);};return _this8;}_createClass(GallerySelection,[{key:'message',value:function message(){return{options:{controlId:this.intentId},gallery:this._gallery};}},{key:'gallery',set:function set(gallery){this._gallery=gallery;}},{key:'onMatching',get:function get(){var _this10=this;return function(state){return state.messageTypeFromUser===GallerySelection.GALLERY_SELECTION_RESPONSE()&&state.messageFromUser.controlId===_this10.intentId;};}},{key:'onResolution',get:function get(){var _this11=this;return function _callee64(state){return regeneratorRuntime.async(function _callee64$(_context64){while(1){switch(_context64.prev=_context64.next){case 0:state.currentControlId=_this11.intentId;if(!(state.messageFromUser.action==='end')){_context64.next=4;break;}_context64.next=4;return regeneratorRuntime.awrap(_this11.onEnd());case 4:if(state.responsesArray.length===0){state.addSilentResponse();}case 5:case'end':return _context64.stop();}}},null,_this11);};}},{key:'onEnd',set:function set(onEnd){this._onEnd=onEnd;},get:function get(){return this._onEnd;}}]);return GallerySelection;}(Intent);var JourneyPlan=function(_Intent3){_inherits(JourneyPlan,_Intent3);_createClass(JourneyPlan,null,[{key:'JOURNEY_PLAN_RESPONSE',value:function JOURNEY_PLAN_RESPONSE(){return'journeyPlan_response';}},{key:'JOURNEY_PLAN_MESSAGE',value:function JOURNEY_PLAN_MESSAGE(){return'journeyPlan';}}]);function JourneyPlan(intentId){var _this13=this;_classCallCheck(this,JourneyPlan);var _this12=_possibleConstructorReturn(this,(JourneyPlan.__proto__||Object.getPrototypeOf(JourneyPlan)).call(this,intentId));_this12._plan=[];_this12._label='';_this12._onEnd=function _callee65(){return regeneratorRuntime.async(function _callee65$(_context65){while(1){switch(_context65.prev=_context65.next){case 0:case'end':return _context65.stop();}}},null,_this13);};return _this12;}_createClass(JourneyPlan,[{key:'message',value:function message(){return{options:{controlId:this.intentId,label:this._label},plan:this._plan};}},{key:'label',set:function set(label){this._label=label;}},{key:'plan',set:function set(plan){this._plan=plan;}},{key:'onMatching',get:function get(){var _this14=this;return function(state){return state.messageTypeFromUser===JourneyPlan.JOURNEY_PLAN_RESPONSE()&&state.messageFromUser.controlId===_this14.intentId;};}},{key:'onResolution',get:function get(){var _this15=this;return function _callee66(state){return regeneratorRuntime.async(function _callee66$(_context66){while(1){switch(_context66.prev=_context66.next){case 0:state.currentControlId=_this15.intentId;if(state.responsesArray.length===0){state.addSilentResponse();}case 2:case'end':return _context66.stop();}}},null,_this15);};}}]);return JourneyPlan;}(Intent);var MenuEntry=function(_Intent4){_inherits(MenuEntry,_Intent4);function MenuEntry(intentId,_ref){var _this17=this;var menu=_ref.menu,menuEntry=_ref.menuEntry,label=_ref.label,icon=_ref.icon,description=_ref.description;_classCallCheck(this,MenuEntry);var _this16=_possibleConstructorReturn(this,(MenuEntry.__proto__||Object.getPrototypeOf(MenuEntry)).call(this,intentId));_this16.onClick=function _callee67(){return regeneratorRuntime.async(function _callee67$(_context67){while(1){switch(_context67.prev=_context67.next){case 0:case'end':return _context67.stop();}}},null,_this17);};_this16._menuEntries=[];_this16._label=label;_this16._icon=icon;_this16._description=description;if(menu){_this16._menu=menu;}if(menuEntry){menuEntry.addMenuEntry(_this16);}else{if(menu)_this16.menu.addMenuEntry(_this16);}return _this16;}_createClass(MenuEntry,[{key:'addMenuEntry',value:function addMenuEntry(menuEntry){this._menuEntries.push(menuEntry);}},{key:'message',value:function message(){var getMenuArray=function getMenuArray(menuEntries){var menuArray=[];menuEntries.forEach(function(menuEntry){if(menuEntry.subMenu.length>0){menuArray.push(getMenuArray(menuEntry.subMenu));}else{menuArray.push(menuEntry.message());}});return menuArray;};if(this._menuEntries.length>0){var submenu=getMenuArray(this._menuEntries);return{id:this.intentId,label:this._label,icon:this._icon,description:this._description,submenu:submenu};}return{id:this.intentId,label:this._label};}},{key:'menu',set:function set(menu){this._menu=menu;menu.addMenuEntry(this);},get:function get(){return this._menu;}},{key:'label',set:function set(label){this._label=label;}},{key:'subMenu',get:function get(){return this._menuEntries;}},{key:'onMatching',get:function get(){var _this18=this;return function(state){console.info('Matching menu');return state.messageTypeFromUser===Menu.MENU_RESPONSE()&&(_this18.menu&&state.messageFromUser.controlId===_this18.menu.intentId||_this18.menuEntry&&state.messageFromUser.controlId===_this18.menuEntry.intentId)&&state.messageFromUser.selectedEntry===_this18.intentId;};}},{key:'onResolution',get:function get(){var _this19=this;return function _callee68(state){return regeneratorRuntime.async(function _callee68$(_context68){while(1){switch(_context68.prev=_context68.next){case 0:state.currentControlId=_this19.intentId;_context68.next=3;return regeneratorRuntime.awrap(_this19.onClick());case 3:case'end':return _context68.stop();}}},null,_this19);};}}]);return MenuEntry;}(Intent);var Menu=function(_Intent5){_inherits(Menu,_Intent5);_createClass(Menu,null,[{key:'MENU_RESPONSE',value:function MENU_RESPONSE(){return'menu_response';}}]);function Menu(intentId){_classCallCheck(this,Menu);var _this20=_possibleConstructorReturn(this,(Menu.__proto__||Object.getPrototypeOf(Menu)).call(this,intentId));_this20._menuEntries=[];return _this20;}_createClass(Menu,[{key:'addMenuEntry',value:function addMenuEntry(menuEntry){this._menuEntries.push(menuEntry);}},{key:'message',value:function message(){var _this21=this;var getMenuArray=function getMenuArray(){var menuArray=[];_this21._menuEntries.forEach(function(menuEntry){menuArray.push(menuEntry.message());});return menuArray;};return{menuEntries:getMenuArray(),options:{controlId:this.intentId}};}}]);return Menu;}(Intent);var Chat=function(_Intent6){_inherits(Chat,_Intent6);_createClass(Chat,null,[{key:'ASSIGNED_TO_USER',value:function ASSIGNED_TO_USER(){return'assignedToUser';}},{key:'TIMEOUT_REACHED',value:function TIMEOUT_REACHED(){return'timeoutReached';}},{key:'CONVERSATION_CLOSED',value:function CONVERSATION_CLOSED(){return'conversationClosed';}}]);function Chat(intentId){var _this23=this;_classCallCheck(this,Chat);var _this22=_possibleConstructorReturn(this,(Chat.__proto__||Object.getPrototypeOf(Chat)).call(this,intentId));_this22.onChatModeration=function _callee69(){return regeneratorRuntime.async(function _callee69$(_context69){while(1){switch(_context69.prev=_context69.next){case 0:case'end':return _context69.stop();}}},null,_this23);};return _this22;}_createClass(Chat,[{key:'onMatching',get:function get(){return function(state){console.log('Matching chat');return state.inSilence;};}},{key:'onResolution',get:function get(){var _this24=this;return function _callee70(state){var sendEmail;return regeneratorRuntime.async(function _callee70$(_context71){while(1){switch(_context71.prev=_context71.next){case 0:state.currentControlId=_this24.intentId;sendEmail=function sendEmail(emailAddress,userName,operatorName,operatorUserId,botId,conversationId){var _,emailBody,transcription,messages;return regeneratorRuntime.async(function sendEmail$(_context70){while(1){switch(_context70.prev=_context70.next){case 0:_=state._;emailBody='';_context70.next=4;return regeneratorRuntime.awrap(state.cc.getTranscriptionForCurrentConversation({}));case 4:transcription=_context70.sent;messages=[];console.log('Transcriptions: '+state.R.toString(transcription));_.forEach(_.get(transcription,'messages'),function(message){var i=0;while(i<messages.length&&message.createdOn>messages[i].createdOn){i++;}messages.splice(i,0,message);});console.log('Transcripted messages: '+state.R.toString(messages));_.forEach(messages,function(message){var content=_.get(message,'content');if(_.get(message,'contentType')==='10'){if(_.get(message,'createdBy')===state.user.userId){emailBody=emailBody+('<p>'+userName+': '+content[0]+'</p>');}else if(!_.get(message,'createdBy')){emailBody=emailBody+('<p>Chatbot: '+content[0]+'</p>');}else if(_.get(message,'createdBy')===operatorUserId){emailBody=emailBody+('<p>'+operatorName+': '+content[0]+'</p>');}else{emailBody=emailBody+('<p>Chatbot: '+content[0]+'</p>');}}else if(_.get(message,'contentType')==='400'){var form=state._.get(message,'content')[0];if(state._.get(form,'action')===Form2.CONFIRM_FORM_ACTION()){var fields=Form2.formResponseAsObject(form);emailBody=emailBody+'<p>Personal information</p>';emailBody=emailBody+'<ul>';state._.forEach(fields,function(value,key){emailBody=emailBody+('<li>'+key+': '+value+'</li>');});emailBody=emailBody+'</ul>';}}});console.log('Transcripted email: '+emailBody);_context70.next=13;return regeneratorRuntime.awrap(state.notification.sendEmail(emailAddress,'Conversation transcription',emailBody));case 13:case'end':return _context70.stop();}}},null,_this24);};console.log('Chat onResolution');_context71.next=5;return regeneratorRuntime.awrap(_this24.onChatModeration());case 5:if(!(state.responsesArray.length===0)){_context71.next=31;break;}if(!(state.messageFromUser.intentId===Chat.ASSIGNED_TO_USER())){_context71.next=10;break;}state.addStringResponse('You will start a conversation with '+state.messageFromUser.userName);_context71.next=27;break;case 10:if(!(state.messageFromUser.intentId===Chat.TIMEOUT_REACHED())){_context71.next=17;break;}state.addStringResponse('All our operators are busy at this moment, your contact details have been sent to our advisory team and they will contact you soon');state.wakeUpBot();_context71.next=15;return regeneratorRuntime.awrap(sendEmail('support@frontm.com',state.messageFromUser.userName,state.messageFromUser.operatorName,state.messageFromUser.operatorUserId));case 15:_context71.next=27;break;case 17:if(!(state.messageFromUser.intentId===Chat.CONVERSATION_CLOSED())){_context71.next=27;break;}state.addStringResponse('The conversation has been closed. Thank you very much for talking with us');state.wakeUpBot();if(!state.messageFromUser.emailEndUser){_context71.next=24;break;}_context71.next=23;return regeneratorRuntime.awrap(sendEmail(state.messageFromUser.emailAddress,state.messageFromUser.userName,state.messageFromUser.operatorName,state.messageFromUser.operatorUserId,state.messageFromUser.botId,state.messageFromUser.conversationId));case 23:state.addStringResponse('We have sent you an email with the transcription of the conversation');case 24:if(!state.messageFromUser.ccEmailAddress){_context71.next=27;break;}_context71.next=27;return regeneratorRuntime.awrap(sendEmail(state.messageFromUser.ccEmailAddress,state.messageFromUser.userName,state.messageFromUser.operatorName,state.messageFromUser.operatorUserId,state.messageFromUser.botId,state.messageFromUser.conversationId));case 27:state.addSilentResponse();state.notification.sendIMMessage();_context71.next=31;break;case 31:case'end':return _context71.stop();}}},null,_this24);};}}]);return Chat;}(Intent);var Table=function(_Intent7){_inherits(Table,_Intent7);_createClass(Table,null,[{key:'TABLE_RESPONSE',value:function TABLE_RESPONSE(){return'table_response';}},{key:'ON_ACTION',value:function ON_ACTION(){return'onAction';}},{key:'ON_FIELD_ACTION',value:function ON_FIELD_ACTION(){return'onFieldAction';}},{key:'ON_SELECTION',value:function ON_SELECTION(){return'onSelection';}},{key:'ON_MENU_ACTION',value:function ON_MENU_ACTION(){return'onMenuAction';}},{key:'ON_REFRESH',value:function ON_REFRESH(){return'onRefresh';}},{key:'ON_DOWNLOAD',value:function ON_DOWNLOAD(){return'onDownload';}},{key:'ON_CONFIRM',value:function ON_CONFIRM(){return'onConfirm';}},{key:'ON_DELETE',value:function ON_DELETE(){return'onDelete';}},{key:'ON_SAVE',value:function ON_SAVE(){return'onSave';}},{key:'ON_CLOSE',value:function ON_CLOSE(){return'close';}},{key:'ON_SEARCH',value:function ON_SEARCH(){return'search';}},{key:'ON_PREVIOUS_PAGE',value:function ON_PREVIOUS_PAGE(){return'previousPage';}},{key:'ON_NEXT_PAGE',value:function ON_NEXT_PAGE(){return'nextPage';}},{key:'CLASSIC_TABLE_STYLE',value:function CLASSIC_TABLE_STYLE(){return'table';}},{key:'CALENDAR_TABLE_STYLE',value:function CALENDAR_TABLE_STYLE(){return'calendar';}},{key:'ON_FILTER_ACTION',value:function ON_FILTER_ACTION(){return'filter';}},{key:'ON_FILTER_DELETE_ACTION',value:function ON_FILTER_DELETE_ACTION(){return'filterDelete';}}]);function Table(intentId,_ref2){var _this26=this;var title=_ref2.title,description=_ref2.description,columnNames=_ref2.columnNames,filter=_ref2.filter,keys=_ref2.keys,_ref2$selectableRows=_ref2.selectableRows,selectableRows=_ref2$selectableRows===undefined?false:_ref2$selectableRows,_ref2$actionableRows=_ref2.actionableRows,actionableRows=_ref2$actionableRows===undefined?false:_ref2$actionableRows,_ref2$addNewRows=_ref2.addNewRows,addNewRows=_ref2$addNewRows===undefined?false:_ref2$addNewRows,addNewRowsLabel=_ref2.addNewRowsLabel,_ref2$allowMinimize=_ref2.allowMinimize,allowMinimize=_ref2$allowMinimize===undefined?true:_ref2$allowMinimize,_ref2$allowClose=_ref2.allowClose,allowClose=_ref2$allowClose===undefined?true:_ref2$allowClose,_ref2$minimizeOnActio=_ref2.minimizeOnAction,minimizeOnAction=_ref2$minimizeOnActio===undefined?false:_ref2$minimizeOnActio,footer=_ref2.footer,rowMenu=_ref2.rowMenu,pages=_ref2.pages,zone=_ref2.zone,_ref2$allowChange=_ref2.allowChange,allowChange=_ref2$allowChange===undefined?false:_ref2$allowChange,_ref2$allowDelete=_ref2.allowDelete,allowDelete=_ref2$allowDelete===undefined?false:_ref2$allowDelete,_ref2$allowRefresh=_ref2.allowRefresh,allowRefresh=_ref2$allowRefresh===undefined?false:_ref2$allowRefresh,_ref2$allowDownload=_ref2.allowDownload,allowDownload=_ref2$allowDownload===undefined?false:_ref2$allowDownload,_ref2$allowSearch=_ref2.allowSearch,allowSearch=_ref2$allowSearch===undefined?false:_ref2$allowSearch,confirmAction=_ref2.confirmAction,_ref2$modal=_ref2.modal,modal=_ref2$modal===undefined?true:_ref2$modal,_ref2$style=_ref2.style,style=_ref2$style===undefined?Table.CLASSIC_TABLE_STYLE():_ref2$style,calendarEntry=_ref2.calendarEntry,activeFilterName=_ref2.activeFilterName,availableFilters=_ref2.availableFilters,filterActive=_ref2.filterActive;_classCallCheck(this,Table);var _this25=_possibleConstructorReturn(this,(Table.__proto__||Object.getPrototypeOf(Table)).call(this,intentId));_this25.onAction=function _callee71(){return regeneratorRuntime.async(function _callee71$(_context72){while(1){switch(_context72.prev=_context72.next){case 0:case'end':return _context72.stop();}}},null,_this26);};_this25.onFieldAction=function _callee72(){return regeneratorRuntime.async(function _callee72$(_context73){while(1){switch(_context73.prev=_context73.next){case 0:case'end':return _context73.stop();}}},null,_this26);};_this25.onSelection=function _callee73(){return regeneratorRuntime.async(function _callee73$(_context74){while(1){switch(_context74.prev=_context74.next){case 0:case'end':return _context74.stop();}}},null,_this26);};_this25.onRefresh=function _callee74(){return regeneratorRuntime.async(function _callee74$(_context75){while(1){switch(_context75.prev=_context75.next){case 0:case'end':return _context75.stop();}}},null,_this26);};_this25.onSearch=function _callee75(){return regeneratorRuntime.async(function _callee75$(_context76){while(1){switch(_context76.prev=_context76.next){case 0:case'end':return _context76.stop();}}},null,_this26);};_this25.onDownload=function _callee76(){return regeneratorRuntime.async(function _callee76$(_context77){while(1){switch(_context77.prev=_context77.next){case 0:case'end':return _context77.stop();}}},null,_this26);};_this25.onConfirm=function _callee77(){return regeneratorRuntime.async(function _callee77$(_context78){while(1){switch(_context78.prev=_context78.next){case 0:case'end':return _context78.stop();}}},null,_this26);};_this25.onDelete=function _callee78(){return regeneratorRuntime.async(function _callee78$(_context79){while(1){switch(_context79.prev=_context79.next){case 0:case'end':return _context79.stop();}}},null,_this26);};_this25.onSave=function _callee79(){return regeneratorRuntime.async(function _callee79$(_context80){while(1){switch(_context80.prev=_context80.next){case 0:case'end':return _context80.stop();}}},null,_this26);};_this25.onClose=function _callee80(){return regeneratorRuntime.async(function _callee80$(_context81){while(1){switch(_context81.prev=_context81.next){case 0:case'end':return _context81.stop();}}},null,_this26);};_this25.onMenuAction=function _callee81(){return regeneratorRuntime.async(function _callee81$(_context82){while(1){switch(_context82.prev=_context82.next){case 0:case'end':return _context82.stop();}}},null,_this26);};_this25.onPreviousPage=function _callee82(){return regeneratorRuntime.async(function _callee82$(_context83){while(1){switch(_context83.prev=_context83.next){case 0:case'end':return _context83.stop();}}},null,_this26);};_this25.onNextPage=function _callee83(){return regeneratorRuntime.async(function _callee83$(_context84){while(1){switch(_context84.prev=_context84.next){case 0:case'end':return _context84.stop();}}},null,_this26);};_this25.onFilter=function _callee84(){return regeneratorRuntime.async(function _callee84$(_context85){while(1){switch(_context85.prev=_context85.next){case 0:case'end':return _context85.stop();}}},null,_this26);};_this25.onFilterDelete=function _callee85(){return regeneratorRuntime.async(function _callee85$(_context86){while(1){switch(_context86.prev=_context86.next){case 0:case'end':return _context86.stop();}}},null,_this26);};_this25.title=title;_this25.description=description;_this25.columnNames=columnNames;_this25.filter=filter;_this25.keys=keys;_this25.selectableRows=selectableRows;_this25.actionableRows=actionableRows;_this25.addNewRows=addNewRows;_this25.addNewRowsLabel=addNewRowsLabel;_this25.allowMinimize=allowMinimize;_this25.allowClose=allowClose;_this25.allowSearch=allowSearch;_this25.minimizeOnAction=minimizeOnAction;_this25.style=style;_this25.calendarEntry=calendarEntry;_this25.footer=footer;_this25.rowMenu=rowMenu;_this25.pages=pages;_this25._rows=[];_this25.zone=zone;_this25.modal=modal;_this25.allowChange=allowChange;_this25.allowDelete=allowDelete;_this25.allowRefresh=allowRefresh;_this25.allowDownload=allowDownload;_this25.confirmAction=confirmAction;_this25._activeFilterName=activeFilterName;_this25._availableFilters=availableFilters;_this25._filterActive=filterActive;_this25._filteredColumns=[];return _this25;}_createClass(Table,[{key:'message',value:function message(){return{rows:this._rows,options:this.options};}},{key:'addRow',value:function addRow(row){this._rows.push(row);}},{key:'_callEvents',value:function _callEvents(state){return regeneratorRuntime.async(function _callEvents$(_context87){while(1){switch(_context87.prev=_context87.next){case 0:if(this._parent&&this._parent._intentId===state.currentControlId){state.developer.log({message:'Parent present',data:this._parent._intentId});state.currentControlId=this._parent._intentId;}else{state.developer.log({message:'Parent NOT present',data:this.intentId});state.currentControlId=this.intentId;}if(!(state.messageFromUser.action===Table.ON_ACTION())){_context87.next=6;break;}_context87.next=4;return regeneratorRuntime.awrap(this.onAction());case 4:_context87.next=77;break;case 6:if(!(state.messageFromUser.action===Table.ON_SELECTION())){_context87.next=11;break;}_context87.next=9;return regeneratorRuntime.awrap(this.onSelection());case 9:_context87.next=77;break;case 11:if(!(state.messageFromUser.action===Table.ON_SAVE())){_context87.next=16;break;}_context87.next=14;return regeneratorRuntime.awrap(this.onSave());case 14:_context87.next=77;break;case 16:if(!(state.messageFromUser.action===Table.ON_CLOSE())){_context87.next=21;break;}_context87.next=19;return regeneratorRuntime.awrap(this.onClose());case 19:_context87.next=77;break;case 21:if(!(state.messageFromUser.action===Table.ON_SEARCH())){_context87.next=26;break;}_context87.next=24;return regeneratorRuntime.awrap(this.onSearch());case 24:_context87.next=77;break;case 26:if(!(state.messageFromUser.action===Table.ON_MENU_ACTION())){_context87.next=31;break;}_context87.next=29;return regeneratorRuntime.awrap(this.onMenuAction());case 29:_context87.next=77;break;case 31:if(!(state.messageFromUser.action===Table.ON_FIELD_ACTION())){_context87.next=36;break;}_context87.next=34;return regeneratorRuntime.awrap(this.onFieldAction());case 34:_context87.next=77;break;case 36:if(!(state.messageFromUser.action===Table.ON_REFRESH())){_context87.next=41;break;}_context87.next=39;return regeneratorRuntime.awrap(this.onRefresh());case 39:_context87.next=77;break;case 41:if(!(state.messageFromUser.action===Table.ON_DOWNLOAD())){_context87.next=46;break;}_context87.next=44;return regeneratorRuntime.awrap(this.onDownload());case 44:_context87.next=77;break;case 46:if(!(state.messageFromUser.action===Table.ON_CONFIRM())){_context87.next=51;break;}_context87.next=49;return regeneratorRuntime.awrap(this.onConfirm());case 49:_context87.next=77;break;case 51:if(!(state.messageFromUser.action===Table.ON_DELETE())){_context87.next=56;break;}_context87.next=54;return regeneratorRuntime.awrap(this.onDelete());case 54:_context87.next=77;break;case 56:if(!(state.messageFromUser.action===Table.ON_PREVIOUS_PAGE())){_context87.next=61;break;}_context87.next=59;return regeneratorRuntime.awrap(this.onPreviousPage());case 59:_context87.next=77;break;case 61:if(!(state.messageFromUser.action===Table.ON_NEXT_PAGE())){_context87.next=66;break;}_context87.next=64;return regeneratorRuntime.awrap(this.onNextPage());case 64:_context87.next=77;break;case 66:if(!(state.messageFromUser.action===Table.ON_FILTER_ACTION())){_context87.next=71;break;}_context87.next=69;return regeneratorRuntime.awrap(this.onFilter());case 69:_context87.next=77;break;case 71:if(!(state.messageFromUser.action===Table.ON_FILTER_DELETE_ACTION())){_context87.next=76;break;}_context87.next=74;return regeneratorRuntime.awrap(this.onFilterDelete());case 74:_context87.next=77;break;case 76:state.addSystemErrorToStack(28,Error.getErrorMessageforCodeAndLang(28));case 77:if(state.responsesArray.length===0){state.addSilentResponse();}case 78:case'end':return _context87.stop();}}},null,this);}},{key:'options',get:function get(){var parent=null;if(this._parent){parent=this._parent._intentId;}return{parent:parent,tableId:this.intentId,controlId:this.intentId,title:this.title,description:this.description,columnNames:this.columnNames,filteredColumns:this._filteredColumns,filter:this.filter,keys:this.keys,selectableRows:this.selectableRows,actionableRows:this.actionableRows,addNewRows:this.addNewRows,addNewRowsLabel:this.addNewRowsLabel,allowMinimize:this.allowMinimize,allowClose:this.allowClose,minimizeOnAction:this.minimizeOnAction,footer:this.footer,rowMenu:this.rowMenu,pages:this.pages,zone:this.zone,modal:this.modal,allowChange:this.allowChange,allowDelete:this.allowDelete,allowRefresh:this.allowRefresh,allowDownload:this.allowDownload,confirmAction:this.confirmAction,allowSearch:this.allowSearch,style:this.style,calendarEntry:this.calendarEntry,activeFilterName:this._activeFilterName,availableFilters:this._availableFilters,filterActive:this._filterActive};}},{key:'parent',set:function set(parent){this._parent=parent;}},{key:'tableId',get:function get(){return this.intentId;}},{key:'rows',get:function get(){return this._rows;},set:function set(rows){this._rows=rows;}},{key:'onMatching',get:function get(){var _this27=this;return function(state){return state.messageTypeFromUser===Table.TABLE_RESPONSE()&&(state.messageFromUser.controlId===_this27.intentId||state.messageFromUser.tableId===_this27.intentId);};}},{key:'onResolution',get:function get(){var _this28=this;return function _callee86(state){return regeneratorRuntime.async(function _callee86$(_context88){while(1){switch(_context88.prev=_context88.next){case 0:_context88.next=2;return regeneratorRuntime.awrap(_this28._callEvents(state));case 2:case'end':return _context88.stop();}}},null,_this28);};}}]);return Table;}(Intent);var Container=function(_Intent8){_inherits(Container,_Intent8);_createClass(Container,null,[{key:'CONTAINER_CLOSE',value:function CONTAINER_CLOSE(){return'close';}},{key:'CONTAINER_RESPONSE',value:function CONTAINER_RESPONSE(){return'container_response';}},{key:'CONFIRM_CONTAINER_ACTION',value:function CONFIRM_CONTAINER_ACTION(){return'confirm';}},{key:'CANCEL_CONTAINER_ACTION',value:function CANCEL_CONTAINER_ACTION(){return'cancel';}},{key:'MORE_CONTAINER_ACTION',value:function MORE_CONTAINER_ACTION(){return'more';}},{key:'containerResponseAsObject',value:function containerResponseAsObject(message){var container=message.container;var results={};if(Array.isArray(container)){container.forEach(function(entry){if(entry.formId){results[entry.formId]=Form2.formResponseAsObject(entry);}else{if(entry.tableId){results[entry.tableId]=entry.rows;}}});}return results;}}]);function Container(intentId,_ref3){var _this30=this;var title=_ref3.title,description=_ref3.description,allowMinimize=_ref3.allowMinimize,allowClose=_ref3.allowClose,zone=_ref3.zone,confirm=_ref3.confirm,cancel=_ref3.cancel,_ref3$more=_ref3.more,more=_ref3$more===undefined?[]:_ref3$more,keysDocument=_ref3.keysDocument,_ref3$modal=_ref3.modal,modal=_ref3$modal===undefined?true:_ref3$modal;_classCallCheck(this,Container);var _this29=_possibleConstructorReturn(this,(Container.__proto__||Object.getPrototypeOf(Container)).call(this,intentId));_this29.onClose=function _callee87(){return regeneratorRuntime.async(function _callee87$(_context89){while(1){switch(_context89.prev=_context89.next){case 0:case'end':return _context89.stop();}}},null,_this30);};_this29.onSubmit=function _callee88(){return regeneratorRuntime.async(function _callee88$(_context90){while(1){switch(_context90.prev=_context90.next){case 0:case'end':return _context90.stop();}}},null,_this30);};_this29.onCancel=function _callee89(){return regeneratorRuntime.async(function _callee89$(_context91){while(1){switch(_context91.prev=_context91.next){case 0:case'end':return _context91.stop();}}},null,_this30);};_this29.onMoreButtons=function _callee90(){return regeneratorRuntime.async(function _callee90$(_context92){while(1){switch(_context92.prev=_context92.next){case 0:case'end':return _context92.stop();}}},null,_this30);};_this29.controlId=intentId;_this29.title=title;_this29.description=description;_this29.allowMinimize=allowMinimize;_this29.allowClose=allowClose;_this29._fields=[];_this29.zone=zone;_this29._children=[];_this29._keys=[];_this29._more=more;_this29.confirm=confirm;_this29.cancel=cancel;_this29.modal=modal;_this29._keysDocument=keysDocument;if(keysDocument&&keysDocument._fields){_this29._keys=keysDocument._fields;}return _this29;}_createClass(Container,[{key:'addChild',value:function addChild(child){child.parent=this;this._children.push(child);}},{key:'addForm',value:function addForm(formMessage){this._fields.push({type:'form2',message:formMessage});}},{key:'addTable',value:function addTable(tableMessage){this._fields.push({type:'table',message:tableMessage});}},{key:'setKeysDocument',value:function setKeysDocument(document){if(document instanceof Doc&&document._fields){this._keys=document._fields;this._keysDocument=document;}}},{key:'addKeys',value:function addKeys(keys){var _this31=this;if(Array.isArray(keys)){keys.forEach(function(key){_this31.addKey(key);});}else{this.addKey(keys);}}},{key:'addKey',value:function addKey(key){if(key instanceof Form2Field||key instanceof Field){this._keys.push(key);}}},{key:'loadDocFromAutoSaveBuffer',value:function loadDocFromAutoSaveBuffer(){this._children.forEach(function(child){if(child instanceof Doc){child.loadDocFromAutoSaveBuffer();}});}},{key:'clearAutoSaveBuffer',value:function clearAutoSaveBuffer(){this._children.forEach(function(child){if(child instanceof Doc){child.clearAutoSaveBuffer();}});}},{key:'message',value:function message(){var _this32=this;var getChildrenMessage=function getChildrenMessage(){var finalMessage=[];_this32._children.forEach(function(child){var message={};if(child instanceof Form2){message.type='form2';}else if(child instanceof Table){message.type='table';}message.message=child.message();finalMessage.push(message);});return finalMessage;};var headerKeys=this._keys.map(function(key){return key.message();});console.log('>>>>>>>header',headerKeys);return{fields:this._children.length>0?getChildrenMessage():this._fields,options:{controlId:this.intentId,title:this.title,description:this.description,allowMinimize:this.allowMinimize,allowClose:this.allowClose,confirm:this.confirm,cancel:this.cancel,zone:this.zone,keys:headerKeys,modal:this.modal,more:this._more}};}},{key:'more',set:function set(moreArray){this._more=moreArray;}},{key:'fields',set:function set(fields){this._fields=fields;}},{key:'onMatching',get:function get(){var _this33=this;return function(state){return state.messageTypeFromUser===Container.CONTAINER_RESPONSE()&&state.messageFromUser.controlId===_this33.controlId&&!state.messageFromUser.currentField;};}},{key:'onResolution',get:function get(){var _this34=this;return function _callee91(state){return regeneratorRuntime.async(function _callee91$(_context93){while(1){switch(_context93.prev=_context93.next){case 0:state.currentControlId=_this34.intentId;if(!(state.messageFromUser.action===Container.CONTAINER_CLOSE())){_context93.next=6;break;}_context93.next=4;return regeneratorRuntime.awrap(_this34.onClose());case 4:_context93.next=22;break;case 6:if(!(state.messageFromUser.action===Container.CONFIRM_CONTAINER_ACTION())){_context93.next=11;break;}_context93.next=9;return regeneratorRuntime.awrap(_this34.onSubmit());case 9:_context93.next=22;break;case 11:if(!(state.messageFromUser.action===Container.CANCEL_CONTAINER_ACTION())){_context93.next=16;break;}_context93.next=14;return regeneratorRuntime.awrap(_this34.onCancel());case 14:_context93.next=22;break;case 16:if(!(state.messageFromUser.action===Container.MORE_CONTAINER_ACTION())){_context93.next=21;break;}_context93.next=19;return regeneratorRuntime.awrap(_this34.onMoreButtons());case 19:_context93.next=22;break;case 21:state.addSystemErrorToStack(29,Error.getErrorMessageforCodeAndLang(29));case 22:if(state.responsesArray.length===0){state.addSilentResponse();}case 23:case'end':return _context93.stop();}}},null,_this34);};}}]);return Container;}(Intent);var Geofence=function(_Intent9){_inherits(Geofence,_Intent9);_createClass(Geofence,null,[{key:'GEOFENCE_MESSAGE',value:function GEOFENCE_MESSAGE(){return'geofence';}},{key:'GEOFENCE_RESPONSE',value:function GEOFENCE_RESPONSE(){return'geofence_response';}},{key:'SAVE_ACTION',value:function SAVE_ACTION(){return'save';}},{key:'NEW_ACTION',value:function NEW_ACTION(){return'new';}},{key:'UPDATE_ACTION',value:function UPDATE_ACTION(){return'update';}},{key:'DISPLAY_ACTION',value:function DISPLAY_ACTION(){return'display';}},{key:'DELETE_ACTION',value:function DELETE_ACTION(){return'delete';}}]);function Geofence(intentId,_ref4){var _this36=this;var id=_ref4.id,name=_ref4.name,description=_ref4.description,color=_ref4.color,coordinates=_ref4.coordinates;_classCallCheck(this,Geofence);var _this35=_possibleConstructorReturn(this,(Geofence.__proto__||Object.getPrototypeOf(Geofence)).call(this,intentId));_this35.onSave=function _callee92(){return regeneratorRuntime.async(function _callee92$(_context94){while(1){switch(_context94.prev=_context94.next){case 0:case'end':return _context94.stop();}}},null,_this36);};_this35.onDelete=function _callee93(){return regeneratorRuntime.async(function _callee93$(_context95){while(1){switch(_context95.prev=_context95.next){case 0:case'end':return _context95.stop();}}},null,_this36);};_this35._id=id;_this35._name=name;_this35._description=description;_this35._color=color;_this35._coordinates=coordinates;return _this35;}_createClass(Geofence,[{key:'message',value:function message(action){return{options:{controlId:this.intentId,id:this._id,name:this._name,description:this._description,color:this._color,action:action},coordinates:this._coordinates};}},{key:'onMatching',get:function get(){var _this37=this;return function(state){return state.messageTypeFromUser===Geofence.GEOFENCE_RESPONSE()&&state.messageFromUser.controlId===_this37.intentId;};}},{key:'onResolution',get:function get(){var _this38=this;return function _callee94(state){return regeneratorRuntime.async(function _callee94$(_context96){while(1){switch(_context96.prev=_context96.next){case 0:state.currentControlId=_this38.intentId;if(!(state.messageFromUser.action===Geofence.SAVE_ACTION())){_context96.next=6;break;}_context96.next=4;return regeneratorRuntime.awrap(_this38.onSave());case 4:_context96.next=12;break;case 6:if(!(state.messageFromUser.action===Geofence.DELETE_ACTION())){_context96.next=11;break;}_context96.next=9;return regeneratorRuntime.awrap(_this38.onDelete());case 9:_context96.next=12;break;case 11:state.addSystemErrorToStack(29,Error.getErrorMessageforCodeAndLang(29));case 12:if(state.responsesArray.length===0){state.addSilentResponse();}case 13:case'end':return _context96.stop();}}},null,_this38);};}}]);return Geofence;}(Intent);var Form2Field=function(_Intent10){_inherits(Form2Field,_Intent10);_createClass(Form2Field,null,[{key:'MOVE_FORM_ACTION',value:function MOVE_FORM_ACTION(){return'move';}},{key:'SEARCH_FORM_ACTION',value:function SEARCH_FORM_ACTION(){return'search';}},{key:'CLICK_FORM_ACTION',value:function CLICK_FORM_ACTION(){return'click';}},{key:'FIELD_COMPLETION_FORM_ACTION',value:function FIELD_COMPLETION_FORM_ACTION(){return'completion';}}]);function Form2Field(intentId,_ref5){var _this40=this;var formId=_ref5.formId,form=_ref5.form,title=_ref5.title,type=_ref5.type,mandatory=_ref5.mandatory,validation=_ref5.validation,_ref5$readOnly=_ref5.readOnly,readOnly=_ref5$readOnly===undefined?false:_ref5$readOnly,value=_ref5.value,options=_ref5.options,info=_ref5.info,minLength=_ref5.minLength,maxLength=_ref5.maxLength,_ref5$hidden=_ref5.hidden,hidden=_ref5$hidden===undefined?false:_ref5$hidden;_classCallCheck(this,Form2Field);var _this39=_possibleConstructorReturn(this,(Form2Field.__proto__||Object.getPrototypeOf(Form2Field)).call(this,intentId));_this39.onMoveOut=function _callee95(){return regeneratorRuntime.async(function _callee95$(_context97){while(1){switch(_context97.prev=_context97.next){case 0:case'end':return _context97.stop();}}},null,_this40);};_this39.onClick=function _callee96(){return regeneratorRuntime.async(function _callee96$(_context98){while(1){switch(_context98.prev=_context98.next){case 0:case'end':return _context98.stop();}}},null,_this40);};_this39.onSearch=function _callee97(){return regeneratorRuntime.async(function _callee97$(_context99){while(1){switch(_context99.prev=_context99.next){case 0:case'end':return _context99.stop();}}},null,_this40);};_this39.onCompletion=function _callee98(){return regeneratorRuntime.async(function _callee98$(_context100){while(1){switch(_context100.prev=_context100.next){case 0:case'end':return _context100.stop();}}},null,_this40);};if(formId||form){_this39.formId=formId||form.intentId;}_this39.title=title;_this39.type=type;_this39.mandatory=mandatory;_this39.validation=validation;_this39.readOnly=readOnly;_this39._value=value;_this39.options=options;_this39.info=info;_this39.maxLength=maxLength;_this39.minLength=minLength;_this39.hidden=hidden;_this39.disableHistoryLogging();if(form){form.addField(_this39);}return _this39;}_createClass(Form2Field,[{key:'message',value:function message(){if(this.hidden){return{};}return{id:this.intentId,title:this.title,type:this.type,info:this.info,mandatory:this.mandatory,validation:this.validation,readOnly:this.readOnly,value:this.value,maxLength:this.maxLength,minLength:this.minLength,options:this.options};}},{key:'value',get:function get(){if(this._value==={})return;return this._value;},set:function set(value){this._value=value;}},{key:'id',get:function get(){return this.intentId;}},{key:'onMatching',get:function get(){var _this41=this;return function(state){var inputControlId=state.messageFromUser.controlId||state.messageFromUser.formId;return(state.messageTypeFromUser===Form2.FORM_RESPONSE()||state.messageTypeFromUser===Container.CONTAINER_RESPONSE())&&state.messageFromUser.currentField===_this41.id&&inputControlId===_this41.formId;};}},{key:'onResolution',get:function get(){var _this42=this;return function _callee99(state){return regeneratorRuntime.async(function _callee99$(_context101){while(1){switch(_context101.prev=_context101.next){case 0:console.log('Started Form2Field onResolution');if(!(state.messageFromUser.action===Form2Field.MOVE_FORM_ACTION())){_context101.next=6;break;}_context101.next=4;return regeneratorRuntime.awrap(_this42.onMoveOut());case 4:_context101.next=22;break;case 6:if(!(state.messageFromUser.action===Form2Field.CLICK_FORM_ACTION())){_context101.next=11;break;}_context101.next=9;return regeneratorRuntime.awrap(_this42.onClick());case 9:_context101.next=22;break;case 11:if(!(state.messageFromUser.action===Form2Field.SEARCH_FORM_ACTION())){_context101.next=16;break;}_context101.next=14;return regeneratorRuntime.awrap(_this42.onSearch());case 14:_context101.next=22;break;case 16:if(!(state.messageFromUser.action===Form2Field.FIELD_COMPLETION_FORM_ACTION())){_context101.next=21;break;}_context101.next=19;return regeneratorRuntime.awrap(_this42.onCompletion());case 19:_context101.next=22;break;case 21:state.addSystemErrorToStack(29,Error.getErrorMessageforCodeAndLang(29));case 22:if(state.responsesArray.length===0){console.log('Adding Form2 silent response');state.addSilentResponse();}case 23:case'end':return _context101.stop();}}},null,_this42);};}}]);return Form2Field;}(Intent);var Form2=function(_Intent11){_inherits(Form2,_Intent11);_createClass(Form2,null,[{key:'CONFIRM_FORM_ACTION',value:function CONFIRM_FORM_ACTION(){return'confirm';}},{key:'CANCEL_FORM_ACTION',value:function CANCEL_FORM_ACTION(){return'cancel';}},{key:'CLOSE_FORM_ACTION',value:function CLOSE_FORM_ACTION(){return'close';}},{key:'FORM_RESPONSE',value:function FORM_RESPONSE(){return'form_response';}},{key:'FORM_SEARCH_RESULTS_ACTION',value:function FORM_SEARCH_RESULTS_ACTION(){return'results';}},{key:'FORM_CHANGE_ACTION',value:function FORM_CHANGE_ACTION(){return'change';}},{key:'FORM_VALIDATION_ACTION',value:function FORM_VALIDATION_ACTION(){return'validation';}},{key:'formResponseAsObject',value:function formResponseAsObject(message){var fields={};if(message.fields){message.fields.forEach(function(field){if(field.fileName){fields[field.id]={value:field.value,fileName:field.fileName};}else{fields[field.id]=field.value;}});}else{if(message.currentField){fields[message.currentField]=message.currentFieldValue;}}return fields;}}]);function Form2(intentId,_ref6){var _this44=this;var title=_ref6.title,description=_ref6.description,_ref6$allowMinimize=_ref6.allowMinimize,allowMinimize=_ref6$allowMinimize===undefined?true:_ref6$allowMinimize,_ref6$allowClose=_ref6.allowClose,allowClose=_ref6$allowClose===undefined?true:_ref6$allowClose,_ref6$minimizeOnConfi=_ref6.minimizeOnConfirm,minimizeOnConfirm=_ref6$minimizeOnConfi===undefined?true:_ref6$minimizeOnConfi,confirm=_ref6.confirm,cancel=_ref6.cancel,icon=_ref6.icon,_ref6$readOnly=_ref6.readOnly,readOnly=_ref6$readOnly===undefined?false:_ref6$readOnly,_ref6$allowEdit=_ref6.allowEdit,allowEdit=_ref6$allowEdit===undefined?true:_ref6$allowEdit,zone=_ref6.zone,_ref6$modal=_ref6.modal,modal=_ref6$modal===undefined?true:_ref6$modal;_classCallCheck(this,Form2);var _this43=_possibleConstructorReturn(this,(Form2.__proto__||Object.getPrototypeOf(Form2)).call(this,intentId));_this43.onSubmit=function _callee100(){return regeneratorRuntime.async(function _callee100$(_context102){while(1){switch(_context102.prev=_context102.next){case 0:case'end':return _context102.stop();}}},null,_this44);};_this43.onCancel=function _callee101(){return regeneratorRuntime.async(function _callee101$(_context103){while(1){switch(_context103.prev=_context103.next){case 0:case'end':return _context103.stop();}}},null,_this44);};_this43.onClose=function _callee102(){return regeneratorRuntime.async(function _callee102$(_context104){while(1){switch(_context104.prev=_context104.next){case 0:case'end':return _context104.stop();}}},null,_this44);};_this43.title=title;_this43.description=description;_this43.allowMinimize=allowMinimize;_this43.allowClose=allowClose;_this43.minimizeOnConfirm=minimizeOnConfirm;_this43.confirm=confirm;_this43.cancel=cancel;_this43.icon=icon;_this43.modal=modal;_this43.readOnly=readOnly;_this43.allowEdit=allowEdit;_this43.zone=zone;_this43._fields=[];_this43._f={};return _this43;}_createClass(Form2,[{key:'message',value:function message(action,result){var parent=null;if(this._parent){parent=this._parent._intentId;}if(action){var r=result;if(action==='change'&&Array.isArray(r)){r={fields:result};}return{result:r,options:{parent:parent,formId:this.intentId,controlId:this.intentId,action:action}};}else{var fields=[];this._fields.forEach(function(field){var fieldMessage=field.message();if(fieldMessage){fields.push(fieldMessage);}});return{fields:fields,options:{parent:parent,formId:this.intentId,controlId:this.intentId,title:this.title,description:this.description,allowMinimize:this.allowMinimize,allowClose:this.allowClose,minimizeOnConfirm:this.minimizeOnConfirm,confirm:this.confirm,cancel:this.cancel,icon:this.icon,readOnly:this.readOnly,allowEdit:this.allowEdit,zone:this.zone,modal:this.modal}};}}},{key:'addFields',value:function addFields(fields){var _this45=this;if(Array.isArray(fields)){fields.forEach(function(field){_this45.addField(field);});}}},{key:'addField',value:function addField(field){if(field instanceof Form2Field||field instanceof Field){this._fields.push(field);this._f[field._intentId]=field;}else{state.addSystemErrorToStack(Error.getErrorMessageforCodeAndLang(28));}}},{key:'_callEvents',value:function _callEvents(state){return regeneratorRuntime.async(function _callEvents$(_context105){while(1){switch(_context105.prev=_context105.next){case 0:if(this._parent&&this._parent._intentId===state.currentControlId){state.currentControlId=this._parent._intentId;}else{state.currentControlId=this.intentId;}console.log('Started Form2 onResolution');if(!(state.messageFromUser.action===Form2.CONFIRM_FORM_ACTION())){_context105.next=7;break;}_context105.next=5;return regeneratorRuntime.awrap(this.onSubmit());case 5:_context105.next=18;break;case 7:if(!(state.messageFromUser.action===Form2.CANCEL_FORM_ACTION())){_context105.next=12;break;}_context105.next=10;return regeneratorRuntime.awrap(this.onCancel());case 10:_context105.next=18;break;case 12:if(!(state.messageFromUser.action===Form2.CLOSE_FORM_ACTION())){_context105.next=17;break;}_context105.next=15;return regeneratorRuntime.awrap(this.onClose());case 15:_context105.next=18;break;case 17:state.addSystemErrorToStack(29,Error.getErrorMessageforCodeAndLang(29));case 18:if(state.responsesArray.length===0){state.addSilentResponse();}case 19:case'end':return _context105.stop();}}},null,this);}},{key:'parent',set:function set(parent){this._parent=parent;}},{key:'formId',get:function get(){return this.intentId;}},{key:'fields',get:function get(){return this._fields;},set:function set(fields){this._fields=[];this.addFields(fields);}},{key:'f',get:function get(){return this._f;}},{key:'onMatching',get:function get(){var _this46=this;return function(state){var inputControlId=state.messageFromUser.controlId||state.messageFromUser.formId;return state.messageTypeFromUser===Form2.FORM_RESPONSE()&&!state.messageFromUser.currentField&&inputControlId===_this46.formId;};}},{key:'onResolution',get:function get(){var _this47=this;return function _callee103(state){return regeneratorRuntime.async(function _callee103$(_context106){while(1){switch(_context106.prev=_context106.next){case 0:_context106.next=2;return regeneratorRuntime.awrap(_this47._callEvents(state));case 2:case'end':return _context106.stop();}}},null,_this47);};}}]);return Form2;}(Intent);var FloorPlan=function(_Intent12){_inherits(FloorPlan,_Intent12);_createClass(FloorPlan,null,[{key:'FLOOR_PLAN_MESSAGE',value:function FLOOR_PLAN_MESSAGE(){return'floorplan';}},{key:'FLOOR_PLAN_RESPONSE_MESSAGE',value:function FLOOR_PLAN_RESPONSE_MESSAGE(){return'floorplan_response';}}]);function FloorPlan(intentId){var _this49=this;_classCallCheck(this,FloorPlan);var _this48=_possibleConstructorReturn(this,(FloorPlan.__proto__||Object.getPrototypeOf(FloorPlan)).call(this,intentId));_this48.onSelection=function _callee104(){return regeneratorRuntime.async(function _callee104$(_context107){while(1){switch(_context107.prev=_context107.next){case 0:case'end':return _context107.stop();}}},null,_this49);};return _this48;}_createClass(FloorPlan,[{key:'message',value:function message(){return{controlId:this.intentId};}},{key:'onMatching',get:function get(){return function(state){return state.messageTypeFromUser===FloorPlan.FLOOR_PLAN_RESPONSE_MESSAGE();};}},{key:'onResolution',get:function get(){var _this50=this;return function _callee105(state){return regeneratorRuntime.async(function _callee105$(_context108){while(1){switch(_context108.prev=_context108.next){case 0:state.currentControlId=_this50.intentId;console.log('Started Floor plan onResolution');_context108.next=4;return regeneratorRuntime.awrap(_this50.onSelection());case 4:if(state.responsesArray.length===0){state.addSilentResponse();}case 5:case'end':return _context108.stop();}}},null,_this50);};}}]);return FloorPlan;}(Intent);var Maps=function(_Intent13){_inherits(Maps,_Intent13);_createClass(Maps,null,[{key:'MAP_RESPONSE_MESSAGE',value:function MAP_RESPONSE_MESSAGE(){return'map_response';}},{key:'MAP_MESSAGE',value:function MAP_MESSAGE(){return'map';}}]);function Maps(intentId,_ref7){var _this52=this;var title=_ref7.title,type=_ref7.type,description=_ref7.description,_ref7$source=_ref7.source,source=_ref7$source===undefined?'mapbox':_ref7$source,_ref7$collapsableCard=_ref7.collapsableCards,collapsableCards=_ref7$collapsableCard===undefined?false:_ref7$collapsableCard,_ref7$adsSidebar=_ref7.adsSidebar,adsSidebar=_ref7$adsSidebar===undefined?false:_ref7$adsSidebar,_ref7$adsHeader=_ref7.adsHeader,adsHeader=_ref7$adsHeader===undefined?false:_ref7$adsHeader;_classCallCheck(this,Maps);var _this51=_possibleConstructorReturn(this,(Maps.__proto__||Object.getPrototypeOf(Maps)).call(this,intentId));_this51.onAction=function _callee106(){return regeneratorRuntime.async(function _callee106$(_context109){while(1){switch(_context109.prev=_context109.next){case 0:case'end':return _context109.stop();}}},null,_this52);};_this51.title=title;_this51.type=type;_this51.description=description;_this51._cards=[];_this51._polylines=[];_this51._markers=[];_this51._planeRoutes=[];_this51._source=source;_this51._collapsableCards=collapsableCards;_this51._adsSidebar=adsSidebar;_this51._adsHeader=adsHeader;_this51._region={latitude:0.1,longitude:0.1,zoom:2};return _this51;}_createClass(Maps,[{key:'message',value:function message(){return{geoJsonUrl:this._geoJsonUrl,region:this._region,markers:this._markers,cards:this._cards,polylines:this._polylines,planeRoutes:this._planeRoutes,options:{mapId:this.intentId,controlId:this.intentId,title:this.title,description:this.description,type:this.type,source:this._source,collapsableCards:this._collapsableCards,adsSidebar:this._adsSidebar,adsHeader:this._adsHeader}};}},{key:'addCard',value:function addCard(card){this._cards.push(card);}},{key:'addCards',value:function addCards(cards){this._cards=cards;}},{key:'addMarker',value:function addMarker(marker){var index=-1;for(var i=0;i<this._markers.length;i++){if(this._markers[i].id===marker.id){index=i;}}if(index>-1){this._markers.splice(index,1);}this._markers.push(marker);}},{key:'addRoute',value:function addRoute(route){this._polylines.push(route);}},{key:'addPlaneRoute',value:function addPlaneRoute(route){var index=-1;for(var i=0;i<this._planeRoutes.length;i++){if(this._planeRoutes[i].id===route.id){index=i;}}if(index>-1){this._markers.splice(index,1);}this._planeRoutes.push(route);}},{key:'mapId',get:function get(){return this.intentId;}},{key:'region',get:function get(){return this._region;},set:function set(_ref8){var _ref8$latitude=_ref8.latitude,latitude=_ref8$latitude===undefined?0.1:_ref8$latitude,_ref8$longitude=_ref8.longitude,longitude=_ref8$longitude===undefined?0.1:_ref8$longitude,_ref8$zoom=_ref8.zoom,zoom=_ref8$zoom===undefined?2:_ref8$zoom,fitBounds=_ref8.fitBounds;this._region={latitude:latitude,longitude:longitude,zoom:zoom,fitBounds:fitBounds};}},{key:'geoJsonUrl',set:function set(url){this._geoJsonUrl=url;},get:function get(){return this._geoJsonUrl;}},{key:'routes',set:function set(routes){this._polylines=routes;}},{key:'onMatching',get:function get(){return function(state){return state.messageTypeFromUser===Maps.MAP_RESPONSE_MESSAGE();};}},{key:'onResolution',get:function get(){var _this53=this;return function _callee107(state){return regeneratorRuntime.async(function _callee107$(_context110){while(1){switch(_context110.prev=_context110.next){case 0:state.currentControlId=_this53.intentId;console.log('Started Maps onResolution');_context110.next=4;return regeneratorRuntime.awrap(_this53.onAction());case 4:if(state.responsesArray.length===0){state.addSilentResponse();}case 5:case'end':return _context110.stop();}}},null,_this53);};}}]);return Maps;}(Intent);var Card=function(_Intent14){_inherits(Card,_Intent14);function Card(intentId,_ref9){var title=_ref9.title,pictureUrl=_ref9.pictureUrl,defaultPictureUrl=_ref9.defaultPictureUrl,description=_ref9.description,html=_ref9.html,data=_ref9.data,url=_ref9.url,action=_ref9.action;_classCallCheck(this,Card);var _this54=_possibleConstructorReturn(this,(Card.__proto__||Object.getPrototypeOf(Card)).call(this,intentId));_this54.onAction=function(){};_this54.title=title;_this54.pictureUrl=pictureUrl;_this54.defaultPictureUrl=defaultPictureUrl;_this54.description=description;_this54.html=html;_this54.data=data;_this54.url=url;_this54.action=action;_this54.disableHistoryLogging();return _this54;}_createClass(Card,[{key:'message',value:function message(){return{id:this.intentId,title:this.title,pictureUrl:this.pictureUrl,defaultPictureUrl:this.defaultPictureUrl,description:this.description,html:this.html,data:this.data,url:this.url,action:this.action};}},{key:'id',get:function get(){return this.intentId;}},{key:'onMatching',get:function get(){var _this55=this;return function(state){return state.messageTypeFromUser===Cards.CARD_RESPONSE_ACTION()&&state.messageFromUser===_this55.id;};}},{key:'onResolution',get:function get(){var _this56=this;return function _callee108(state){return regeneratorRuntime.async(function _callee108$(_context111){while(1){switch(_context111.prev=_context111.next){case 0:state.currentControlId=_this56.intentId;console.log('Started Card onResolution');_context111.next=4;return regeneratorRuntime.awrap(_this56.onAction());case 4:if(state.responsesArray.length===0){console.log('Adding Card silent response');state.addSilentResponse();}case 5:case'end':return _context111.stop();}}},null,_this56);};}}]);return Card;}(Intent);var Cards=function(_Intent15){_inherits(Cards,_Intent15);_createClass(Cards,null,[{key:'CARD_RESPONSE_ACTION',value:function CARD_RESPONSE_ACTION(){return'card_response';}}]);function Cards(intentId,_ref10){var type=_ref10.type,size=_ref10.size,_ref10$popup=_ref10.popup,popup=_ref10$popup===undefined?true:_ref10$popup,grid=_ref10.grid;_classCallCheck(this,Cards);var _this57=_possibleConstructorReturn(this,(Cards.__proto__||Object.getPrototypeOf(Cards)).call(this,intentId));_this57.type=type;_this57.size=size;_this57.grid=grid;_this57.popup=popup;_this57._cards=[];return _this57;}_createClass(Cards,[{key:'message',value:function message(){var cards=[];this._cards.forEach(function(card){return cards.push(card.message());});return{cards:cards,options:{type:this.type,size:this.size,grid:this.grid,popup:this.popup}};}},{key:'addCards',value:function addCards(cards){var _this58=this;if(Array.isArray(cards)){cards.forEach(function(card){_this58.addCard(card);});}}},{key:'addCard',value:function addCard(card){if(card instanceof Card){this._cards.push(card);}else{state.addSystemErrorToStack(Error.getErrorMessageforCodeAndLang(28));}}},{key:'id',get:function get(){return this.intentId;}},{key:'cards',get:function get(){return this._cards;}},{key:'onMatching',get:function get(){return function(state){return false;};}}]);return Cards;}(Intent);var TrackingView=function(_Intent16){_inherits(TrackingView,_Intent16);_createClass(TrackingView,null,[{key:'CLOSE_VIEW_ACTION',value:function CLOSE_VIEW_ACTION(){return'close';}},{key:'REFRESH_VIEW_ACTION',value:function REFRESH_VIEW_ACTION(){return'refresh';}},{key:'TRACKING_VIEW_RESPONSE',value:function TRACKING_VIEW_RESPONSE(){return'tracking_view_response';}}]);function TrackingView(intentId,_ref11){var title=_ref11.title,icon=_ref11.icon,allowMinimize=_ref11.allowMinimize,allowClose=_ref11.allowClose,notification=_ref11.notification;_classCallCheck(this,TrackingView);var _this59=_possibleConstructorReturn(this,(TrackingView.__proto__||Object.getPrototypeOf(TrackingView)).call(this,intentId));_this59.onClose=function(){};_this59.onRefresh=function(){};_this59.title=title;_this59.icon=icon;_this59.allowMinimize=allowMinimize;_this59.allowClose=allowClose;_this59._origin={};_this59._destination={};_this59._currentPosition={};_this59._altitudeArray=[];_this59._speedArray=[];_this59._notification=notification;_this59._cancelled=false;return _this59;}_createClass(TrackingView,[{key:'message',value:function message(){return{options:{controlId:this.intentId,title:this.title,icon:this.icon,allowMinimize:this.allowMinimize,allowClose:this.allowClose,notification:this._notification,cancelled:this._cancelled},data:{tracking:{origin:this._origin,destination:this._destination,currentPosition:this._currentPosition},charts:{altitude:this._altitudeArray,speed:this._speedArray}}};}},{key:'addOrigin',value:function addOrigin(_ref12){var title=_ref12.title,code=_ref12.code,place=_ref12.place,timeStamp=_ref12.timeStamp;this._origin={title:title,code:code,place:place,timeStamp:timeStamp};}},{key:'addDestination',value:function addDestination(_ref13){var title=_ref13.title,code=_ref13.code,place=_ref13.place,timeStamp=_ref13.timeStamp;this._destination={title:title,code:code,place:place,timeStamp:timeStamp};}},{key:'addCurrentPosition',value:function addCurrentPosition(_ref14){var totalTripTimeEstimation=_ref14.totalTripTimeEstimation,totalTimeElapsed=_ref14.totalTimeElapsed,currentAltitude=_ref14.currentAltitude,currentSpeed=_ref14.currentSpeed;this._currentPosition={totalTripTimeEstimation:totalTripTimeEstimation,totalTimeElapsed:totalTimeElapsed,currentAltitude:currentAltitude,currentSpeed:currentSpeed};}},{key:'addAltitude',value:function addAltitude(){}},{key:'addSpeed',value:function addSpeed(){}},{key:'notification',set:function set(notification){this._notification=notification;}},{key:'cancelled',set:function set(cancelled){this._cancelled=cancelled;}},{key:'onMatching',get:function get(){var _this60=this;return function(state){return state.messageTypeFromUser===TrackingView.TRACKING_VIEW_RESPONSE()&&(state.messageFromUser.controlId===_this60.intentId||state.messageFromUser.controlId===11111);};}},{key:'onResolution',get:function get(){var _this61=this;return function _callee109(state){return regeneratorRuntime.async(function _callee109$(_context112){while(1){switch(_context112.prev=_context112.next){case 0:state.currentControlId=_this61.intentId;console.log('Started onResolution');if(!(state.messageFromUser.action===TrackingView.CLOSE_VIEW_ACTION())){_context112.next=7;break;}_context112.next=5;return regeneratorRuntime.awrap(_this61.onClose());case 5:_context112.next=13;break;case 7:if(!(state.messageFromUser.action===TrackingView.REFRESH_VIEW_ACTION())){_context112.next=12;break;}_context112.next=10;return regeneratorRuntime.awrap(_this61.onRefresh());case 10:_context112.next=13;break;case 12:state.addSystemErrorToStack(Error.getErrorMessageforCodeAndLang(28));case 13:if(state.responsesArray.length===0){state.addSilentResponse();}case 14:case'end':return _context112.stop();}}},null,_this61);};}}]);return TrackingView;}(Intent);var LocationServices=function(){_createClass(LocationServices,null,[{key:'START_TRACKING',value:function START_TRACKING(){return'startTracking';}},{key:'STOP_TRACKING',value:function STOP_TRACKING(){return'stopTracking';}},{key:'VESSEL',value:function VESSEL(){return'vessel';}},{key:'FLIGHT',value:function FLIGHT(){return'flight';}},{key:'TRACKER_BOT',value:function TRACKER_BOT(){return'tracker-bot';}}]);function LocationServices(botState){_classCallCheck(this,LocationServices);this._botState=botState;this._=botState._;this._turf=botState.context.turf;if(this._botState.client===State.MOBILECLIENT()&&this._botState.location===Intent.EDGE()){this.offlineMaps=this._botState.context.getCapability('OfflineMap');}}_createClass(LocationServices,[{key:'getDeviceLocation',value:function getDeviceLocation(){return this._botState.context.getCapability('DeviceLocation').getDeviceLocation();}},{key:'getLocationWithQuery',value:function getLocationWithQuery(query){var stringQuery,_response;return regeneratorRuntime.async(function getLocationWithQuery$(_context113){while(1){switch(_context113.prev=_context113.next){case 0:_context113.prev=0;stringQuery=query;if(typeof stringQuery!=='string'){stringQuery=JSON.stringify(query);}_context113.next=5;return regeneratorRuntime.awrap(this._botState.api.callService('Geocode',{queryParams:'q='+stringQuery}));case 5:_response=_context113.sent;if(_response){_context113.next=8;break;}return _context113.abrupt('return',[]);case 8:return _context113.abrupt('return',JSON.parse(_response));case 11:_context113.prev=11;_context113.t0=_context113['catch'](0);this._botState.developer.log({message:'Getting error while calling Geocode: '+_context113.t0.message});return _context113.abrupt('return',{error:'err'});case 15:case'end':return _context113.stop();}}},null,this,[[0,11]]);}},{key:'startLocationTracking',value:function startLocationTracking(){var precision=arguments.length>0&&arguments[0]!==undefined?arguments[0]:5;var heartbeatInterval=arguments.length>1&&arguments[1]!==undefined?arguments[1]:180;return this._botState.context.getCapability('LocationTracker').start_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId},precision,heartbeatInterval);}},{key:'stopLocationTracking',value:function stopLocationTracking(){return this._botState.context.getCapability('LocationTracker').stop_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId});}},{key:'progessListener',value:function progessListener(){}},{key:'errorListener',value:function errorListener(){}},{key:'saveMap',value:function saveMap(name,neBound,swBound){var minZoom=arguments.length>3&&arguments[3]!==undefined?arguments[3]:12;var maxZoom=arguments.length>4&&arguments[4]!==undefined?arguments[4]:16;var progressListener=arguments.length>5&&arguments[5]!==undefined?arguments[5]:this.progessListener;var errorListener=arguments.length>6&&arguments[6]!==undefined?arguments[6]:this.errorListener;this._botState._maps.push(name);this.offlineMaps.saveMap(name,neBound,swBound,minZoom,maxZoom,progressListener,errorListener);}},{key:'deleteMap',value:function deleteMap(name){var index=this._botState.R.findIndex(name)(this._botState._maps);this._botState._maps.splice(index,1);this.offlineMaps.deleteMap(name);}},{key:'startTracking',value:function startTracking(assetType,assetDetails,schedule,intentId){var trackingSessionId,messageToTracker;return regeneratorRuntime.async(function startTracking$(_context114){while(1){switch(_context114.prev=_context114.next){case 0:trackingSessionId=this._botState.getUniqueId();messageToTracker={intentId:LocationServices.START_TRACKING(),jobId:trackingSessionId,assetType:assetType,assetDetails:assetDetails};if(schedule){messageToTracker.repeats=schedule;}if(intentId){messageToTracker.respondsTo={userId:this._botState.user.userId,botId:this._botState.conversation.bot,userDomain:this._botState.conversation.userDomain,intentId:intentId};}_context114.next=6;return regeneratorRuntime.awrap(this._botState.notification.sendBroadcastNotificationToBot(LocationServices.TRACKER_BOT(),this._botState.conversation.userDomain,MessageTypes.BOT_TO_BOT(),messageToTracker));case 6:return _context114.abrupt('return',trackingSessionId);case 7:case'end':return _context114.stop();}}},null,this);}},{key:'startTrackingVessel',value:function startTrackingVessel(assetDetails,schedule,intentId){return this.startTracking(LocationServices.VESSEL(),assetDetails,schedule,intentId);}},{key:'startTrackingFlight',value:function startTrackingFlight(assetDetails,schedule,intentId){return this.startTracking(LocationServices.FLIGHT(),assetDetails,schedule,intentId);}},{key:'stopTracking',value:function stopTracking(trackingSessionId){}},{key:'getLatestKnownLocation',value:function getLatestKnownLocation(asset,trackingSessionId){var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'getLatestAssetLocation',assetId:asset,sessionId:trackingSessionId,userId:this._botState.user.userId,conversation:this._botState.conversation};return this._botState.callCapability(params);}},{key:'getLocation',value:function getLocation(asset,trackingSessionId,from,to){var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'getAssetLocationForDuration',assetId:asset,sessionId:trackingSessionId,from:from,to:to,userId:this._botState.user.userId,conversation:this._botState.conversation};return this._botState.callCapability(params);}},{key:'getLocationWithPagination',value:function getLocationWithPagination(asset,trackingSessionId){var pageSize=arguments.length>2&&arguments[2]!==undefined?arguments[2]:50;var last=arguments[3];var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'getAssetLocationsWithPagination',assetId:asset,sessionId:trackingSessionId,pageSize:pageSize,userId:this._botState.user.userId,conversation:this._botState.conversation};if(last){params.last=last;}return this._botState.callCapability(params);}},{key:'storeNewLocation',value:function storeNewLocation(trackingSessionId,assetId,assetDetails,createdOn){var params={capability:'AssetTrackerCapability',capabilityFileName:'assetTrackerCapability',action:'addNewLocation',assetId:assetId,sessionId:trackingSessionId,details:assetDetails,userId:this._botState.user.userId,conversation:this._botState.conversation};if(createdOn){params.createdOn=createdOn;}return this._botState.callCapability(params);}},{key:'getWeatherOnLocation',value:function getWeatherOnLocation(latitude,longitude){var location,WEATHER_SERVICE,_response2;return regeneratorRuntime.async(function getWeatherOnLocation$(_context115){while(1){switch(_context115.prev=_context115.next){case 0:location=latitude+','+longitude;WEATHER_SERVICE='MaritimeWeather';_context115.prev=2;_response2=this._botState.api.callService(WEATHER_SERVICE,{queryParams:'q='+location});return _context115.abrupt('return',_response2);case 7:_context115.prev=7;_context115.t0=_context115['catch'](2);d.log({message:'Getting error while calling WEATHER_SERVICE '+JSON.stringify(_context115.t0)});return _context115.abrupt('return',{error:'err'});case 11:case'end':return _context115.stop();}}},null,this,[[2,7]]);}},{key:'getPolygonsThatContainsLocation',value:function getPolygonsThatContainsLocation(location,polygonList){var _this62=this;console.log('location: ',location);var foundPolygons=[];try{this._.forEach(polygonList,function(poly){var polygon=_this62._turf.polygon(poly.coordinates);if(_this62._turf.booleanPointInPolygon(location,polygon)){foundPolygons.push(poly);}});return foundPolygons;}catch(err){throw err;}}}]);return LocationServices;}();var Sensors=function(){function Sensors(botState){_classCallCheck(this,Sensors);this._botState=botState;this._=botState._;this.R=botState.R;}_createClass(Sensors,[{key:'startMotionDetection',value:function startMotionDetection(frequency){this._botState.context.getCapability('Accelerometer').startUpdates(this._botState.context.botManifest.botId,this._botState.conversationId,frequency);}},{key:'stopMotionDetection',value:function stopMotionDetection(){this._botState.context.getCapability('Accelerometer').stopUpdates(this._botState.context.botManifest.botId,this._botState.conversationId);}}]);return Sensors;}();var TrackingServices=function(){function TrackingServices(botState){_classCallCheck(this,TrackingServices);this._botState=botState;this._=botState._;}_createClass(TrackingServices,[{key:'startTracking',value:function startTracking(){return this._botState.context.getCapability('LocationTracker').start_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId});}},{key:'stopTracking',value:function stopTracking(){return this._botState.context.getCapability('LocationTracker').stop_tracking({botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId});}}]);return TrackingServices;}();var Security=function(){function Security(botState){_classCallCheck(this,Security);this._botState=botState;this._=botState._;this._frontmlib=botState.frontmlib;}_createClass(Security,[{key:'createNewVerificationCode',value:function createNewVerificationCode(role,customAction,numberOfLicenses,autoInstallBotIds){var verificationCode,newCode;return regeneratorRuntime.async(function createNewVerificationCode$(_context116){while(1){switch(_context116.prev=_context116.next){case 0:verificationCode=this._botState.UUID().substr(0,10);if(this._.isUndefined(autoInstallBotIds)){autoInstallBotIds=[];}if(!this._.isArray(autoInstallBotIds)){autoInstallBotIds=[autoInstallBotIds];}autoInstallBotIds.push(this._botState.conversation.bot);newCode={codeUsage:{existing:0},domain:this._botState.conversation.userDomain,role:role,verificationCode:verificationCode,customAction:customAction,botsToInstall:autoInstallBotIds};if(numberOfLicenses>0){newCode.codeUsage.maximum=numberOfLicenses;}console.log('New verification code being created',newCode);_context116.prev=7;_context116.next=10;return regeneratorRuntime.awrap(this._frontmlib.dbPutItem('DomainVerification',newCode));case 10:console.log('Verification code created',newCode);return _context116.abrupt('return',verificationCode);case 14:_context116.prev=14;_context116.t0=_context116['catch'](7);console.log('Unable to create verification code',_context116.t0);return _context116.abrupt('return',null);case 18:case'end':return _context116.stop();}}},null,this,[[7,14]]);}},{key:'getVerificationCode',value:function getVerificationCode(role){var verificationCodeRow;return regeneratorRuntime.async(function getVerificationCode$(_context117){while(1){switch(_context117.prev=_context117.next){case 0:_context117.prev=0;_context117.next=3;return regeneratorRuntime.awrap(this._frontmlib.dbGetWithIndex('DomainVerification','domain-role-index','#domain = :domain AND #role = :role',{':domain':this._botState.conversation.userDomain,':role':role},null,{'#domain':'domain','#role':'role'}));case 3:verificationCodeRow=_context117.sent;return _context117.abrupt('return',verificationCodeRow.Items[0].verificationCode);case 7:_context117.prev=7;_context117.t0=_context117['catch'](0);console.log('Unable to get verification code',_context117.t0);return _context117.abrupt('return',null);case 11:case'end':return _context117.stop();}}},null,this,[[0,7]]);}},{key:'encryptData',value:function encryptData(data){var key;return regeneratorRuntime.async(function encryptData$(_context118){while(1){switch(_context118.prev=_context118.next){case 0:_context118.prev=0;_context118.next=3;return regeneratorRuntime.awrap(this._botState.cc.getConfigurationForKey('encryptionKey'));case 3:key=_context118.sent;return _context118.abrupt('return',this._frontmlib.encryptData(key,data));case 7:_context118.prev=7;_context118.t0=_context118['catch'](0);this._botState.addSystemErrorToStack(31,_context118.t0.message);case 10:case'end':return _context118.stop();}}},null,this,[[0,7]]);}},{key:'decryptData',value:function decryptData(data){return regeneratorRuntime.async(function decryptData$(_context119){while(1){switch(_context119.prev=_context119.next){case 0:_context119.prev=0;return _context119.abrupt('return',this._frontmlib.decryptData(data));case 4:_context119.prev=4;_context119.t0=_context119['catch'](0);this._botState.addSystemErrorToStack(32,_context119.t0.message);case 7:case'end':return _context119.stop();}}},null,this,[[0,4]]);}}]);return Security;}();var LogEntrytype=function(){function LogEntrytype(){_classCallCheck(this,LogEntrytype);}_createClass(LogEntrytype,null,[{key:'SYSTEM_ERROR',value:function SYSTEM_ERROR(){return'SYSTEM_ERROR';}},{key:'USER_ERROR',value:function USER_ERROR(){return'USER_ERROR';}},{key:'WARNING',value:function WARNING(){return'WARNING';}},{key:'INFO',value:function INFO(){return'INFO';}},{key:'DEBUG',value:function DEBUG(){return'DEBUG';}},{key:'LOG',value:function LOG(){return'LOG';}},{key:'PERF',value:function PERF(){return'PERF';}}]);return LogEntrytype;}();var SearchBox=function(){function SearchBox(botState,theId,name,selectionType){_classCallCheck(this,SearchBox);this['_botState']=botState;this['_']=botState._;this['_id']=theId;this['name']=name;this['selectionType']=selectionType;}_createClass(SearchBox,[{key:'getMessageWith',value:function getMessageWith(action,results){if(results){return{action:action,results:results,selectionType:this.selectionType};}else{return{action:'open',placeholder:this.name,selectionType:this.selectionType};}}},{key:'id',get:function get(){return this._id;}},{key:'onSearch',set:function set(onSearchBlock){this._onSearch=onSearchBlock;},get:function get(){return this._onSearch;}},{key:'onCompletion',set:function set(onCompletionBlock){this._onCompletion=onCompletionBlock;},get:function get(){return this._onCompletion;}},{key:'onCancel',set:function set(onCancelBlock){this._onCancel=onCancelBlock;},get:function get(){return this._onCancel;}}]);return SearchBox;}();var Companies=function(){function Companies(botState){_classCallCheck(this,Companies);this['_botState']=botState;this['_']=botState._;}_createClass(Companies,[{key:'callCreateCompanyCapability',value:function callCreateCompanyCapability(params){var capabilities=this._botState.context.capabilities.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];return capabilityModule.execute(params,this._botState.context.capabilities);}},{key:'createChildCompany',value:function createChildCompany(_ref15){var _this63=this;var companyAddress=_ref15.companyAddress,companyName=_ref15.companyName,phoneNumbers=_ref15.phoneNumbers,contractDuration=_ref15.contractDuration,account=_ref15.account;var companyId=this._botState.getUniqueId();var params={capability:'CompanyCapability',capabilityFileName:'companyCapability',sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation,action:'createCompany',company:{companyAddress:companyAddress,companyId:companyId,companyName:companyName,phoneNumbers:phoneNumbers,contractDuration:contractDuration,account:account},companyDomain:{userDomain:this._botState.currentUserDomain}};return this.callCreateCompanyCapability(params).then(function(response){_this63._botState.developer.info({message:'After created company',data:response});if(_this63._.get(response,'status')){return{status:true,companyId:companyId};}else{return{status:false,errorMessage:_this63._.get(_this63._botState._.compact(response),'errorMessage','There was a problem creating the company')};}});}},{key:'addOfferToCompany',value:function addOfferToCompany(_ref16){var _this64=this;var companyId=_ref16.companyId,verificationCode=_ref16.verificationCode,validFrom=_ref16.validFrom,validTo=_ref16.validTo,maxUsersPerLicense=_ref16.maxUsersPerLicense,offers=_ref16.offers,offerType=_ref16.offerType,description=_ref16.description,role=_ref16.role;var params={capability:'CompanyCapability',capabilityFileName:'companyCapability',sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation,action:'createCompany',company:{companyId:companyId},companyDomain:{userDomain:this._botState.currentUserDomain},userOffers:[{verificationCode:verificationCode,offerType:offerType,description:description,role:role,valid_from:validFrom,valid_to:validTo,codeUsage:{maximum:maxUsersPerLicense},offers:offers}]};return this.callCreateCompanyCapability(params).then(function(response){_this64._botState.developer.info({message:'After added offer to company',data:response});if(_this64._.get(response,'status')){return{status:true,companyId:companyId};}else{return{status:false,errorMessage:_this64._.get(_this64._botState._.compact(response),'errorMessage','There was a problem creating the company')};}});}}]);return Companies;}();var Marketplace=function(){function Marketplace(botState){_classCallCheck(this,Marketplace);this['_botState']=botState;this['_']=botState._;}_createClass(Marketplace,[{key:'validateActivationCode',value:function validateActivationCode(code){var params={capability:'SubscribeDomainRole',capabilityFileName:'subscribeDomainRole',verificationCode:code,sync:true,userId:this._botState.user.userId,userEmail:this._botState.user.userEmail,conversation:this._botState.conversation};return this._botState.callCapability(params);}},{key:'activateDomainsOnEdge',value:function activateDomainsOnEdge(domains){return this._botState.context.getCapability('authContext').setDomains(domains,this._botState.context);}},{key:'autoInstallAllBotsOnEdge',value:function autoInstallAllBotsOnEdge(){return this._botState.context.getCapability('RemoteBotInstall').syncronizeBots();}}]);return Marketplace;}();var UnitTest=function(_Intent17){_inherits(UnitTest,_Intent17);_createClass(UnitTest,null,[{key:'RUN_COMMAND',value:function RUN_COMMAND(){return'@@run';}},{key:'TEST_RUN_MSG',value:function TEST_RUN_MSG(){return'Test request submitted successfully';}},{key:'VERIFICATION_RUN_MSG',value:function VERIFICATION_RUN_MSG(){return'Verification process finished';}},{key:'TEST_CASES_FIELD',value:function TEST_CASES_FIELD(){return'testCases';}},{key:'CURRENT_TEST_FIELD',value:function CURRENT_TEST_FIELD(){return'currentTest';}}]);function UnitTest(intentId){var _this66=this;_classCallCheck(this,UnitTest);var _this65=_possibleConstructorReturn(this,(UnitTest.__proto__||Object.getPrototypeOf(UnitTest)).call(this,intentId));_this65.onTest=function _callee110(){return regeneratorRuntime.async(function _callee110$(_context120){while(1){switch(_context120.prev=_context120.next){case 0:case'end':return _context120.stop();}}},null,_this66);};_this65.onVerification=function _callee111(){return regeneratorRuntime.async(function _callee111$(_context121){while(1){switch(_context121.prev=_context121.next){case 0:case'end':return _context121.stop();}}},null,_this66);};return _this65;}_createClass(UnitTest,[{key:'unitTestIntent',get:function get(){return true;}},{key:'onMatching',get:function get(){var _this67=this;return function(state){return state.messageTypeFromUser==='string'&&state.messageFromUser.substring(0,5)===UnitTest.RUN_COMMAND()&&state.R.toLower(state.messageFromUser.substring(6,state.messageFromUser.length))===state.R.toLower(_this67.intentId);};}},{key:'onResolution',get:function get(){var _this68=this;return function _callee112(state){return regeneratorRuntime.async(function _callee112$(_context122){while(1){switch(_context122.prev=_context122.next){case 0:console.log('Running onTest');_context122.next=3;return regeneratorRuntime.awrap(_this68.onTest());case 3:if(state.responsesArray.length===0){state.addStringResponse(UnitTest.TEST_RUN_MSG());}case 4:case'end':return _context122.stop();}}},null,_this68);};}}]);return UnitTest;}(Intent);var Developer=function(){_createClass(Developer,null,[{key:'DEBUG',value:function DEBUG(){return'Debug';}},{key:'DEV',value:function DEV(){return'Dev';}},{key:'PROD',value:function PROD(){return'Prod';}},{key:'TEST',value:function TEST(){return'Test';}}]);function Developer(botState){_classCallCheck(this,Developer);this['_botState']=botState;this['_']=botState._;this['R']=botState.R;this['_debugMode']=false;this['_command']=[];this['_runProfile']=Developer.PROD();}_createClass(Developer,[{key:'callBotPublisher',value:function callBotPublisher(newBot,action){var _this69=this;var params={action:action,conversation:this._botState.conversation,botMetadata:newBot,userId:this._botState.user.userId};return callLambda('BotPublisher',params,this._botState.aws).then(function(response){var payload=JSON.parse(response.Payload);if(payload.error!==0){if(payload.error===9){_this69._botState.addSystemErrorToStack(9);}else{_this69._botState.addSystemErrorToStack(7,payload.error);}}return payload.error;});}},{key:'publishBot',value:function publishBot(newBot){return this.callBotPublisher(newBot,'publishNewBot');}},{key:'updateBot',value:function updateBot(newBot){return this.callBotPublisher(newBot,'updateBot');}},{key:'deleteBotFromCatalogue',value:function deleteBotFromCatalogue(newBot){return this.callBotPublisher(newBot,'deleteBot');}},{key:'publishApp',value:function publishApp(newBot){return this.callBotPublisher(newBot,'publishNewBotInNewFormat');}},{key:'updateApp',value:function updateApp(newBot){return this.callBotPublisher(newBot,'updateBotInNewFormat');}},{key:'deleteAppFromCatalogue',value:function deleteAppFromCatalogue(newBot){return this.callBotPublisher(newBot,'deleteBotInNewFormat');}},{key:'setDebugActive',value:function setDebugActive(){this.log({message:'Activating debug mode'});this._debugMode=true;}},{key:'validDeveloperDomains',value:function validDeveloperDomains(){var _this70=this;var domains=[];if(this._botState.conversation.userDomain==='frontmai'){this._botState._.each(this._botState.userDomains,function(userDomain){var index=_this70._botState._.findIndex(userDomain.roles,function(role){return role='developer';});if(index>-1){domains.push(userDomain.domain);}});}else{domains.push(this._botState.conversation.userDomain);}return domains;}},{key:'isDeveloperIntent',value:function isDeveloperIntent(){if(typeof this._botState.messageFromUser==='string'&&this._botState.messageFromUser.substring(0,2)==='@@'&&this._botState.messageFromUser.substring(0,5)!=='@@run'){return true;}return false;}},{key:'identifyDeveloperIntent',value:function identifyDeveloperIntent(){if(typeof this._botState.messageFromUser==='string'){var command=this.R.toLower(this._botState.messageFromUser);switch(command){case'@@reset conversation':return'_dev_reset_conversation';case'@@show log':return'_dev_show_log';case'@@clear log':return'_dev_clearLog';case'@@debug on':return'_dev_debug_switch_on';case'@@debug off':return'_dev_debug_switch_off';case'@@inspect all':return'_dev_inspect_all';case'@@inspect nlp':return'_dev_inspect_nlp';case'@@inspect history':return'_dev_inspect_history';case'@@show performance':return'_dev_show_performance';case'@@email performance':return'_dev_backend_email_performance';case'@@inspect messages':return'_dev_inspect_messages';case'@@inspect old fields':return'_dev_inspect_old';default:if(this.R.includes('@@inspect state',command)){return'_dev_inspect_state';}else if(this.R.includes('@@inspect',command)){return'_dev_inspect';}}}return null;}},{key:'badCommandSyntax',value:function badCommandSyntax(){this._botState.addActiveIntent(Intent.NO_INTENT());}},{key:'debug',value:function debug(_ref17){var message=_ref17.message,errorCode=_ref17.errorCode,data=_ref17.data,more=_ref17.more;console.log('In debug');if(this.runProfile===Developer.DEBUG()){this.addEntryInES({level:LogEntrytype.DEBUG(),message:message,errorCode:errorCode,data:data,more:more});}}},{key:'log',value:function log(_ref18){var message=_ref18.message,errorCode=_ref18.errorCode,data=_ref18.data,more=_ref18.more;if(this.runProfile===Developer.DEV()){this.addEntryInES({level:LogEntrytype.LOG(),message:message,errorCode:errorCode,data:data,more:more});}}},{key:'info',value:function info(_ref19){var message=_ref19.message,errorCode=_ref19.errorCode,data=_ref19.data,more=_ref19.more;if(this.runProfile===Developer.DEBUG()){this.addEntryInES({level:LogEntrytype.INFO(),message:message,errorCode:errorCode,data:data,more:more});}}},{key:'warning',value:function warning(_ref20){var message=_ref20.message,errorCode=_ref20.errorCode,data=_ref20.data,more=_ref20.more;this.addEntryInES({level:LogEntrytype.WARNING(),message:message,errorCode:errorCode,data:data,more:more});}},{key:'perf',value:function perf(_ref21){var message=_ref21.message,errorCode=_ref21.errorCode,data=_ref21.data,more=_ref21.more;if(this.runProfile===Developer.DEBUG()){this.addEntryInES({level:LogEntrytype.PERF(),message:message,errorCode:errorCode,data:data,more:more});}}},{key:'systemError',value:function systemError(_ref22){var message=_ref22.message,errorCode=_ref22.errorCode,data=_ref22.data,more=_ref22.more;this.addEntryInES({level:LogEntrytype.SYSTEM_ERROR(),message:message,errorCode:errorCode,data:data,more:more});}},{key:'userError',value:function userError(_ref23){var message=_ref23.message,errorCode=_ref23.errorCode,data=_ref23.data,more=_ref23.more;this.addEntryInES({level:LogEntrytype.USER_ERROR(),message:message,errorCode:errorCode,data:data,more:more});}},{key:'addEntryInES',value:function addEntryInES(_ref24){var level=_ref24.level,errorCode=_ref24.errorCode,message=_ref24.message,data=_ref24.data,more=_ref24.more;try{console.log('Adding log entry');console.log('Message '+this._botState.R.toString(message));if(data){console.log('Data '+this._botState.R.toString(data));}var activeIntent=void 0;if(this._botState.activeIntent!==''){activeIntent=this._botState.activeIntent;}var params={type:'USER',entry:{userDomain:this._botState.currentUserDomain,userId:this._botState.user.userId,userEmail:this._botState.user.userEmail,botId:this._botState.conversation.bot,conversationId:this._botState.conversationId,entity:'FAPP',intent:activeIntent,client:this._botState.client,location:this._botState.location,timestamp:Date.now(),level:level,errorCode:errorCode,message:message,data:!data||typeof data==='string'?data:JSON.stringify(data)}};if(more){params.entry=_extends({},params.entry,more);}if(this._botState.location===Intent.CLOUD()){try{var lambda=this._botState.frontmlib;lambda.invokeLambda('logger','Event',params);}catch(err){this._botState.context.log(params);}}else{this._botState.context.log(params);}}catch(err){this._botState.addSystemErrorToStack(26,'1 '+err.name+': '+err.message);}}},{key:'processCommand',value:function processCommand(command){switch(command){case'_dev_reset_conversation':{this.resetConversation();break;}case'_dev_show_log':{this.showLog();break;}case'_dev_clearLog':{this.clearLogCommand();break;}case'_dev_debug_switch_on':{this.debugSwitch(true);break;}case'_dev_debug_switch_off':{this.debugSwitch(false);break;}case'_dev_inspect':{this.inspectField();break;}case'_dev_inspect_all':{this.inspectAllFields();break;}case'_dev_show_performance':{this.showPerformance();break;}case'_dev_inspect_nlp':{this.inspectNLPFields();break;}case'_dev_inspect_state':{this.inspectStateField();break;}case'_dev_inspect_history':{this.inspectHistory();break;}case'_dev_backend_email_performance':{return this.emailPerformance();break;}case'_dev_inspect_messages':{return this.inspectMessages();break;}case'_dev_inspect_old':{return this.inspectOldFields();break;}default:break;}}},{key:'inspectField',value:function inspectField(){var fieldName=this.R.head(this.R.drop(1,this.R.split(' ')(this._botState.messageFromUser)));if(fieldName){var fieldContent=this.R.toString(this._.get(this._botState.fields,fieldName));if(fieldContent){this._botState.addStringResponse(fieldContent);return;}}this._botState.addStringResponse('Could not find '+fieldName);}},{key:'inspectAllFields',value:function inspectAllFields(){var fieldContent=this.R.toString(this._botState.fields);this._botState.addStringResponse(fieldContent);}},{key:'inspectOldFields',value:function inspectOldFields(){var fieldContent=this.R.toString(this._botState._oldFields);this._botState.addStringResponse(fieldContent);}},{key:'inspectNLPFields',value:function inspectNLPFields(){var fieldContent=this.R.toString(this._botState._lastNLPResults);this._botState.addStringResponse(fieldContent);}},{key:'inspectStateField',value:function inspectStateField(){this._botState.addStringResponse(this._botState.R.toString(this._botState.getAllProperties()));}},{key:'inspectHistory',value:function inspectHistory(){this._botState.addStringResponse(this._botState.R.toString(this._botState._intentHistory));}},{key:'inspectMessages',value:function inspectMessages(){this._botState.addStringResponse(this._botState.R.toString(this._botState._inputHistory));}},{key:'debugSwitch',value:function debugSwitch(mode){if(this._debugMode&&mode){this._botState.addStringResponse('Debug mode is already active');}else if(this._debugMode===mode){this._botState.addStringResponse('Debug mode is already inactive');}else{this._debugMode=mode;if(this._debugMode){this.log({message:'Debug mode set to active'});this._botState.addStringResponse('Debug mode activated');}else{this.log({message:'Debug mode set to inactive'});this._botState.addStringResponse('Debug mode deactivated');}}}},{key:'genericShowLogs',value:function genericShowLogs(options,rows){if(this._botState.client===State.WEBCLIENT()){this._botState.addResponse(this._botState.messageTypes.MESSAGE_TYPE_TABLE,{options:options,rows:rows});}else{this._botState.addResponse(this._botState.messageTypes.MESSAGE_TYPE_DATA_CARD,rows);}}},{key:'showLog',value:function showLog(){var _this71=this;var options={title:'Logged data',description:'App log data',columnNames:['date','type','message']};var rows=[];var rowIterator=function rowIterator(logEntry){var row={date:new Date(logEntry.dateTime),type:logEntry.entryType,message:logEntry.loggedMessage};if(_this71._botState.client===State.MOBILECLIENT()){row.title='Log Entry';}rows.push(row);};this.R.forEach(rowIterator,this.R.reverse(this._botState._log));this.genericShowLogs(options,rows);}},{key:'resetConversation',value:function resetConversation(){this._botState._activeIntent='';this._botState.requestIdsArray=[];this._botState._forms=[];this._botState._botFlows=[];this._botState._log=[];this._botState._intentHistory=[];this._botState._intentStats={};this._botState.lastGreetingTime=0;this._botState.errorStack=[];this._botState.fields={};this._botState.waitingCustomCap=0;this._botState.promptAlive='';this._botState._currentSearchBox='';this._botState._inSilence=false;this._botState._intentDurations=[];this._botState._lastNLPResults={};delete this._botState._maps;this._botState.clearSmartSuggestionsArray();this._botState.blockSuggestions=true;this._botState._silentIntent=false;this._botState.addStringResponse('The conversation has been reset');this._botState.sendMessage({intentId:'@@reset'});}},{key:'clearLogCommand',value:function clearLogCommand(){var _this72=this;return new Promise(function(resolve,reject){_this72._botState.addStringResponse('The log has been cleared');_this72._botState._log=[];resolve();});}},{key:'showPerformance',value:function showPerformance(){var _this73=this;console.log('Starting showing performance');var options={title:'Performance report',description:'Performance readings'};var rows=[];var intentIterator=function intentIterator(entry){var row={intent:entry.intent,event:entry.event,statTime:entry.startTime,duration:_this73.R.toString(entry.duration)};rows.push(row);};console.log('Before loop');this.R.forEach(intentIterator,this.R.reverse(this._botState._intentDurations));console.log('After loop '+this.R.toString(rows));this.genericShowLogs(options,rows);}},{key:'emailPerformance',value:function emailPerformance(){var _this74=this;var email='support@frontm.com';var title='Performance report';var body='See attached performance report from '+this._botState.user.userEmail;var attachment={name:'performance.json',content:this._botState._intentDurations};return this._botState.notification.sendEmail(email,title,body,attachment).then(function(){_this74._botState.addStringResponse('The email with the performance report has been sent');});}},{key:'logCurrentEventDurationWithStartTime',value:function logCurrentEventDurationWithStartTime(event,startTime,endTime){try{if(this._debugMode){var newEventLog={event:event,startTime:startTime,duration:endTime-startTime};this.perf({more:newEventLog});}}catch(error){return;}}},{key:'generateTestCaseStep',value:function generateTestCaseStep(_ref25){var message=_ref25.message;var params={state:this._botState.getAllProperties(),schedule:Date.now()};params.state.messageTypeFromUser=message.type;params.state.messageFromUser=message.content;params.state.client=this._botState.client;params.state.userName=this._botState.userName;params.state.lang='en';params.state.waitingCustomCap=0;params.state.messageFromUser.page=0;params.state.unitTestMode=true;return params;}},{key:'submitTest',value:function submitTest(_ref26){var testCases=_ref26.testCases;var currentTestCase,fullState,jobId,response;return regeneratorRuntime.async(function submitTest$(_context123){while(1){switch(_context123.prev=_context123.next){case 0:currentTestCase=testCases[0];this._botState.setField(UnitTest.TEST_CASES_FIELD(),testCases);this._botState.setField(UnitTest.CURRENT_TEST_FIELD(),this._botState.activeIntent);fullState=this.generateTestCaseStep({message:currentTestCase});jobId=this._botState.getUniqueId();console.log('Before submitting job');_context123.next=8;return regeneratorRuntime.awrap(this._botState.jobScheduler.addNewJob(this._botState.client,fullState,jobId,null));case 8:response=_context123.sent;console.log('Job submitted');if(!(response.jobId!==jobId)){_context123.next=14;break;}this._botState.addErrorToStack(1000,'Problems submitting test case');_context123.next=15;break;case 14:return _context123.abrupt('return',response.jobId);case 15:case'end':return _context123.stop();}}},null,this);}},{key:'runProfile',get:function get(){return this._runProfile;},set:function set(runProfile){this._runProfile=runProfile;if(this._botState.client===State.MOBILECLIENT()&&this._botState.location===Intent.EDGE()){this._botState.context.devMode();}}}]);return Developer;}();var SFTP=function(){function SFTP(botState){_classCallCheck(this,SFTP);this['_botState']=botState;this['_']=botState._;var capabilities=botState.context.capabilities.capabilities;if(capabilities){this['_context']=botState.context.capabilities;this['_sftpClient']=botState.context.capabilities.ssh2SftpClient;}else{this['_context']=botState.context;this['_sftpClient']=botState.context.ssh2SftpClient;}}_createClass(SFTP,[{key:'connect',value:function connect(host,port,username,password){var sftpClient;return regeneratorRuntime.async(function connect$(_context124){while(1){switch(_context124.prev=_context124.next){case 0:_context124.prev=0;sftpClient=new this._sftpClient();_context124.next=4;return regeneratorRuntime.awrap(sftpClient.connect({host:host,port:port,username:username,password:password}));case 4:console.log('connected to sftp server');return _context124.abrupt('return',sftpClient);case 8:_context124.prev=8;_context124.t0=_context124['catch'](0);console.log('error while connecting to the sftp server',_context124.t0);throw _context124.t0;case 12:case'end':return _context124.stop();}}},null,this,[[0,8]]);}},{key:'disconnect',value:function disconnect(sftpClient){return regeneratorRuntime.async(function disconnect$(_context125){while(1){switch(_context125.prev=_context125.next){case 0:_context125.prev=0;_context125.next=3;return regeneratorRuntime.awrap(sftpClient.end());case 3:_context125.next=9;break;case 5:_context125.prev=5;_context125.t0=_context125['catch'](0);console.log('error while disconnecting from the sftp server',_context125.t0);throw _context125.t0;case 9:case'end':return _context125.stop();}}},null,this,[[0,5]]);}},{key:'getFilesList',value:function getFilesList(sftpClient,path){return regeneratorRuntime.async(function getFilesList$(_context126){while(1){switch(_context126.prev=_context126.next){case 0:_context126.prev=0;_context126.next=3;return regeneratorRuntime.awrap(sftpClient.list(path));case 3:return _context126.abrupt('return',_context126.sent);case 6:_context126.prev=6;_context126.t0=_context126['catch'](0);console.log('error while listing files from the sftp server',_context126.t0);throw _context126.t0;case 10:case'end':return _context126.stop();}}},null,this,[[0,6]]);}},{key:'downloadFileToS3',value:function downloadFileToS3(sftpClient,S3,fromPath,toPath,fileName){var config,env,stream,putParams;return regeneratorRuntime.async(function downloadFileToS3$(_context127){while(1){switch(_context127.prev=_context127.next){case 0:_context127.prev=0;config=this._.get(this._context,'capabilities.config');env=this._.get(this._context,'capabilities.env');if(!config){config=this._.get(this._context,'config');env=this._.get(this._context,'env');}_context127.next=6;return regeneratorRuntime.awrap(sftpClient.get(fromPath+'/'+fileName));case 6:stream=_context127.sent;putParams={Bucket:config[env].CONVERSATIONS_BUCKET,Key:toPath+'/'+fileName,Body:stream};_context127.next=10;return regeneratorRuntime.awrap(S3.putObject(putParams).promise());case 10:_context127.next=16;break;case 12:_context127.prev=12;_context127.t0=_context127['catch'](0);console.log('error while getting file from the sftp server',_context127.t0);throw _context127.t0;case 16:case'end':return _context127.stop();}}},null,this,[[0,12]]);}},{key:'putFileToFTPServer',value:function putFileToFTPServer(sftpConnection,readStream,remotePath){var _D;return regeneratorRuntime.async(function putFileToFTPServer$(_context128){while(1){switch(_context128.prev=_context128.next){case 0:_context128.prev=0;_D=this._botState.developer;_D.log({message:'putFileToFTPServer:Start',data:remotePath});_context128.next=5;return regeneratorRuntime.awrap(sftpConnection.put(readStream,remotePath));case 5:_D.log({message:'putFileToFTPServer:End',data:remotePath});_context128.next=12;break;case 8:_context128.prev=8;_context128.t0=_context128['catch'](0);D.systemError({message:'putFileToFTPServer:Error occurred while putting the file to the server',errorCode:_context128.t0.message,data:_context128.t0});throw _context128.t0;case 12:case'end':return _context128.stop();}}},null,this,[[0,8]]);}}]);return SFTP;}();var Notification=function(){function Notification(botState){_classCallCheck(this,Notification);this['_botState']=botState;this['_']=botState._;if(this._botState.client===State.MOBILECLIENT()){this['notification']=this._botState.context.getCapability('Notification');}}_createClass(Notification,[{key:'sendEmail',value:function sendEmail(to,title,body,attachments){var params={capability:'SendEmailCustomCapability',capabilityFileName:'email',address:to,htmlBody:body,title:title,sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation,attachments:[]};var allAttachments=[];if(attachments){this._.each(attachments,function(attachment){var a={fileContentName:attachment.name};if(attachment.type==='csv'){a.stringContent=attachment.content;}else{a.jsonContent=attachment.content;}allAttachments.push(a);});params.attachments=allAttachments;}return this._botState.callCapability(params);}},{key:'sendIMMessage',value:function sendIMMessage(){console.log('Sending IM message');var messageToSend={messageId:this._botState.messageIdFromUser,contentType:this._botState.messageTypeIntFromUser,createdOn:this._botState.messageCreatedOnFromUser,createdBy:this._botState.user.userId,content:this._botState.messageContentFromUser,options:this._botState.messageOptionsFromUser};console.log(JSON.stringify(messageToSend));var params={capability:'SendIMMessage',capabilityFileName:'sendIMMessage',sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation,messages:[messageToSend],isNewConversation:false};return this._botState.callCapability(params);}},{key:'sendPushNotifications',value:function sendPushNotifications(conversations,message){var _this75=this;var R,_,D,createSNSMsg,callSNS,sns,devices,notificationsTargets,keys,people;return regeneratorRuntime.async(function sendPushNotifications$(_context129){while(1){switch(_context129.prev=_context129.next){case 0:R=this._botState.R;_=this._botState._;D=this._botState.developer;createSNSMsg=function createSNSMsg(conversationId){var apsMsg={aps:{alert:message,sound:'default'},conversationId:conversationId};var gcmMsg={collapse_key:'FrontM messages',data:{message:message,conversationId:conversationId}};var snsMsg={default:message,GCM:JSON.stringify(gcmMsg),APNS:JSON.stringify(apsMsg),APNS_SANDBOX:JSON.stringify(apsMsg)};return JSON.stringify(snsMsg);};callSNS=function callSNS(conversationId,sns,message,arn){var snsParams={Message:createSNSMsg(conversationId,message),MessageStructure:'json',Subject:'New Message',TargetArn:arn};return sns.publish(snsParams).promise();};sns=new this._botState.aws.SNS({apiVersion:'2010-03-31'});devices=[];notificationsTargets={};keys=[];_.forEach(conversations,function(conversation){_.forEach(_.get(conversation,'participants'),function(participant){if(participant!==_.get(conversation,'bot')){var key='People_'+participant;keys.push(key);notificationsTargets[key]={conversationId:conversation.conversationId};}});});_context129.next=12;return regeneratorRuntime.awrap(this._botState.db.getMultipleValuesFromCache(keys));case 12:people=_context129.sent;_.forEach(people,function(person,key){var parsedPerson=JSON.parse(person.content);notificationsTargets[key].devices=devices.concat(_.get(parsedPerson,'devices',[]));});_.forEach(notificationsTargets,function(target){_.forEach(_.get(target,'devices'),function(arn){callSNS(_.get(target,'conversationId'),sns,message,arn).then(function(){_this75._botState.developer.info({message:'Push notification sent with no error'});}).catch(function(err){_this75._botState.developer.warning({message:'Could not send push notification to a device',data:JSON.stringify(err)});console.log('Push notification error');return'error occurred while sending notification to :'+arn;});});});case 15:case'end':return _context129.stop();}}},null,this);}},{key:'ringParticipantsInConversationList',value:function ringParticipantsInConversationList(conversations,alertMessage,data){var _,D,i,conversation,_conversationId,participants,l,participant;return regeneratorRuntime.async(function ringParticipantsInConversationList$(_context130){while(1){switch(_context130.prev=_context130.next){case 0:_=this._botState._;D=this._botState.developer;i=0;case 3:if(!(i<conversations.length)){_context130.next=20;break;}conversation=conversations[i];_conversationId=_.get(conversation,'conversationId');participants=_.get(conversation,'participants');l=0;case 8:if(!(l<participants.length)){_context130.next=17;break;}participant=participants[l];data.conversationId=_conversationId;if(!(participant!==this._botState.user.userId)){_context130.next=14;break;}_context130.next=14;return regeneratorRuntime.awrap(this.sendVoipPushNotifications(participant,alertMessage,data));case 14:l++;_context130.next=8;break;case 17:i++;_context130.next=3;break;case 20:case'end':return _context130.stop();}}},null,this);}},{key:'sendVoipPushNotifications',value:function sendVoipPushNotifications(receiverUserId,alertMessage,data){var _this76=this;var R,_,D,createVoipMsg,sendVoipNotification,frontmLib,receiver,voipDevices,sns;return regeneratorRuntime.async(function sendVoipPushNotifications$(_context131){while(1){switch(_context131.prev=_context131.next){case 0:R=this._botState.R;_=this._botState._;D=this._botState.developer;_context131.prev=3;createVoipMsg=function createVoipMsg(alertMessage,data){var apsMsg={aps:{alert:alertMessage,data:data}};var androidMessage={notification:{title:alertMessage,body:data.message,sound:'incallmanager_ringback.mp3',android_channel_id:'500'},data:data,"priority":"high"};var snsMsg={APNS_VOIP_SANDBOX:JSON.stringify(apsMsg),APNS_VOIP:JSON.stringify(apsMsg),GCM:JSON.stringify(androidMessage)};return JSON.stringify(snsMsg);};sendVoipNotification=function sendVoipNotification(alertMessage,data,arn,sns){var snsParams={Message:createVoipMsg(alertMessage,data),MessageStructure:'json',MessageAttributes:{"AWS.SNS.MOBILE.APNS.PRIORITY":{"DataType":"String","StringValue":"10"},"AWS.SNS.MOBILE.APNS.PUSH_TYPE":{"DataType":"String","StringValue":"voip"}},TargetArn:arn};return sns.publish(snsParams).promise();};frontmLib=this._botState.frontmlib;_context131.next=9;return regeneratorRuntime.awrap(frontmLib.dbGetWithKey('People',{userId:receiverUserId}));case 9:receiver=_context131.sent;voipDevices=_.get(receiver,'Item.voipDevices',[]);sns=new this._botState.aws.SNS({apiVersion:'2010-03-31'});_.forEach(voipDevices,function(arn){sendVoipNotification(alertMessage,data,arn,sns).then(function(){_this76._botState.developer.info({message:'Voip Push notification sent with no error: '+arn});}).catch(function(err){_this76._botState.developer.warning({message:'Could not send voip push notification to a device to: '+arn,data:JSON.stringify(err)});console.log('Voip Push notification error');});});_context131.next=18;break;case 15:_context131.prev=15;_context131.t0=_context131['catch'](3);D.warning({message:'Fail voip push',data:_context131.t0});case 18:case'end':return _context131.stop();}}},null,this,[[3,15]]);}},{key:'endCall',value:function endCall(_ref27){var receiverUserId=_ref27.receiverUserId,videoSessionId=_ref27.videoSessionId,video=_ref27.video;var params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'sendVoipPushNotification',callAction:'CallEnd',callerUserId:this._botState.user.userId,receiverUserId:receiverUserId,videoSessionId:videoSessionId,video:video};return this._botState.callCapability(params);}},{key:'ringMultipleUsers',value:function ringMultipleUsers(conversations,alertMessage,data){var _=this._botState._;var D=this._botState.developer;var callerId=this._botState.user.userId;var receivers=[];for(var i=0;i<conversations.length;i++){var conversation=conversations[i];var participants=_.get(conversation,'participants');for(var l=0;l<participants.length;l++){var participant=participants[l];if(participant!==callerId){receivers.push(participant);}}}var params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'handleMultiUserCalls',callAction:'CallStart',callerUserId:callerId,multiReceivers:receivers,videoSessionId:data.videoSessionId,botId:this._botState.conversation.bot,videoControlId:data.videoControlId,video:data.video||false,alertMessage:alertMessage};return this._botState.callCapability(params);}},{key:'ringSingleUser',value:function ringSingleUser(receiverUserId,alertMessage,data){var _=this._botState._;var D=this._botState.developer;var callerId=this._botState.user.userId;var params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'sendVoipPushNotification',callAction:'CallStart',callerUserId:callerId,receiverUserId:receiverUserId,videoSessionId:data.videoSessionId,video:data.video||false,alertMessage:alertMessage};return this._botState.callCapability(params);}},{key:'handleCallConnected',value:function handleCallConnected(_ref28){var callerUserId=_ref28.callerUserId,receiverUserId=_ref28.receiverUserId;var params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'handleMultiUserCalls',callAction:'CallConnected',callerUserId:callerUserId,receiverUserId:receiverUserId};return this._botState.callCapability(params);}},{key:'inviteUsers',value:function inviteUsers(emailIds){var params={capability:'InviteUsers',capabilityFileName:'userInvitation',emailIds:emailIds,sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};var capabilities=this._botState.context.capabilities.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context.capabilities);}else{return callLambda('EmailLambda',params,this._botState.aws).then(function(response){console.log('Back from email lambda '+JSON.stringify(response));return JSON.parse(response.Payload);});}}},{key:'isDeviceRegisteredForPush',value:function isDeviceRegisteredForPush(){var _this77=this;return this.notification.deviceInfo().then(function(deviceInfo){if(_this77._botState._.isEmpty(deviceInfo)){return false;}return deviceInfo.isRegistered;});}},{key:'registerDeviceForPushOnEdge',value:function registerDeviceForPushOnEdge(){if(this._botState.client===State.MOBILECLIENT()){this.notification.requestPermission();}}},{key:'deregisterDeviceForPushOnEdge',value:function deregisterDeviceForPushOnEdge(){var _this78=this;if(this._botState.client===State.MOBILECLIENT()){return this.notification.deregister().then(function(notificationDeviceInfo){return notificationDeviceInfo;}).catch(function(error){_this78._botState.addSystemErrorToStack(19,JSON.stringify(error));});}else{this._botState.addSystemErrorToStack(18);}}},{key:'registerDeviceForPushOnBackend',value:function registerDeviceForPushOnBackend(notificationDeviceInfo){try{var conversation=this._botState.conversation;var userId=this._botState.user.userId;var params={capability:'RegisterDevice',capabilityFileName:'deviceRegistration',deviceToken:notificationDeviceInfo.deviceId,deviceType:notificationDeviceInfo.deviceType,sync:true,userId:userId,conversation:conversation};return this._botState.callCapability(params);}catch(error){this._botState.addSystemErrorToStack(16,error.message);}}},{key:'deregisterDeviceForPushOnBackend',value:function deregisterDeviceForPushOnBackend(notificationDeviceInfo){try{var conversation=this._botState.conversation;var userId=this._botState.user.userId;var params={capability:'DeregisterDevice',capabilityFileName:'deviceRegistration',deviceToken:notificationDeviceInfo.deviceId,deviceType:notificationDeviceInfo.deviceType,sync:true,userId:userId,conversation:conversation};return this._botState.callCapability(params);}catch(error){this._botState.addSystemErrorToStack(16,error.message);}}},{key:'sendNotification',value:function sendNotification(target,type,message){try{var requestId=this._botState.getUniqueId();var params={target:target,capability:'BroadCastMessageCapability',capabilityFileName:'broadCastMessage',action:'get',bot:this._botState.conversation.bot,userDomain:this._botState.conversation.userDomain,requestUuid:requestId,sync:true,email:this._botState.user.userEmail,conversation:this._botState.conversation,messages:[{content:[message],contentType:type,createdBy:this._botState.user.userId,createdOn:Date.now(),messageId:this._botState.getUniqueId()}]};console.log(this._botState.R.toString(params));return this._botState.callCapability(params);}catch(error){this._botState.addSystemErrorToStack(16,error.message,error.message);}}},{key:'sendMessageToUserInBot',value:function sendMessageToUserInBot(type,message,userIds,botId,userDomain){var target={bot:botId||this._botState.conversation.bot,userDomain:userDomain||this._botState.conversation.userDomain,users:userIds};return this.sendNotification(target,type,message);}},{key:'sendBroadcastNotificationToBot',value:function sendBroadcastNotificationToBot(botId,userDomain,type,message){var target={bot:botId||this._botState.conversation.bot,userDomain:userDomain||this._botState.conversation.userDomain};return this.sendNotification(target,type,message);}}]);return Notification;}();var Vessel=function(){function Vessel(_ref29){var IMO=_ref29.IMO,botState=_ref29.botState;_classCallCheck(this,Vessel);this._botState=botState;this._IMO=IMO;this.entity=new Entity({entityName:IMO,botState:botState,keys:{IMO:IMO}});}_createClass(Vessel,[{key:'getRecord',value:function getRecord(){var _,D,globalSitesResult,params,result;return regeneratorRuntime.async(function getRecord$(_context132){while(1){switch(_context132.prev=_context132.next){case 0:_=this._botState._;D=this._botState.developer;_context132.next=4;return regeneratorRuntime.awrap(this._botState.sites.searchGlobalSites(this._IMO,'Vessels'));case 4:globalSitesResult=_context132.sent;if(!(Array.isArray(globalSitesResult)&&globalSitesResult.length===0)){_context132.next=12;break;}params={queryParams:'imo:'+this._IMO};_context132.next=9;return regeneratorRuntime.awrap(this._botState.api.callService('MarineTraffic-Vessel-Particulars',params));case 9:result=_context132.sent;_context132.next=14;break;case 12:this._fields=globalSitesResult[0];return _context132.abrupt('return',globalSitesResult[0]);case 14:case'end':return _context132.stop();}}},null,this);}}]);return Vessel;}();var Sites=function(){function Sites(botState){_classCallCheck(this,Sites);this['_botState']=botState;this['context']=botState.context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['_']=botState._;}_createClass(Sites,[{key:'callCapLambda',value:function callCapLambda(params){try{var capabilities=this._botState.context.capabilities.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this.context.capabilities);}else{console.log('Old way: ',capFileName);return callLambda('CapabilityExecutorLambda',params,this.context.aws).then(function(response){return JSON.parse(response.Payload);});}}catch(err){this._botState.addSystemErrorToStack(26,'2 '+err.name+': '+err.message);}}},{key:'getBaseParams',value:function getBaseParams(){return{capability:'SitesCapability',capabilityFileName:'sitesCapability',sync:true,userId:this.userId,conversation:this.conversation};}},{key:'getSites',value:function getSites(){var params=this.getBaseParams();params.action='GetUserSites';return this.callCapLambda(params);}},{key:'searchLocalSites',value:function searchLocalSites(searchTerm,type){var params=this.getBaseParams();params.action='SearchSites';params.searchTerm=searchTerm;params.siteType=type;return this.callCapLambda(params);}},{key:'searchGlobalSites',value:function searchGlobalSites(searchTerm,type){var params=this.getBaseParams();params.action='SearchGlobalSites';params.searchTerm=searchTerm;params.siteType=type;return this.callCapLambda(params);}},{key:'deleteSite',value:function deleteSite(site){var params=this.getBaseParams();params.action='DeleteSite';params.siteId=site.siteId;return this.callCapLambda(params);}},{key:'updateSite',value:function updateSite(site){var params=this.getBaseParams();params.action='UpdateSite';params.site=site;return this.callCapLambda(params);}},{key:'createSites',value:function createSites(sites,type){var params=this.getBaseParams();params.action='CreateSites';params.sites=sites;params.siteType=type;return this.callCapLambda(params);}}]);return Sites;}();var Contacts=function(){function Contacts(botState){_classCallCheck(this,Contacts);this['_botState']=botState;this['_']=botState._;if(this._botState.client===State.MOBILECLIENT()){this['contactCapability']=this._botState.context.getCapability('Contact');}}_createClass(Contacts,[{key:'refreshContactsOnEdge',value:function refreshContactsOnEdge(){if(this._botState.client===State.MOBILECLIENT()){this.contactCapability.refreshContacts();}else{this._botState.addSystemErrorToStack(18);}}},{key:'getAllContactsFromEdge',value:function getAllContactsFromEdge(){return this.contactCapability.getAddedContacts().then(function(contactIds){return contactIds;});}},{key:'getAllContactsFromBackend',value:function getAllContactsFromBackend(){var params={capability:'GetContacts',capabilityFileName:'contactsListCapability',userDomain:this._botState.conversation.userDomain,sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};var capabilities=this._botState.context.capabilities.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,this._botState.context.capabilities);}}}]);return Contacts;}();var File=function(){function File(botState){_classCallCheck(this,File);this['_botState']=botState;this['_']=botState._;var capabilities=botState.context.capabilities.capabilities;var context=null;if(capabilities){context=botState.context.capabilities;}else{context=botState.context;}this['_context']=context;}_createClass(File,[{key:'read',value:function read(){var s3Params={Bucket:envConfig.BOT_LOGO_BUCKET,CopySource:conversationBucket+'/'+conversationId+'/'+fileName,Key:botName.replace(/[^A-Z0-9]+/gi,'_')+'_'+botId+'.'+fileExtension,ACL:'public-read'};return s3.copyObject(s3Params).promise();}},{key:'createQRCode',value:function createQRCode(qrText,qrImageName){var _context133,QRCode,config,env,aws,_s,qrString,base64Data,bucket,_conversationId2,params;return regeneratorRuntime.async(function createQRCode$(_context134){while(1){switch(_context134.prev=_context134.next){case 0:if(qrText){_context134.next=2;break;}throw new Error('qrText is required');case 2:if(!qrImageName){qrImageName=this._botState.getUniqueId()+'.png';}_context134.prev=3;_context133=this._context,QRCode=_context133.QRCode,config=_context133.config,env=_context133.env,aws=_context133.aws;_s=new aws.S3();_context134.next=8;return regeneratorRuntime.awrap(QRCode.toDataURL(qrText));case 8:qrString=_context134.sent;base64Data=Buffer.from(qrString.replace(/^data:image\/\w+;base64,/,""),'base64');bucket=config[env].CONVERSATIONS_BUCKET;_conversationId2=this._botState.conversationId;params={Bucket:bucket,Key:_conversationId2+'/'+qrImageName,Body:base64Data,ContentType:'image/png',ContentEncoding:'base64'};this._botState.developer.log({message:'createQRCode',data:{bucket:bucket,conversationId:_conversationId2,qrImageName:qrImageName}});_context134.next=16;return regeneratorRuntime.awrap(_s.upload(params).promise());case 16:return _context134.abrupt('return',qrImageName);case 19:_context134.prev=19;_context134.t0=_context134['catch'](3);throw new Error('Error while creating QR Code'+_context134.t0.message);case 22:case'end':return _context134.stop();}}},null,this,[[3,19]]);}},{key:'generateCsvFileFromDynamo',value:function generateCsvFileFromDynamo(query,options,conversationId,fileName){var _this79=this;var startTime,_context135,stream,config,env,frontmlib,aws,moment,s3,headers,specialFields,specialFieldNames,defaultsObj,inStream,bucket,params,uploadPromise,_response3;return regeneratorRuntime.async(function generateCsvFileFromDynamo$(_context137){while(1){switch(_context137.prev=_context137.next){case 0:startTime=Date.now();_context135=this._context,stream=_context135.stream,config=_context135.config,env=_context135.env,frontmlib=_context135.frontmlib,aws=_context135.aws,moment=_context135.moment;s3=new aws.S3();headers=options.headers,specialFields=options.specialFields;specialFieldNames=Object.keys(options.specialFields||{});defaultsObj=this._(headers).mapKeys().mapValues(function(){return'';}).value();inStream=new stream.Readable({read:function read(){}});bucket=config[env].CONVERSATIONS_BUCKET;params={Bucket:bucket,Key:conversationId+'/'+fileName,Body:inStream};this._botState.developer.log({message:'generateCsvFileFromDynamo',data:{bucket:bucket,conversationId:conversationId,fileName:fileName}});uploadPromise=new Promise(function _callee113(resolve,reject){var headerString,_ref30,Items,LastEvaluatedKey;return regeneratorRuntime.async(function _callee113$(_context136){while(1){switch(_context136.prev=_context136.next){case 0:s3.upload(params,function(err,data){if(err!==null){reject(err);}else{resolve(data);}});headerString='"'+headers.join('","')+'"\n';inStream.push(headerString);_this79._botState.developer.log({message:'generateCsvFileFromDynamo: Wrote header to the csv file'});console.log('generateCsvFileFromDynamo: Wrote header to the csv file');case 5:_context136.next=7;return regeneratorRuntime.awrap(frontmlib.dbGetWithPagination(query.TableName,query.IndexName,query.KeyConditionExpression,query.FilterExpression,query.ExpressionAttributeValues,query.ExclusiveStartKey||null,query.Fields,query.options));case 7:_ref30=_context136.sent;Items=_ref30.Items;LastEvaluatedKey=_ref30.LastEvaluatedKey;_this79._botState.developer.log({message:'generateCsvFileFromDynamo: got items from dynamo',data:{size:_this79._.size(Items),LastEvaluatedKey:LastEvaluatedKey}});console.log('generateCsvFileFromDynamo: got items from dynamo',_this79._.size(Items),LastEvaluatedKey);_this79._.map(Items,function(obj){var newObjWithHeaders=_this79._({}).assign(defaultsObj,_this79._.pick(obj,headers)).value();if(specialFieldNames){_this79._.forEach(specialFieldNames,function(headerName){var headerProcessor=specialFields[headerName];var fieldValue=newObjWithHeaders[headerName];if(!_this79._.isNumber(fieldValue)&&_this79._.isEmpty(fieldValue)){return true;}switch(headerProcessor.type){case'dateTime':newObjWithHeaders[headerName]=moment(_this79._.toNumber(fieldValue)).format(headerProcessor.format||'DD/MMMM/YYYY hh:mm a');break;}});}var line=_this79._(newObjWithHeaders).values().join('","');inStream.push('"'+line+'"\n');});if(!(!LastEvaluatedKey||_.size(Items)===0)){_context136.next=15;break;}return _context136.abrupt('break',17);case 15:query.ExclusiveStartKey=LastEvaluatedKey;case 16:if(query.ExclusiveStartKey!==null){_context136.next=5;break;}case 17:inStream.push(null);inStream.on('end',function(){var totalTime=Date.now()-startTime;_this79._botState.developer.log({message:'generateCsvFileFromDynamo: totalTime to create csv in generateCsvFileFromDynamo:',data:{totalTime:totalTime}});console.log('generateCsvFileFromDynamo: totalTime to create csv in generateCsvFileFromDynamo: ',totalTime);});inStream.on('error',function(data){_this79._botState.developer.log({message:'generateCsvFileFromDynamo: Stream erred',data:data});console.log('generateCsvFileFromDynamo: Stream erred',JSON.stringify(data));reject(data);});case 20:case'end':return _context136.stop();}}},null,_this79);});_context137.prev=11;_context137.next=14;return regeneratorRuntime.awrap(uploadPromise);case 14:_response3=_context137.sent;this._botState.developer.log({message:'generateCsvFileFromDynamo: final response:',data:_response3});console.log('generateCsvFileFromDynamo: final response: ',_response3);return _context137.abrupt('return',_response3);case 20:_context137.prev=20;_context137.t0=_context137['catch'](11);console.log(_context137.t0);case 23:case'end':return _context137.stop();}}},null,this,[[11,20]]);}}]);return File;}();var Field=function(_Intent18){_inherits(Field,_Intent18);_createClass(Field,null,[{key:'MOVE_FORM_ACTION',value:function MOVE_FORM_ACTION(){return'move';}},{key:'SEARCH_FORM_ACTION',value:function SEARCH_FORM_ACTION(){return'search';}},{key:'CLICK_FORM_ACTION',value:function CLICK_FORM_ACTION(){return'click';}},{key:'FIELD_COMPLETION_FORM_ACTION',value:function FIELD_COMPLETION_FORM_ACTION(){return'completion';}},{key:'FIELD_BUFFER_PREFIX',value:function FIELD_BUFFER_PREFIX(){return'AUTOSAVED_FIELD_';}},{key:'FIELD_LOOKUP_PREFIX',value:function FIELD_LOOKUP_PREFIX(){return'LOOKUP_FIELD_';}}]);function Field(intentId,_ref31){var _this81=this;var doc=_ref31.doc,_ref31$primaryKey=_ref31.primaryKey,primaryKey=_ref31$primaryKey===undefined?false:_ref31$primaryKey,title=_ref31.title,type=_ref31.type,_ref31$mandatory=_ref31.mandatory,mandatory=_ref31$mandatory===undefined?false:_ref31$mandatory,_ref31$validation=_ref31.validation,validation=_ref31$validation===undefined?false:_ref31$validation,_ref31$readOnly=_ref31.readOnly,readOnly=_ref31$readOnly===undefined?false:_ref31$readOnly,value=_ref31.value,options=_ref31.options,info=_ref31.info,minLength=_ref31.minLength,maxLength=_ref31.maxLength,_ref31$hidden=_ref31.hidden,hidden=_ref31$hidden===undefined?false:_ref31$hidden,_ref31$lookup=_ref31.lookup,lookup=_ref31$lookup===undefined?false:_ref31$lookup,lookUpCollection=_ref31.lookUpCollection,lookUpFilter=_ref31.lookUpFilter,valueFromLookUp=_ref31.valueFromLookUp,lookUpForeignKey=_ref31.lookUpForeignKey,_ref31$searchKey=_ref31.searchKey,searchKey=_ref31$searchKey===undefined?false:_ref31$searchKey,_ref31$temp=_ref31.temp,temp=_ref31$temp===undefined?false:_ref31$temp,_ref31$onMessage=_ref31.onMessage,onMessage=_ref31$onMessage===undefined?function(){}:_ref31$onMessage;_classCallCheck(this,Field);var _this80=_possibleConstructorReturn(this,(Field.__proto__||Object.getPrototypeOf(Field)).call(this,intentId));_this80.onMoveOut=function _callee114(){return regeneratorRuntime.async(function _callee114$(_context138){while(1){switch(_context138.prev=_context138.next){case 0:case'end':return _context138.stop();}}},null,_this81);};_this80.onClick=function _callee115(){return regeneratorRuntime.async(function _callee115$(_context139){while(1){switch(_context139.prev=_context139.next){case 0:case'end':return _context139.stop();}}},null,_this81);};_this80.onSearch=function _callee116(){return regeneratorRuntime.async(function _callee116$(_context140){while(1){switch(_context140.prev=_context140.next){case 0:case'end':return _context140.stop();}}},null,_this81);};_this80.onCompletion=function _callee117(){return regeneratorRuntime.async(function _callee117$(_context141){while(1){switch(_context141.prev=_context141.next){case 0:case'end':return _context141.stop();}}},null,_this81);};if((typeof primaryKey!=='boolean'||!title||!type)&&!lookup){var _ret;if(doc){doc._botState.addSystemErrorToStack(7,'Field title or type missing on field '+intentId);}return _ret=null,_possibleConstructorReturn(_this80,_ret);}_this80.title=title;_this80.type=type;_this80.primaryKey=primaryKey;_this80.mandatory=mandatory;_this80.validation=validation;_this80.readOnly=readOnly;_this80._value=value;_this80._originalValue=value;_this80.options=options;_this80.info=info;_this80.maxLength=maxLength;_this80.minLength=minLength;_this80.hidden=hidden;_this80.temp=temp;_this80.onMessage=onMessage;_this80.lookUpCollection=lookUpCollection;if(_this80.lookUpFilter){if(Array.isArray(lookUpFilter)){_this80.lookUpFilter=lookUpFilter;}else{_this80.lookUpFilter=[lookUpFilter];}}if(Array.isArray(lookUpForeignKey)){_this80.lookUpForeignKey=lookUpForeignKey;}else{_this80.lookUpForeignKey=[lookUpForeignKey];}_this80.valueFromLookUp=valueFromLookUp;_this80.formId=doc.intentId;_this80.searchKey=searchKey;_this80._doc=null;_this80.disableHistoryLogging();if(doc){_this80.formId=doc.formId;_this80._doc=doc;doc.addField(_this80);}return _this80;}_createClass(Field,[{key:'message',value:function message(){this.onMessage(this);var _=this._doc?this._doc._botState._:null;var v=this.value;var fileName='';if(typeof this.value==='object'&&_!==null&&_.get(this.value,'fileName')){v=_.get(this.value,'value');fileName=_.get(this.value,'fileName');}return{id:this.intentId,title:this.title,type:this.type,info:this.info,mandatory:this.mandatory,validation:this.validation,readOnly:this.readOnly,value:v,fileName:fileName,maxLength:this.maxLength,minLength:this.minLength,options:this.options,search:this.search,hidden:this.hidden};}},{key:'autoSaveLogic',value:function autoSaveLogic(state){var _=this._doc._botState._;var D=this._doc._botState.developer;if(this._doc.autoSave){D.log({message:'Auto save started'});var currentFieldValue=state._.get(state.messageFromUser,'currentFieldValue');if(typeof currentFieldValue!=='undefined'&&currentFieldValue!==null){if(typeof currentFieldValue==='object'&&_.size(currentFieldValue)>0&&this.type===FormFieldTypes.LOOKUP()){state.setField(Field.FIELD_BUFFER_PREFIX()+this.id,_.get(currentFieldValue,'text'));var lookupArray=state.getField(Field.FIELD_LOOKUP_PREFIX()+this.id);var index=_.findIndex(lookupArray,function(entry){return _.get(entry,'info')===_.get(currentFieldValue,'info');});var lookUpRecord=_.get(lookupArray[index],'doc');var changedFields=[];_.forEach(this._doc.fields,function(field){if(field.valueFromLookUp){_.forEach(lookUpRecord,function(value,key){if(key===field.valueFromLookUp){field.value=lookUpRecord[key];changedFields.push(field.message());}});}});if(changedFields.length>0){D.log({message:'4',data:changedFields});state.addFormChangeResponse(this._doc.message(Form2.FORM_CHANGE_ACTION(),changedFields));}}else{if(currentFieldValue===''){D.log({message:'Clear field'});state.clearField(Field.FIELD_BUFFER_PREFIX()+this.id);}else{D.log({message:'5'});state.setField(Field.FIELD_BUFFER_PREFIX()+this.id,currentFieldValue);}}}}}},{key:'lookupLogic',value:function lookupLogic(state){var _this82=this;var _,D,currentFieldValue,query,and,i,or,orArray,rows,resultsArray,queryResults,results,_results;return regeneratorRuntime.async(function lookupLogic$(_context142){while(1){switch(_context142.prev=_context142.next){case 0:_=state._;D=state.developer;currentFieldValue=state._.get(state.messageFromUser,'currentFieldValue');if(!(currentFieldValue!==''&&this.lookUpCollection)){_context142.next=29;break;}D.log({message:'Starting the look up',data:currentFieldValue});query={};and=[];if(this.lookUpFilter){D.log({message:'Found lookUpFilter',data:this.lookUpFilter});i=0;_.forEach(this.lookUpFilter,function(filter){D.log({message:'Field',data:filter});var filterValue=filter.tempValue;if(filterValue!==null){var fieldQuery={};fieldQuery[_this82.lookUpForeignKey[i]]=filterValue;and.push(fieldQuery);}i++;});}D.log({message:'Query so far',data:and});or={};orArray=[];this.lookUpCollection.document.fields.forEach(function(field){var fieldQuery={};if(field.type===FormFieldTypes.NUMBER_FIELD()){fieldQuery[field.id]=field.value;}else{var regexSearch={};regexSearch['$regex']='^(.*?)'+currentFieldValue;regexSearch['$options']='i';fieldQuery[field.id]=regexSearch;}orArray.push(fieldQuery);});or['$or']=orArray;and.push(or);query['$and']=and;D.log({message:'Lookup Query',data:query});_context142.next=18;return regeneratorRuntime.awrap(this.lookUpCollection.loadCollectionWithQuery({query:query}));case 18:rows=_context142.sent;resultsArray=[];queryResults=[];D.log({message:'All rows',data:rows});_.forEach(this.lookUpCollection.rows,function(doc){var text=_this82.valueFromLookUp?doc.document[_this82.valueFromLookUp]:doc.getPrimaryKeyAsStringForSearch(doc.getPrimaryKey());var info=doc.getPrimaryKeyAsStringForSearch(doc.getNonPrimaryKey());var newResultEntry={text:text,info:info!==""?info:null};resultsArray.push(newResultEntry);var resultsToStore=_.cloneDeep(newResultEntry);resultsToStore.doc=doc.document;queryResults.push(resultsToStore);});D.log({message:'Final array',data:resultsArray});results=this._doc.message(Form2.FORM_SEARCH_RESULTS_ACTION(),{field:this.id,results:resultsArray});state.setField(Field.FIELD_LOOKUP_PREFIX()+this.id,queryResults);state.addFormChangeResponse(results);_context142.next=31;break;case 29:_results=this._doc.message(Form2.FORM_SEARCH_RESULTS_ACTION(),{field:this.id,results:[]});state.addFormChangeResponse(_results);case 31:case'end':return _context142.stop();}}},null,this);}},{key:'doc',get:function get(){return this._doc;}},{key:'value',get:function get(){var _=this._doc._botState._;if(typeof this._value==='object'&&_.size(this._value)===0){return;}else{return this._value;}},set:function set(value){var _=this._doc._botState._;var D=this._doc._botState.developer;if(typeof value==='object'&&_.size(value)===0)return;var v=value;if(typeof v==='string'&&(this.type===FormFieldTypes.DATE()||this.type===FormFieldTypes.DATETIME())){if(v.substring(0,5)==='#date'){v=parseInt(v.substring(6,19));}else{v=parseInt(v);}}if(this.type===FormFieldTypes.CHECKBOX()&&Array.isArray(v)){v=v[0];}this._doc._botState.setField(Field.FIELD_BUFFER_PREFIX()+this.id,v);if(!this.temp){this._doc._document[this._intentId]=v;}this._value=v;}},{key:'tempValue',get:function get(){var value=this._doc._botState.getField(Field.FIELD_BUFFER_PREFIX()+this.id);if(value===null)value=this._value;return value;}},{key:'id',get:function get(){return this.intentId;}},{key:'onMatching',get:function get(){var _this83=this;return function(state){var inputControlId=state.messageFromUser.controlId||state.messageFromUser.formId;return(state.messageTypeFromUser===Form2.FORM_RESPONSE()||state.messageTypeFromUser===Table.TABLE_RESPONSE()||state.messageTypeFromUser===Container.CONTAINER_RESPONSE())&&state.messageFromUser.currentField===_this83.id&&inputControlId===_this83.formId;};}},{key:'onResolution',get:function get(){var _this84=this;return function _callee118(state){return regeneratorRuntime.async(function _callee118$(_context143){while(1){switch(_context143.prev=_context143.next){case 0:if(!(state.messageFromUser.action===Field.MOVE_FORM_ACTION())){_context143.next=6;break;}_this84.autoSaveLogic(state);_context143.next=4;return regeneratorRuntime.awrap(_this84.onMoveOut());case 4:_context143.next=24;break;case 6:if(!(state.messageFromUser.action===Field.CLICK_FORM_ACTION())){_context143.next=11;break;}_context143.next=9;return regeneratorRuntime.awrap(_this84.onClick());case 9:_context143.next=24;break;case 11:if(!(state.messageFromUser.action===Field.SEARCH_FORM_ACTION())){_context143.next=18;break;}_context143.next=14;return regeneratorRuntime.awrap(_this84.lookupLogic(state));case 14:_context143.next=16;return regeneratorRuntime.awrap(_this84.onSearch());case 16:_context143.next=24;break;case 18:if(!(state.messageFromUser.action===Field.FIELD_COMPLETION_FORM_ACTION())){_context143.next=23;break;}_context143.next=21;return regeneratorRuntime.awrap(_this84.onCompletion());case 21:_context143.next=24;break;case 23:state.addSystemErrorToStack(29,Error.getErrorMessageforCodeAndLang(29));case 24:state.developer.debug({message:'About to leave onResolution'});if(state.responsesArray.length===0){state.addSilentResponse();}case 26:case'end':return _context143.stop();}}},null,_this84);};}}]);return Field;}(Intent);var Collection=function(_Table){_inherits(Collection,_Table);_createClass(Collection,null,[{key:'FILTER_PREFIX',value:function FILTER_PREFIX(){return'filter_prefix_';}},{key:'ALL_FILTERS',value:function ALL_FILTERS(){return'filter_prefix_all_filters';}}]);function Collection(intentId,_ref32){var _this86=this;var _ref32$title=_ref32.title,title=_ref32$title===undefined?'Lookup':_ref32$title,_ref32$description=_ref32.description,description=_ref32$description===undefined?'Lookup':_ref32$description,_ref32$columnNames=_ref32.columnNames,columnNames=_ref32$columnNames===undefined?[]:_ref32$columnNames,filter=_ref32.filter,_ref32$keys=_ref32.keys,keys=_ref32$keys===undefined?[]:_ref32$keys,_ref32$selectableRows=_ref32.selectableRows,selectableRows=_ref32$selectableRows===undefined?false:_ref32$selectableRows,_ref32$actionableRows=_ref32.actionableRows,actionableRows=_ref32$actionableRows===undefined?false:_ref32$actionableRows,_ref32$addNewRows=_ref32.addNewRows,addNewRows=_ref32$addNewRows===undefined?false:_ref32$addNewRows,addNewRowsLabel=_ref32.addNewRowsLabel,_ref32$allowMinimize=_ref32.allowMinimize,allowMinimize=_ref32$allowMinimize===undefined?true:_ref32$allowMinimize,_ref32$allowClose=_ref32.allowClose,allowClose=_ref32$allowClose===undefined?true:_ref32$allowClose,_ref32$minimizeOnActi=_ref32.minimizeOnAction,minimizeOnAction=_ref32$minimizeOnActi===undefined?false:_ref32$minimizeOnActi,footer=_ref32.footer,rowMenu=_ref32.rowMenu,pages=_ref32.pages,zone=_ref32.zone,_ref32$allowChange=_ref32.allowChange,allowChange=_ref32$allowChange===undefined?false:_ref32$allowChange,_ref32$allowDelete=_ref32.allowDelete,allowDelete=_ref32$allowDelete===undefined?false:_ref32$allowDelete,_ref32$allowRefresh=_ref32.allowRefresh,allowRefresh=_ref32$allowRefresh===undefined?false:_ref32$allowRefresh,_ref32$allowDownload=_ref32.allowDownload,allowDownload=_ref32$allowDownload===undefined?false:_ref32$allowDownload,_ref32$allowSearch=_ref32.allowSearch,allowSearch=_ref32$allowSearch===undefined?false:_ref32$allowSearch,confirmAction=_ref32.confirmAction,parentDoc=_ref32.parentDoc,document=_ref32.document,modal=_ref32.modal,style=_ref32.style,calendarEntry=_ref32.calendarEntry,activeFilterName=_ref32.activeFilterName,availableFilters=_ref32.availableFilters,_ref32$filterActive=_ref32.filterActive,filterActive=_ref32$filterActive===undefined?false:_ref32$filterActive;_classCallCheck(this,Collection);if(!document){var _ret2;return _ret2=null,_possibleConstructorReturn(_this85,_ret2);}var _this85=_possibleConstructorReturn(this,(Collection.__proto__||Object.getPrototypeOf(Collection)).call(this,intentId,{title:title,description:description,columnNames:columnNames,filter:filter,keys:keys,selectableRows:selectableRows,actionableRows:actionableRows,addNewRows:addNewRows,addNewRowsLabel:addNewRowsLabel,allowMinimize:allowMinimize,allowClose:allowClose,minimizeOnAction:minimizeOnAction,footer:footer,rowMenu:rowMenu,pages:pages,zone:zone,allowChange:allowChange,allowDelete:allowDelete,allowRefresh:allowRefresh,allowDownload:allowDownload,allowSearch:allowSearch,confirmAction:confirmAction,modal:modal,style:style,calendarEntry:calendarEntry,activeFilterName:activeFilterName,availableFilters:availableFilters,filterActive:filterActive}));_this85._name=intentId;_this85._botState=document._botState;_this85._=document._botState._;_this85._rows=[];_this85._document=document;if(_this85._document){_this85._botState=_this85._document._botState;}_this85._subCollection=false;if(parentDoc){if(parentDoc instanceof Doc){_this85._subCollection=true;parentDoc.addChildDoc(_this85);}else{_this85._botState.addSystemErrorToStack(7,'Sub documents cannot be saved '+_this85._intentId);}}_this85._document.setCollection(_this85);_this85.onFilterDelete=function _callee119(){var filterName;return regeneratorRuntime.async(function _callee119$(_context144){while(1){switch(_context144.prev=_context144.next){case 0:filterName=_this85.messageFromUser.activeFilterName;_this85._botState.clearField(Collection.FILTER_PREFIX()+filterName);case 2:case'end':return _context144.stop();}}},null,_this86);};return _this85;}_createClass(Collection,[{key:'generateTableColumnLabels',value:function generateTableColumnLabels(){var _=this._botState._;var tableRowLabels=[];_.forEach(this._document.fields,function(field){if(!field.hidden){if(field.type===FormFieldTypes.FILE_FIELD()){tableRowLabels.push(field.title+'_attachment');}else{tableRowLabels.push(field.title);}}});return tableRowLabels;}},{key:'generateTableKeyLabels',value:function generateTableKeyLabels(){var _=this._botState._;var tableRowKeyLabels=[];_.forEach(this._document.fields,function(field){if(field.primaryKey){tableRowKeyLabels.push(field.title);}});return tableRowKeyLabels;}},{key:'generateTableRows',value:function generateTableRows(){var _=this._botState._;var D=this._botState.developer;var tableRows=[];_.forEach(this._rows,function(row){var doc=row.document;var tableRow={};_.forEach(row.fields,function(field){if(field)field.onMessage(field);if(doc[field.id]&&typeof doc[field.id]!=='undefined'&&(field.primaryKey||!field.hidden)){if(field.type===FormFieldTypes.DATE()||field.type===FormFieldTypes.DATETIME()){tableRow[field.title]='#date('+field.value+')';}else{tableRow[field.title]=field.value;}}});tableRows.push(tableRow);});return tableRows;}},{key:'message',value:function message(){if(this._filterActive){var columns=[];this._.forEach(this._document.fields,function(field){var fieldDetails=field.message();if(fieldDetails)columns.push(fieldDetails);});this._filteredColumns=columns;}this.columnNames=this.generateTableColumnLabels();this.keys=this.generateTableKeyLabels();if(this._activeFilterName){var allFilters=this._botState.getField(Collection.ALL_FILTERS());allFilters[this._activeFilterName]=true;this._botState.setField(Collection.ALL_FILTERS(),allFilters);this._botState.setField(Collection.FILTER_PREFIX()+this._activeFilterName,this.columnNames);this._availableFilters=this._.keys(allFilters);}return{rows:this.generateTableRows(),options:this.options};}},{key:'getFilterCriteriaWithName',value:function getFilterCriteriaWithName(name){return this._botState.getField(Collection.FILTER_PREFIX()+name);}},{key:'addRow',value:function addRow(row){this._rows.push(row);}},{key:'clearRows',value:function clearRows(){this._rows=[];}},{key:'buildRowsFromArray',value:function buildRowsFromArray(rows){var _this87=this;var _=this._botState._;if(_.isArray(rows)){rows.forEach(function(row){var newDoc=_.cloneDeep(_this87._document);newDoc.buildDocument(row);_this87.addRow(newDoc);});}}},{key:'loadCollectionWithQuery',value:function loadCollectionWithQuery(_ref33){var _this88=this;var _ref33$query=_ref33.query,query=_ref33$query===undefined?{}:_ref33$query,_ref33$projection=_ref33.projection,projection=_ref33$projection===undefined?{}:_ref33$projection,_ref33$sort=_ref33.sort,sort=_ref33$sort===undefined?{}:_ref33$sort,_ref33$skip=_ref33.skip,skip=_ref33$skip===undefined?0:_ref33$skip,_ref33$limit=_ref33.limit,limit=_ref33$limit===undefined?20:_ref33$limit,_ref33$collation=_ref33.collation,collation=_ref33$collation===undefined?{}:_ref33$collation;var _,D,results,payload,allDocs;return regeneratorRuntime.async(function loadCollectionWithQuery$(_context145){while(1){switch(_context145.prev=_context145.next){case 0:if(!this._subCollection){_context145.next=3;break;}this._botState.addErrorToStack(7,'We cannot retrieve data from subCollections');return _context145.abrupt('return');case 3:_=this._botState._;D=this._botState.developer;_context145.next=7;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:this._name,query:query,projection:projection,sort:sort,skip:skip,limit:limit,collation:collation}));case 7:results=_context145.sent;if(!(results.statusCode===200)){_context145.next=17;break;}payload=results.body;if(!(Array.isArray(payload)&&payload.length>0)){_context145.next=17;break;}allDocs=[];this._rows=[];_.forEach(payload,function(document){var docClone=_.cloneDeep(_this88._document);allDocs.push(document);if(_this88._document.hasSubDocs){docClone.buildDocumentFromContainer(document);}else{docClone.buildDocument(document);}_this88._rows.push(docClone);});return _context145.abrupt('return',allDocs);case 17:case'end':return _context145.stop();}}},null,this);}},{key:'getQueryForSearch',value:function getQueryForSearch(queryString){var _=this._botState._;var query={};var OR='$or';query[OR]=[];_.forEach(this._document.fields,function(field){if(field.searchKey||field.primaryKey){var fieldQuery={};if(field.type===FormFieldTypes.NUMBER_FIELD()){fieldQuery[field.id]=parseInt(queryString,10);}else{var regexSearch={};regexSearch['$regex']='^(.*?)'+queryString;regexSearch['$options']='i';fieldQuery[field.id]=regexSearch;}if(_.size(fieldQuery)>0){query[OR].push(fieldQuery);}}});return query;}},{key:'rows',set:function set(rows){this._rows=rows;},get:function get(){return this._rows;}},{key:'document',get:function get(){return this._document;}}]);return Collection;}(Table);var AuthorizationRequest=function(_Intent19){_inherits(AuthorizationRequest,_Intent19);_createClass(AuthorizationRequest,null,[{key:'MESSAGE_TYPE',value:function MESSAGE_TYPE(){return'authorization_request';}},{key:'MESSAGE_RESPONSE',value:function MESSAGE_RESPONSE(){return'authorization_request_response';}},{key:'CONFIRM_ACTION',value:function CONFIRM_ACTION(){return'confirm';}},{key:'CANCEL_ACTION',value:function CANCEL_ACTION(){return'cancel';}}]);function AuthorizationRequest(intentId,_ref34){var _this90=this;var text=_ref34.text,confirm=_ref34.confirm,cancel=_ref34.cancel;_classCallCheck(this,AuthorizationRequest);var _this89=_possibleConstructorReturn(this,(AuthorizationRequest.__proto__||Object.getPrototypeOf(AuthorizationRequest)).call(this,intentId));_this89.onConfirm=function _callee120(){return regeneratorRuntime.async(function _callee120$(_context146){while(1){switch(_context146.prev=_context146.next){case 0:case'end':return _context146.stop();}}},null,_this90);};_this89.onCancel=function _callee121(){return regeneratorRuntime.async(function _callee121$(_context147){while(1){switch(_context147.prev=_context147.next){case 0:case'end':return _context147.stop();}}},null,_this90);};_this89.text=text;_this89.confirm=confirm;_this89.cancel=cancel;return _this89;}_createClass(AuthorizationRequest,[{key:'message',value:function message(){return{controlId:this.intentId,message:this.text,confirm:this.confirm,cancel:this.cancel};}},{key:'onMatching',get:function get(){var _this91=this;return function(state){return state.messageTypeFromUser===AuthorizationRequest.MESSAGE_RESPONSE()&&state.messageFromUser.controlId===_this91.intentId;};}},{key:'onResolution',get:function get(){var _this92=this;return function _callee122(state){return regeneratorRuntime.async(function _callee122$(_context148){while(1){switch(_context148.prev=_context148.next){case 0:if(!(state.messageFromUser.action===AuthorizationRequest.CONFIRM_ACTION())){_context148.next=5;break;}_context148.next=3;return regeneratorRuntime.awrap(_this92.onConfirm());case 3:_context148.next=11;break;case 5:if(!(state.messageFromUser.action===AuthorizationRequest.CANCEL_ACTION())){_context148.next=10;break;}_context148.next=8;return regeneratorRuntime.awrap(_this92.onCancel());case 8:_context148.next=11;break;case 10:state.addSystemErrorToStack(28,Error.getErrorMessageforCodeAndLang(28));case 11:if(state.responsesArray.length===0){state.addSilentResponse();}case 12:case'end':return _context148.stop();}}},null,_this92);};}}]);return AuthorizationRequest;}(Intent);var Doc=function(_Form){_inherits(Doc,_Form);function Doc(intentId,botState,_ref35){var _ref35$title=_ref35.title,title=_ref35$title===undefined?'Lookup':_ref35$title,_ref35$description=_ref35.description,description=_ref35$description===undefined?'lookup':_ref35$description,_ref35$allowMinimize=_ref35.allowMinimize,allowMinimize=_ref35$allowMinimize===undefined?true:_ref35$allowMinimize,_ref35$allowClose=_ref35.allowClose,allowClose=_ref35$allowClose===undefined?true:_ref35$allowClose,_ref35$minimizeOnConf=_ref35.minimizeOnConfirm,minimizeOnConfirm=_ref35$minimizeOnConf===undefined?true:_ref35$minimizeOnConf,confirm=_ref35.confirm,cancel=_ref35.cancel,icon=_ref35.icon,_ref35$readOnly=_ref35.readOnly,readOnly=_ref35$readOnly===undefined?false:_ref35$readOnly,_ref35$allowEdit=_ref35.allowEdit,allowEdit=_ref35$allowEdit===undefined?true:_ref35$allowEdit,zone=_ref35.zone,parentDoc=_ref35.parentDoc,_ref35$autoSave=_ref35.autoSave,autoSave=_ref35$autoSave===undefined?false:_ref35$autoSave,modal=_ref35.modal;_classCallCheck(this,Doc);var _this93=_possibleConstructorReturn(this,(Doc.__proto__||Object.getPrototypeOf(Doc)).call(this,intentId,{title:title,description:description,allowMinimize:allowMinimize,allowClose:allowClose,minimizeOnConfirm:minimizeOnConfirm,confirm:confirm,cancel:cancel,icon:icon,readOnly:readOnly,allowEdit:allowEdit,zone:zone,modal:modal}));_this93._botState=botState;_this93._children=[];_this93._document={};_this93._subDoc=false;_this93._subDocs=[];_this93._subCollections=[];_this93._autoSave=autoSave;if(parentDoc){if(parentDoc instanceof Doc){_this93._subDoc=true;parentDoc.addChildDoc(_this93);}else{_this93._botState.addSystemErrorToStack(7,'Sub documents cannot be saved '+_this93._intentId);}}return _this93;}_createClass(Doc,[{key:'setCollection',value:function setCollection(collection){this._collection=collection._name;}},{key:'getPrimaryKey',value:function getPrimaryKey(){var _=this._botState._;var D=this._botState.developer;var primaryKey={};_.forEach(this._fields,function(field){if(field.primaryKey&&field.value){primaryKey[field._intentId]=field.value;}});return primaryKey;}},{key:'getPrimaryKeyAsStringForSearch',value:function getPrimaryKeyAsStringForSearch(object){var _this94=this;var result="";this._botState._.forEach(object,function(field){var f=field;if(typeof field!=='string'){f=_this94._botState.R.toString(field);}if(result===""){result=result+f;}else{result=result+"-"+f;}});return result;}},{key:'getNonPrimaryKey',value:function getNonPrimaryKey(){var _=this._botState._;var D=this._botState.developer;var primaryKey={};_.forEach(this._fields,function(field){if(!field.primaryKey&&field.value){primaryKey[field._intentId]=field.value;}});return primaryKey;}},{key:'buildDocumentFromContainer',value:function buildDocumentFromContainer(container){var _this95=this;var _=this._botState._;var D=this._botState.developer;var rootDoc=container[this.intentId];if(typeof rootDoc!=='undefined'){this.buildDocument(rootDoc);}else{this.buildDocument(container);}D.debug({message:'Passed first build',data:container});_.forEach(container,function(content,key){if(key!==_this95.intentId){if(Array.isArray(content)){D.debug({message:'Found a collection',data:key});var collectionIndex=_.findIndex(_this95._subCollections,function(subCollection){return subCollection.intentId===key;});if(collectionIndex>-1){var collection=_this95._subCollections[collectionIndex];var doc=collection.document;var childArray=[];_.forEach(content,function(entry){D.debug({message:'Entry',data:entry});var newDoc=_.cloneDeep(doc);newDoc.buildDocument(entry);collection.addRow(newDoc);childArray.push(newDoc.document);});_this95._document[collection.intentId]=childArray;}}else{var docIndex=_.findIndex(_this95._subDocs,function(subDoc){return subDoc.intentId===key;});if(docIndex>-1){D.debug({message:'Found object',data:docIndex});var _doc=_this95._subDocs[docIndex];D.debug({message:'Found object',data:key});_doc.buildDocument(content);_this95._document[_doc.intentId]=_doc.document;}}}});return this._document;}},{key:'buildDocument',value:function buildDocument(docFromDB){var _this96=this;var _=this._botState._;var D=this._botState.developer;var doc={};_.forEach(docFromDB,function(value,key){if(key==='_id'){}else{_.forEach(_this96._fields,function(field){if(field._intentId===key||field.title===key){var v=docFromDB[key];if(typeof v==='object'&&_.get(v,'text')){v=_.get(v,'text');}field.value=v;doc[field._intentId]=field.value;}});}});this._document=doc;return this._document;}},{key:'clearDocument',value:function clearDocument(){var _=this._botState._;var D=this._botState.developer;this._document={};_.forEach(this._fields,function(field){if(!field.primaryKey){field._value=field._originalValue;}});}},{key:'loadDocument',value:function loadDocument(){var _,R,D,primaryKey,results,payload;return regeneratorRuntime.async(function loadDocument$(_context149){while(1){switch(_context149.prev=_context149.next){case 0:if(!this._subDoc){_context149.next=3;break;}this._botState.addSystemErrorToStack(7,'Sub documents cannot be loaded '+this._intentId);return _context149.abrupt('return');case 3:if(this._collection){_context149.next=6;break;}this._botState.addSystemErrorToStack(7,'Collection not assigned to document '+this._intentId);return _context149.abrupt('return');case 6:_=this._botState._;R=this._botState.R;D=this._botState.developer;this.clearDocument();primaryKey=this.getPrimaryKey();if(!(_.size(primaryKey)>0)){_context149.next=31;break;}_context149.next=14;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:this._collection,query:primaryKey}));case 14:results=_context149.sent;if(!(results.statusCode===200)){_context149.next=28;break;}payload=results.body;if(!(Array.isArray(payload)&&payload.length===1)){_context149.next=25;break;}if(!this.hasSubDocs){_context149.next=22;break;}return _context149.abrupt('return',this.buildDocumentFromContainer(payload[0]));case 22:return _context149.abrupt('return',this.buildDocument(payload[0]));case 23:_context149.next=26;break;case 25:if(Array.isArray(payload)&&payload.length>1){this._botState.addErrorToStack(7,'Multiple records returned by query while expecting only one');}else if(Array.isArray(payload)&&payload.length===0){}case 26:_context149.next=29;break;case 28:this._botState.addSystemErrorToStack(7,'Error reading MongoDB');case 29:_context149.next=32;break;case 31:this._botState.addErrorToStack(7,'You need to add some values to the key to call getRecord');case 32:case'end':return _context149.stop();}}},null,this);}},{key:'getRecordHierarchy',value:function getRecordHierarchy(){var _this97=this;var _,R,D,getChildRecord,promisesArray;return regeneratorRuntime.async(function getRecordHierarchy$(_context151){while(1){switch(_context151.prev=_context151.next){case 0:_=this._botState._;R=this._botState.R;D=this._botState.developer;getChildRecord=function getChildRecord(child){var result;return regeneratorRuntime.async(function getChildRecord$(_context150){while(1){switch(_context150.prev=_context150.next){case 0:result={};_context150.next=3;return regeneratorRuntime.awrap(child.findRecords(_this97.keys));case 3:result[child._intentId]=_context150.sent;return _context150.abrupt('return',result);case 5:case'end':return _context150.stop();}}},null,_this97);};promisesArray=[this.getRecord()];_.forEach(this._children,function(child){promisesArray.push(getChildRecord(child));});return _context151.abrupt('return',Promise.all(promisesArray).then(function(values){if(Array.isArray(values)&&values.length>0){var parent={};var children={};_.forEach(values,function(value){if(value){var key=R.keys(value)[0];if(key===_this97._intentId){parent=value[key];}else{children[key]=value[key];}}});_.forEach(children,function(value,key){parent[key]=value;});_this97._document=parent;return _this97._document;}else{_this97._botState.addErrorToStack(7,'Error creating mongo hierarchy');}}).catch(function(error){_this97._botState.addErrorToStack(7,'Error accessing mongo hierarchy');}));case 7:case'end':return _context151.stop();}}},null,this);}},{key:'getHistory',value:function getHistory(){}},{key:'save',value:function save(){var D,query,options;return regeneratorRuntime.async(function save$(_context152){while(1){switch(_context152.prev=_context152.next){case 0:D=this._botState.developer;if(!this._subDoc){_context152.next=4;break;}this._botState.addSystemErrorToStack(7,'Sub documents cannot be saved '+this._intentId);return _context152.abrupt('return');case 4:query=this.getPrimaryKey();options={upsert:true};D.info({message:'Saving doc',data:{collection:this._collection,document:this._document,query:query}});_context152.next=9;return regeneratorRuntime.awrap(this._botState.db.updateDataInCollection({collection:this._collection,document:this._document,query:query,options:options}));case 9:case'end':return _context152.stop();}}},null,this);}},{key:'delete',value:function _delete(){var D,query;return regeneratorRuntime.async(function _delete$(_context153){while(1){switch(_context153.prev=_context153.next){case 0:D=this._botState.developer;D.info({message:'Deleting doc',data:{collection:this._collection,document:this._document}});query=this.getPrimaryKey();_context153.next=5;return regeneratorRuntime.awrap(this._botState.db.deleteDataFromCollection({collection:this._collection,document:this._document,query:query}));case 5:case'end':return _context153.stop();}}},null,this);}},{key:'addChildDoc',value:function addChildDoc(child){if(child instanceof Doc){this._subDocs.push(child);}else if(child instanceof Collection){this._subCollections.push(child);}else{this._botState.addSystemErrorToStack(7,'Child must be instance of either Doc or Collection classes '+this._intentId);return false;}return true;}},{key:'loadDocFromAutoSaveBuffer',value:function loadDocFromAutoSaveBuffer(){var _this98=this;var _=this._botState._;_.forEach(this._fields,function(field){field.value=_this98._botState.getField(Field.FIELD_BUFFER_PREFIX()+field.id);});}},{key:'clearAutoSaveBuffer',value:function clearAutoSaveBuffer(){var _this99=this;var _=this._botState._;_.forEach(this._fields,function(field){_this99._botState.clearField(Field.FIELD_BUFFER_PREFIX()+field.id);});}},{key:'document',get:function get(){var _this100=this;var _=this._botState._;if(_.size(this._document)===0){_.forEach(this._fields,function(field){_this100._document[field._intentId]=field.value;});}return this._document;},set:function set(doc){this._document=doc;}},{key:'hasSubDocs',get:function get(){if(this._subDocs.length>0||this._subCollections.length>0){return true;}return false;}},{key:'autoSave',get:function get(){return this._autoSave;}},{key:'onResolution',get:function get(){var _this101=this;return function _callee123(state){var document;return regeneratorRuntime.async(function _callee123$(_context154){while(1){switch(_context154.prev=_context154.next){case 0:state.currentControlId=_this101.intentId;document=Form2.formResponseAsObject(state.messageFromUser);state.developer.info({message:"The document coming in the Doc",data:document});_this101.buildDocument(document);_context154.next=6;return regeneratorRuntime.awrap(_this101._callEvents(state));case 6:case'end':return _context154.stop();}}},null,_this101);};}}]);return Doc;}(Form2);var Entity=function(){function Entity(_ref36){var entityName=_ref36.entityName,botState=_ref36.botState,parent=_ref36.parent,_ref36$keys=_ref36.keys,keys=_ref36$keys===undefined?{}:_ref36$keys;_classCallCheck(this,Entity);this._entityName=entityName;this._keys=keys;this._fields={};this._botState=botState;this._children=[];if(parent)parent._children.push(this);}_createClass(Entity,[{key:'findRecords',value:function findRecords(_ref37){var _ref37$query=_ref37.query,query=_ref37$query===undefined?{}:_ref37$query;var results,payload;return regeneratorRuntime.async(function findRecords$(_context155){while(1){switch(_context155.prev=_context155.next){case 0:_context155.next=2;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:this._entityName,query:query}));case 2:results=_context155.sent;if(!(results.statusCode===200)){_context155.next=9;break;}payload=results.body;if(!(Array.isArray(payload)&&payload.length>0)){_context155.next=9;break;}return _context155.abrupt('return',payload);case 9:case'end':return _context155.stop();}}},null,this);}},{key:'getRecord',value:function getRecord(){var _this102=this;var _,R,D,results,payload,record,fields,keys,result;return regeneratorRuntime.async(function getRecord$(_context156){while(1){switch(_context156.prev=_context156.next){case 0:_=this._botState._;R=this._botState.R;D=this._botState.developer;if(!(_.size(this._keys)>0)){_context156.next=26;break;}_context156.next=6;return regeneratorRuntime.awrap(this._botState.db.getDataFromCollection({collection:this._entityName,query:this._keys}));case 6:results=_context156.sent;if(!(results.statusCode===200)){_context156.next=23;break;}payload=results.body;if(!(Array.isArray(payload)&&payload.length===1)){_context156.next=20;break;}record=payload[0];fields={};keys=R.keys(this._keys);_.forEach(record,function(value,key){if(key==='_id'){_this102['_id']=value;}else{if(keys.indexOf(key)===-1){fields[key]=value;}}});this.fields=fields;result={};result[this._entityName]=this.document;return _context156.abrupt('return',result);case 20:if(Array.isArray(payload)&&payload.length>1){this._botState.addErrorToStack(7,'Multiple records returned by query while expecting only one');}else if(Array.isArray(payload)&&payload.length===0){this._botState.addErrorToStack(7,'No data has been found with this key');}case 21:_context156.next=24;break;case 23:this._botState.addSystemErrorToStack(7,'Error reading MongoDB');case 24:_context156.next=27;break;case 26:this._botState.addErrorToStack(7,'You need to add some values to the key to call getRecord');case 27:case'end':return _context156.stop();}}},null,this);}},{key:'getRecordHierarchy',value:function getRecordHierarchy(){var _this103=this;var _,R,D,getChildRecord,promisesArray;return regeneratorRuntime.async(function getRecordHierarchy$(_context158){while(1){switch(_context158.prev=_context158.next){case 0:_=this._botState._;R=this._botState.R;D=this._botState.developer;getChildRecord=function getChildRecord(child){var result;return regeneratorRuntime.async(function getChildRecord$(_context157){while(1){switch(_context157.prev=_context157.next){case 0:result={};_context157.next=3;return regeneratorRuntime.awrap(child.findRecords(_this103.keys));case 3:result[child.entityName]=_context157.sent;return _context157.abrupt('return',result);case 5:case'end':return _context157.stop();}}},null,_this103);};promisesArray=[this.getRecord()];_.forEach(this._children,function(child){promisesArray.push(getChildRecord(child));});return _context158.abrupt('return',Promise.all(promisesArray).then(function(values){if(Array.isArray(values)&&values.length>0){var parent={};var children={};_.forEach(values,function(value){if(value){var key=R.keys(value)[0];if(key===_this103._entityName){parent=value[key];}else{children[key]=value[key];}}});_.forEach(children,function(value,key){parent[key]=value;});return parent;}else{_this103._botState.addErrorToStack(7,'Error creating mongo hierarchy');}}).catch(function(error){_this103._botState.addErrorToStack(7,'Error accessing mongo hierarchy');}));case 7:case'end':return _context158.stop();}}},null,this);}},{key:'getHistory',value:function getHistory(){}},{key:'save',value:function save(){var document;return regeneratorRuntime.async(function save$(_context159){while(1){switch(_context159.prev=_context159.next){case 0:document=_extends({},this._keys,this._fields);_context159.next=3;return regeneratorRuntime.awrap(this._botState.db.insertDocumentInCollection({collection:this._entityName,document:document}));case 3:case'end':return _context159.stop();}}},null,this);}},{key:'delete',value:function _delete(){}},{key:'keys',get:function get(){return this._keys;},set:function set(keys){this._keys=keys;}},{key:'fields',get:function get(){return this._fields;},set:function set(fields){this._fields=fields;}},{key:'document',get:function get(){return _extends({},this._keys,this._fields);}},{key:'entityName',get:function get(){return this._entityName;}}]);return Entity;}();var DB=function(){_createClass(DB,null,[{key:'CONVERSATIONS_INDEX',value:function CONVERSATIONS_INDEX(){return'conversations*';}}]);function DB(botState){_classCallCheck(this,DB);this['_botState']=botState;this['_']=botState._;}_createClass(DB,[{key:'checkMongoResponse',value:function checkMongoResponse(response){var results=response.Payload;var chkResults=JSON.parse(results);if(chkResults.statusCode===500){this._botState.addSystemErrorToStack(7,"Error writing in database with error "+response.Payload);}return JSON.parse(results);}},{key:'getDataFromCollection',value:function getDataFromCollection(_ref38){var collection=_ref38.collection,_ref38$query=_ref38.query,query=_ref38$query===undefined?{}:_ref38$query,_ref38$projection=_ref38.projection,projection=_ref38$projection===undefined?{}:_ref38$projection,_ref38$sort=_ref38.sort,sort=_ref38$sort===undefined?{}:_ref38$sort,_ref38$skip=_ref38.skip,skip=_ref38$skip===undefined?0:_ref38$skip,_ref38$limit=_ref38.limit,limit=_ref38$limit===undefined?20:_ref38$limit,collation=_ref38.collation;var params,lambda,_response4;return regeneratorRuntime.async(function getDataFromCollection$(_context160){while(1){switch(_context160.prev=_context160.next){case 0:_context160.prev=0;params={action:'query',db:this._botState.currentUserDomain,collection:collection,query:query,projection:projection,sort:sort,skip:skip,limit:limit,collation:collation};lambda=this._botState.frontmlib;_context160.next=5;return regeneratorRuntime.awrap(lambda.invokeLambda('MongoDBManager','RequestResponse',params));case 5:_response4=_context160.sent;return _context160.abrupt('return',this.checkMongoResponse(_response4));case 9:_context160.prev=9;_context160.t0=_context160['catch'](0);this._botState.addSystemErrorToStack(26,'3 '+_context160.t0.name+': '+_context160.t0.message);case 12:case'end':return _context160.stop();}}},null,this,[[0,9]]);}},{key:'insertDataInCollection',value:function insertDataInCollection(_ref39){var collection=_ref39.collection,documentsArray=_ref39.documentsArray;return regeneratorRuntime.async(function insertDataInCollection$(_context161){while(1){switch(_context161.prev=_context161.next){case 0:case'end':return _context161.stop();}}},null,this);}},{key:'insertDocumentInCollection',value:function insertDocumentInCollection(_ref40){var _this104=this;var collection=_ref40.collection,document=_ref40.document;var params;return regeneratorRuntime.async(function insertDocumentInCollection$(_context162){while(1){switch(_context162.prev=_context162.next){case 0:params={action:'insertOne',db:this._botState.currentUserDomain,collection:collection,document:document};return _context162.abrupt('return',callLambda('MongoDBManager',params,this._botState.aws).then(function(response){return _this104.checkMongoResponse(response);}).catch(function(error){_this104._botState.addSystemErrorToStack(7,error.errorMessage);}));case 2:case'end':return _context162.stop();}}},null,this);}},{key:'updateDataInCollection',value:function updateDataInCollection(_ref41){var _this105=this;var collection=_ref41.collection,document=_ref41.document,query=_ref41.query,options=_ref41.options;var params;return regeneratorRuntime.async(function updateDataInCollection$(_context163){while(1){switch(_context163.prev=_context163.next){case 0:params={action:'update',db:this._botState.currentUserDomain,collection:collection,document:document,query:query,options:options};return _context163.abrupt('return',callLambda('MongoDBManager',params,this._botState.aws).then(function(response){return _this105.checkMongoResponse(response);}).catch(function(error){_this105._botState.addSystemErrorToStack(7,error.errorMessage);}));case 2:case'end':return _context163.stop();}}},null,this);}},{key:'deleteDataFromCollection',value:function deleteDataFromCollection(_ref42){var _this106=this;var collection=_ref42.collection,query=_ref42.query;var params;return regeneratorRuntime.async(function deleteDataFromCollection$(_context164){while(1){switch(_context164.prev=_context164.next){case 0:params={action:'delete',db:this._botState.currentUserDomain,collection:collection,query:query};return _context164.abrupt('return',callLambda('MongoDBManager',params,this._botState.aws).then(function(response){return _this106.checkMongoResponse(response);}).catch(function(error){_this106._botState.addSystemErrorToStack(7,error.errorMessage);}));case 2:case'end':return _context164.stop();}}},null,this);}},{key:'getCatalogue',value:function getCatalogue(_ref43){var query=_ref43.query,userDomain=_ref43.userDomain;var params,_response5;return regeneratorRuntime.async(function getCatalogue$(_context165){while(1){switch(_context165.prev=_context165.next){case 0:_context165.prev=0;params={query:query,isAllBotsRequest:true,selectedDomain:userDomain,email:this._botState.user.userEmail};this._botState.developer.log({message:'getCatalogue',data:params});_context165.next=5;return regeneratorRuntime.awrap(callLambda('catalogueLambda',params,this._botState.aws));case 5:_response5=_context165.sent;if(!_response5){_context165.next=9;break;}this._botState.developer.log({message:'getCatalogue response',data:_response5});return _context165.abrupt('return',JSON.parse(_response5.Payload));case 9:_context165.next=15;break;case 11:_context165.prev=11;_context165.t0=_context165['catch'](0);this._botState.developer.log({message:'getCatalogue error response',data:_context165.t0});this._botState.addSystemErrorToStack(7,_context165.t0.errorMessage);case 15:case'end':return _context165.stop();}}},null,this,[[0,11]]);}},{key:'getStaticData',value:function getStaticData(query,scan,pagination,sort){var tableName='KeyValues_'+this._botState.currentUserDomain;console.log(tableName);return this.getData(tableName,query,scan,pagination,sort);}},{key:'getData',value:function getData(table,query,scan,pagination,sort){var _this107=this;var params={collection:table,query:query,scan:scan,capability:'GetData',pagination:pagination,sort:sort,sync:true};return callLambda('SystemCapabilities',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this107._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'getDataFromIndex',value:function getDataFromIndex(index,queryString,pageSize,sort,exactMatch){var _this108=this;var params={method:'GET',action:'search',index:this._botState._.toLower(index),q:queryString,size:pageSize,sort:sort,exact:exactMatch};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this108._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'getDataFromIndexWithID',value:function getDataFromIndexWithID(index,type,id){var _this109=this;var params={method:'GET_WITH_ID',index:this._botState._.toLower(index),docType:type,id:id};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this109._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'getDataFromIndexWithSQL',value:function getDataFromIndexWithSQL(queryString){var _this110=this;var params={method:'SQL',q:queryString};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this110._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'deleteDataFromIndex',value:function deleteDataFromIndex(index,type,objectId){var _this111=this;var params={method:'DELETE',index:this._botState._.toLower(index),q:objectId,docType:type};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this111._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'deleteDataFromIndexByID',value:function deleteDataFromIndexByID(index,type,objectId){var _this112=this;var params={method:'DELETE',index:this._botState._.toLower(index),docType:type,id:objectId};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this112._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'getDataFromIndexWithQueryObject',value:function getDataFromIndexWithQueryObject(index,queryObject){var _this113=this;var params={method:'GET',action:'bodySearch',index:this._botState._.toLower(index),q:queryObject};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){console.log(JSON.stringify(response));return JSON.parse(response.Payload);}).catch(function(error){console.log(JSON.stringify(response));_this113._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'countDataInIndex',value:function countDataInIndex(index,queryString){var _this114=this;var params={method:'GET',action:'count',index:this._botState._.toLower(index),q:queryString};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this114._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'writeDataIntoIndex',value:function writeDataIntoIndex(index,docType,doc){var _this115=this;var params={method:'POST',action:'insert',index:this._botState._.toLower(index),docType:docType,doc:doc};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this115._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'bulkWriteDataIntoIndex',value:function bulkWriteDataIntoIndex(_ref44){var _this116=this;var index=_ref44.index,_ref44$docType=_ref44.docType,docType=_ref44$docType===undefined?'_doc':_ref44$docType,docs=_ref44.docs,docIdField=_ref44.docIdField;var params={method:'BULK_INSERT',action:'insert',index:this._botState._.toLower(index),docType:docType,docs:docs,docIdField:docIdField};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this116._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'updateDataInIndex',value:function updateDataInIndex(index,docType,doc){var _this117=this;var params={method:'PUT',docType:docType,index:this._botState._.toLower(index),doc:doc,id:doc.id};return callLambda('elastiSearch',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this117._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'writeTransactionData',value:function writeTransactionData(documents){var tableName='Transactions_'+this._botState.currentUserDomain;return this.writeData(tableName,documents);}},{key:'writeStaticData',value:function writeStaticData(documents){var tableName='KeyValues_'+this._botState.currentUserDomain;return this.writeData(tableName,documents);}},{key:'writeData',value:function writeData(table,documents){var _this118=this;var params={collection:table,documents:documents,capability:'WriteData'};return callLambda('SystemCapabilities',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this118._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'deleteTransactionData',value:function deleteTransactionData(query){var tableName='Transactions_'+this._botState.currentUserDomain;return this.deleteData(tableName,query);}},{key:'deleteStaticData',value:function deleteStaticData(query){var tableName='KeyValues_'+this._botState.currentUserDomain;return this.deleteData(tableName,query);}},{key:'deleteData',value:function deleteData(table,query){var _this119=this;var params={collection:table,query:query,capability:'DeleteData'};return callLambda('SystemCapabilities',params,this._botState.aws).then(function(response){return JSON.parse(response.Payload);}).catch(function(error){_this119._botState.addSystemErrorToStack(7,error.errorMessage);});}},{key:'strigifyValue',value:function strigifyValue(value){if(this._.isString(value)){return value;}return this._.isObjectLike(value)?JSON.stringify(value):this._.toString(value);}},{key:'createParamsForAdd',value:function createParamsForAdd(keyValuePairs){var _this120=this;if(!this._.isArray(keyValuePairs)){keyValuePairs=[keyValuePairs];}return keyValuePairs.map(function(keyValue){var key=keyValue.key,value=keyValue.value,expiry=keyValue.expiry,isArrayElement=keyValue.isArrayElement,index=keyValue.index;value=_this120.strigifyValue(value);return{key:key,value:value,expiry:expiry,isArrayElement:isArrayElement,index:index};});}},{key:'callRedisWriteQueue',value:function callRedisWriteQueue(keyValuePairs){var lambdaParams={action:'add',data:keyValuePairs};return callLambda('RedisWriteQueue',lambdaParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:'callRedisDeleteQueue',value:function callRedisDeleteQueue(key){var lambdaParams={action:'delete',key:key};return callLambda('RedisWriteQueue',lambdaParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:'deleteOneKeyInCache',value:function deleteOneKeyInCache(key){return this.callRedisDeleteQueue(key);}},{key:'setOneValueInCache',value:function setOneValueInCache(key,value){return this.callRedisWriteQueue(this.createParamsForAdd({key:key,value:value}));}},{key:'setOneValueInCacheWithExpiry',value:function setOneValueInCacheWithExpiry(key,value,expiry){var lambdaParams=this.createParamsForAdd({key:key,value:value,expiry:expiry});return this.callRedisWriteQueue(lambdaParams);}},{key:'setMultipleValuesInCache',value:function setMultipleValuesInCache(keyValuePairs){return this.callRedisWriteQueue(this.createParamsForAdd(keyValuePairs));}},{key:'addOneListElementInCache',value:function addOneListElementInCache(key,value){return this.addMultipleListElementInCache({key:key,value:value});}},{key:'updateOneListElementInCache',value:function updateOneListElementInCache(key,value,index){return this.addMultipleListElementInCache({key:key,value:value,index:index});}},{key:'addMultipleListElementInCache',value:function addMultipleListElementInCache(keyValuePairs){if(!this._.isArray(keyValuePairs)){keyValuePairs=[keyValuePairs];}keyValuePairs=keyValuePairs.map(function(keyValue){keyValue.isArrayElement=true;return keyValue;});return this.callRedisWriteQueue(this.createParamsForAdd(keyValuePairs));}},{key:'getValueFromCache',value:function getValueFromCache(key){return this.getMultipleValuesFromCache(key).then(function(data){return data[key];});}},{key:'getMultipleValuesFromCache',value:function getMultipleValuesFromCache(keys){if(!this._.isArray(keys)){keys=[keys];}var lambdaParams={multiKeys:keys};return callLambda('RedisReadQueue',lambdaParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:'getKeysOnPattern',value:function getKeysOnPattern(pattern){var lambdaParams={pattern:pattern};return callLambda('RedisReadQueue',lambdaParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:'getUser',value:function getUser(userId){var frontmLib,userData;return regeneratorRuntime.async(function getUser$(_context166){while(1){switch(_context166.prev=_context166.next){case 0:_context166.prev=0;if(!(this._botState.location===Intent.CLOUD())){_context166.next=7;break;}frontmLib=this._botState.frontmlib;_context166.next=5;return regeneratorRuntime.awrap(frontmLib.getUser(userId));case 5:userData=_context166.sent;return _context166.abrupt('return',userData);case 7:_context166.next=12;break;case 9:_context166.prev=9;_context166.t0=_context166['catch'](0);this._botState.addSystemErrorToStack(7,error.errorMessage);case 12:case'end':return _context166.stop();}}},null,this,[[0,9]]);}}]);return DB;}();var ContactCentre=function(){_createClass(ContactCentre,null,[{key:'WAITING_STATUS',value:function WAITING_STATUS(){return'Waiting';}},{key:'WAITING_VESSEL_STATUS',value:function WAITING_VESSEL_STATUS(){return'WaitingVessel';}},{key:'ACTIVE_STATUS',value:function ACTIVE_STATUS(){return'Active';}},{key:'ENDED_STATUS',value:function ENDED_STATUS(){return'Ended';}},{key:'MISSED_STATUS',value:function MISSED_STATUS(){return'Missed';}},{key:'MISSED_CALL_TEXT',value:function MISSED_CALL_TEXT(){return'Missed call';}},{key:'CONTACT_CENTRE_APP',value:function CONTACT_CENTRE_APP(){return'callCentreBot';}},{key:'CLIENT_APP',value:function CLIENT_APP(){return'clientBot';}},{key:'MANAGER_APP',value:function MANAGER_APP(){return'shiftManagerBot';}}]);function ContactCentre(botState){_classCallCheck(this,ContactCentre);this['_botState']=botState;this['_']=botState._;}_createClass(ContactCentre,[{key:'getBotIDs',value:function getBotIDs(key){var query,response,items,botIDs;return regeneratorRuntime.async(function getBotIDs$(_context167){while(1){switch(_context167.prev=_context167.next){case 0:query=[{operand:'dataKey',value:key,operator:'eq'}];_context167.next=3;return regeneratorRuntime.awrap(this._botState.db.getStaticData(query));case 3:response=_context167.sent;items=this._.get(response,'items');if(!(Array.isArray(items)&&items.length>0)){_context167.next=9;break;}botIDs=items[0].value;if(!(this._.size(botIDs)>0)){_context167.next=9;break;}return _context167.abrupt('return',botIDs);case 9:case'end':return _context167.stop();}}},null,this);}},{key:'loadContactCentreTeam',value:function loadContactCentreTeam(contactCentreBotId){var SHIFT_MANAGER_KEY_PREFIX,pattern,_response6;return regeneratorRuntime.async(function loadContactCentreTeam$(_context168){while(1){switch(_context168.prev=_context168.next){case 0:if(!contactCentreBotId){_context168.next=14;break;}_context168.prev=1;SHIFT_MANAGER_KEY_PREFIX='CONTACT_CENTRE_SHIFT_';pattern=SHIFT_MANAGER_KEY_PREFIX+'_'+contactCentreBotId+'*';console.log(pattern);_context168.next=7;return regeneratorRuntime.awrap(this._botState.db.getKeysOnPattern(pattern));case 7:_response6=_context168.sent;return _context168.abrupt('return',_response6);case 11:_context168.prev=11;_context168.t0=_context168['catch'](1);botState.addSystemErrorToStack(100,'Error reading call centre staff '+this._botState.R.toString(_context168.t0));case 14:case'end':return _context168.stop();}}},null,this,[[1,11]]);}},{key:'getTranscriptionForCurrentConversation',value:function getTranscriptionForCurrentConversation(_ref45){var _this121=this;var epochTime=_ref45.epochTime,bot=_ref45.bot,conversation=_ref45.conversation;var params;return regeneratorRuntime.async(function getTranscriptionForCurrentConversation$(_context169){while(1){switch(_context169.prev=_context169.next){case 0:params={capability:'ArchivedMessagesReader',action:'getPaginatedMessages',conversationId:this._botState._.get(conversation,'conversationId')||this._botState.conversationId,bot:bot||this._botState.conversation.bot,sync:true,conversation:conversation||this._botState.conversation,capabilityDomain:this._botState.currentUserDomain,userEmail:this._botState.user.userEmail,userId:this._botState.user.userId,userDomain:this._botState.userDomains};return _context169.abrupt('return',callLambda('ArchivedMessagesReader',params,this._botState.aws).then(function(response){var payload=JSON.parse(response.Payload);console.log(_this121._botState.R.toString(response));return payload;}));case 2:case'end':return _context169.stop();}}},null,this);}},{key:'addEntryToContactCentreQueue',value:function addEntryToContactCentreQueue(entry,contactCentreBot){var chatForm,conversationToQueue,CONTACT_CENTRE_CACHE,OPEN_STATUS,key;return regeneratorRuntime.async(function addEntryToContactCentreQueue$(_context170){while(1){switch(_context170.prev=_context170.next){case 0:_context170.prev=0;chatForm=this._botState._.cloneDeep(entry);chatForm.botDetails=this._botState._.cloneDeep(contactCentreBot);chatForm.userId=this._botState.user.userId;conversationToQueue={ticket:Math.round(Math.random()*(99999999-1)+1),content:chatForm,createdOn:Date.now(),open:true,status:ContactCentre.WAITING_STATUS(),botId:this._botState.conversation.bot,conversationId:this._botState.conversationId,userId:this._botState.user.userId};CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';key=CONTACT_CENTRE_CACHE+'_'+OPEN_STATUS+'_'+this._botState.conversation.bot+'_'+this._botState.conversationId;_context170.next=10;return regeneratorRuntime.awrap(this._botState.db.setOneValueInCacheWithExpiry(key,conversationToQueue,3600*24*7));case 10:return _context170.abrupt('return',conversationToQueue);case 13:_context170.prev=13;_context170.t0=_context170['catch'](0);this._botState.addSystemErrorToStack(5,'Error adding entry to queue '+_context170.t0);case 16:case'end':return _context170.stop();}}},null,this,[[0,13]]);}},{key:'closeEntryInContactCentreQueue',value:function closeEntryInContactCentreQueue(entry){var CONTACT_CENTRE_CACHE,OPEN_STATUS,key;return regeneratorRuntime.async(function closeEntryInContactCentreQueue$(_context171){while(1){switch(_context171.prev=_context171.next){case 0:entry.open=false;entry.owner=this._botState.user.userId;CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';key=CONTACT_CENTRE_CACHE+'_'+OPEN_STATUS+'_'+entry.botId+'_'+entry.conversationId;_context171.next=7;return regeneratorRuntime.awrap(this._botState.db.setOneValueInCacheWithExpiry(key,entry,3600*24*7));case 7:return _context171.abrupt('return',entry);case 8:case'end':return _context171.stop();}}},null,this);}},{key:'changeQueueEntryStatus',value:function changeQueueEntryStatus(entry,status){var CONTACT_CENTRE_CACHE,OPEN_STATUS,key;return regeneratorRuntime.async(function changeQueueEntryStatus$(_context172){while(1){switch(_context172.prev=_context172.next){case 0:entry.status=status;CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';key=CONTACT_CENTRE_CACHE+'_'+OPEN_STATUS+'_'+entry.botId+'_'+entry.conversationId;_context172.next=6;return regeneratorRuntime.awrap(this._botState.db.setOneValueInCacheWithExpiry(key,entry,3600*24*7));case 6:return _context172.abrupt('return',entry);case 7:case'end':return _context172.stop();}}},null,this);}},{key:'changeQueueVideoSessionId',value:function changeQueueVideoSessionId(entry,videoSessionId){var CONTACT_CENTRE_CACHE,OPEN_STATUS,key;return regeneratorRuntime.async(function changeQueueVideoSessionId$(_context173){while(1){switch(_context173.prev=_context173.next){case 0:entry.content.videoSessionId=videoSessionId;CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';key=CONTACT_CENTRE_CACHE+'_'+OPEN_STATUS+'_'+entry.botId+'_'+entry.conversationId;_context173.next=6;return regeneratorRuntime.awrap(this._botState.db.setOneValueInCacheWithExpiry(key,entry,3600*24*7));case 6:return _context173.abrupt('return',entry);case 7:case'end':return _context173.stop();}}},null,this);}},{key:'storeQueueEntry',value:function storeQueueEntry(entry){var CONTACT_CENTRE_CACHE,OPEN_STATUS,key;return regeneratorRuntime.async(function storeQueueEntry$(_context174){while(1){switch(_context174.prev=_context174.next){case 0:CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';key=CONTACT_CENTRE_CACHE+'_'+OPEN_STATUS+'_'+entry.botId+'_'+entry.conversationId;_context174.next=5;return regeneratorRuntime.awrap(this._botState.db.setOneValueInCacheWithExpiry(key,entry,3600*24*7));case 5:return _context174.abrupt('return',entry);case 6:case'end':return _context174.stop();}}},null,this);}},{key:'loadConversationsInQueue',value:function loadConversationsInQueue(botId){var botToLoad,CONTACT_CENTRE_CACHE,OPEN_STATUS,pattern,_response7,parsedResponse,R;return regeneratorRuntime.async(function loadConversationsInQueue$(_context175){while(1){switch(_context175.prev=_context175.next){case 0:_context175.prev=0;botToLoad=botId||this._botState.conversation.bot;CONTACT_CENTRE_CACHE='CONTACT_CENTRE_';OPEN_STATUS='open';pattern=CONTACT_CENTRE_CACHE+'_'+OPEN_STATUS+'_'+botToLoad+'*';this._botState.developer.log({message:'Pattern key',data:pattern});_context175.next=8;return regeneratorRuntime.awrap(this._botState.db.getKeysOnPattern(pattern));case 8:_response7=_context175.sent;this._botState.developer.log({message:'Response from Redis',data:_response7});parsedResponse=[];R=this._botState.R;this._botState._.forEach(_response7,function(conversation){var parsedConversation=JSON.parse(conversation.content);var i=0;while(i<parsedResponse.length&&parsedConversation.createdOn>parsedResponse[i].createdOn){i++;}parsedResponse.splice(i,0,parsedConversation);});return _context175.abrupt('return',parsedResponse);case 16:_context175.prev=16;_context175.t0=_context175['catch'](0);this._botState.addSystemErrorToStack(100,'Error reading conversations '+this._botState.R.toString(_context175.t0));case 19:case'end':return _context175.stop();}}},null,this,[[0,16]]);}},{key:'getQueueEntry',value:function getQueueEntry(_ref46){var videoSessionId=_ref46.videoSessionId,botId=_ref46.botId,ticket=_ref46.ticket;var parsedQueue,index,i;return regeneratorRuntime.async(function getQueueEntry$(_context176){while(1){switch(_context176.prev=_context176.next){case 0:_context176.next=2;return regeneratorRuntime.awrap(this.loadConversationsInQueue(botId));case 2:parsedQueue=_context176.sent;console.log('Queue to search for '+this._botState.R.toString(parsedQueue));console.log(videoSessionId);index=-1;for(i=0;i<parsedQueue.length;i++){if(videoSessionId&&parsedQueue[i].content.videoSessionId===videoSessionId||ticket&&parsedQueue[i].ticket===ticket){index=i;}}console.log(index);return _context176.abrupt('return',parsedQueue[index]);case 9:case'end':return _context176.stop();}}},null,this);}},{key:'loadConversationsForBot',value:function loadConversationsForBot(botId,pagination,sort){var size,from,docQuery,rangeDuration,allConversations,finalResponse;return regeneratorRuntime.async(function loadConversationsForBot$(_context177){while(1){switch(_context177.prev=_context177.next){case 0:_context177.prev=0;size=this._botState._.get(pagination,'size')||6;from=this._botState._.get(pagination,'from')||0;docQuery={_source:['conversationId','createdOn','modifiedOn','duration'],query:{bool:{must:{term:{bot:botId}}}},sort:{createdOn:{order:'desc'}},size:size};rangeDuration={duration:{gte:10000}};if(from===0){docQuery.query.bool.filter={range:rangeDuration};}else{docQuery.query.bool.filter=[{range:rangeDuration},{range:{createdOn:{lt:from}}}];}this._botState.developer.log({message:'Query object',data:docQuery});_context177.next=9;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(DB.CONVERSATIONS_INDEX(),docQuery));case 9:allConversations=_context177.sent;this._botState.developer.log({message:'Query response',data:allConversations});finalResponse=[];this._botState._.forEach(allConversations,function(conversation){finalResponse.push(conversation);});return _context177.abrupt('return',finalResponse);case 16:_context177.prev=16;_context177.t0=_context177['catch'](0);this._botState.addSystemErrorToStack(100,'Error reading conversations '+this._botState.R.toString(_context177.t0));case 19:case'end':return _context177.stop();}}},null,this,[[0,16]]);}},{key:'loadConversationData',value:function loadConversationData(conversationId){var tableName,query;return regeneratorRuntime.async(function loadConversationData$(_context178){while(1){switch(_context178.prev=_context178.next){case 0:_context178.prev=0;tableName='Conversations';console.log(tableName);query=[{operand:'conversationId',value:conversationId,operator:'eq'}];return _context178.abrupt('return',this._botState.db.getData(tableName,query));case 7:_context178.prev=7;_context178.t0=_context178['catch'](0);this._botState.addSystemErrorToStack(100,'Error reading conversations '+this._botState.R.toString(_context178.t0));case 10:case'end':return _context178.stop();}}},null,this,[[0,7]]);}},{key:'getConfigurationForKey',value:function getConfigurationForKey(key){var query,response,items,botIDs;return regeneratorRuntime.async(function getConfigurationForKey$(_context179){while(1){switch(_context179.prev=_context179.next){case 0:query=[{operand:'dataKey',value:key,operator:'eq'}];_context179.next=3;return regeneratorRuntime.awrap(this._botState.db.getStaticData(query));case 3:response=_context179.sent;items=this._botState._.get(response,'items');this._botState.developer.log({message:'Found Static data',data:response});if(!(Array.isArray(items)&&items.length>0)){_context179.next=9;break;}botIDs=items[0].value;return _context179.abrupt('return',botIDs);case 9:case'end':return _context179.stop();}}},null,this);}}]);return ContactCentre;}();var API=function(){function API(botState){_classCallCheck(this,API);this['_botState']=botState;this['_']=botState._;}_createClass(API,[{key:'loadServicesForMyDomains',value:function loadServicesForMyDomains(){var tableName='APIParameters';var query=[{operand:'userDomain',value:this._botState.currentUserDomain,operator:'eq'}];return this._botState.db.getData(tableName,query);}},{key:'createNewService',value:function createNewService(service){var tableName,response;return regeneratorRuntime.async(function createNewService$(_context180){while(1){switch(_context180.prev=_context180.next){case 0:tableName='APIParameters';_context180.next=3;return regeneratorRuntime.awrap(this._botState.db.writeData(tableName,service));case 3:response=_context180.sent;if(this._.get(response,"errorMessage")){this._botState.addSystemErrorToStack(36);}case 5:case'end':return _context180.stop();}}},null,this);}},{key:'callService',value:function callService(service,options){var _this122=this;this._botState.developer.log({message:'Inside call service'});var params={capability:'GetDataFromAPI',capabilityFileName:'getDataFromApi',userDomain:this._botState.conversation.userDomain,serviceName:service,queryParams:this._.get(options,'queryParams'),pathParams:this._.get(options,'pathParams'),header:this._.get(options,'header'),body:this._.get(options,'body'),sync:true,userId:this._botState.user.userId,conversation:this._botState.conversation};try{return this._botState.callCapability(params).then(function(response){_this122._botState.developer.info({message:'Returned from service successfully',data:_this122._botState.R.toString(response)});if(_this122._.get(response,'error')){_this122._botState.addSystemErrorToStack(37,response.error,response);}return response;}).catch(function(error){_this122._botState.addSystemErrorToStack(37,error.message,params);return error;});}catch(err){this._botState.addSystemErrorToStack(37,err.message,params);}}},{key:'createUser',value:function createUser(userDetailsArray){var _this123=this;var params={capability:'UserOnboardingCapability',capabilityFileName:'userOnboardingCapability',users:userDetailsArray};var capabilities=this._botState.context.capabilities.capabilities;var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){try{return capabilityModule.execute(params,this._botState.context.capabilities).then(function(response){_this123._botState.developer.info({message:'Returned from service create user',data:_this123._botState.R.toString(response)});if(_this123._.get(response,'error')){_this123._botState.addSystemErrorToStack(7,response.error);}return response;}).catch(function(error){_this123._botState.addSystemErrorToStack(7,error.errorMessage);return error;});}catch(err){this._botState.addSystemErrorToStack(7,this._botState.R.toString(err));}}}},{key:'encodeFile',value:function encodeFile(fileName){var params;return regeneratorRuntime.async(function encodeFile$(_context181){while(1){switch(_context181.prev=_context181.next){case 0:params={capability:'ConversationFilesCapability',capabilityFileName:'conversationFilesCapability',targetConversationId:this._botState.conversationId,targetFileName:fileName,conversation:this._botState.conversation,sync:true,email:this._botState.user.userEmail,userId:this._botState.user.userId};_context181.next=3;return regeneratorRuntime.awrap(this._botState.callCapability(params));case 3:return _context181.abrupt('return',_context181.sent);case 4:case'end':return _context181.stop();}}},null,this);}}]);return API;}();var JobScheduler=function(){function JobScheduler(botState){_classCallCheck(this,JobScheduler);this['_botState']=botState;this['_']=botState._;}_createClass(JobScheduler,[{key:'addNewJob',value:function addNewJob(client,params,jobId,repeats){console.log('Started adding job');var scheduleJobParams={jobId:jobId,capability:'ScheduleBatchJob',conversation:this._botState.conversation,params:this._botState.cleanFieldsForSave(params),repeats:repeats,requestUuid:this._botState.getUniqueId(),scheduledCapability:this._botState.conversation.bot+'_CustomCap',userEmail:this._botState.user.userEmail,userId:this._botState.user.userId,userDomain:this._botState.conversation.userDomain,botId:this._botState.conversation.bot,client:client,schedule:this._.get(params,'schedule')};console.log(this._botState.R.toString(scheduleJobParams));return callLambda('SystemCapabilities',scheduleJobParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:'scheduleMessage',value:function scheduleMessage(_ref47){var _ref47$toBot=_ref47.toBot,toBot=_ref47$toBot===undefined?this._botState.conversation.bot:_ref47$toBot,toUser=_ref47.toUser,messages=_ref47.messages,_ref47$jobId=_ref47.jobId,jobId=_ref47$jobId===undefined?this._botState.getUniqueId():_ref47$jobId,_ref47$schedule=_ref47.schedule,schedule=_ref47$schedule===undefined?Date.now():_ref47$schedule,repeats=_ref47.repeats,_ref47$client=_ref47.client,client=_ref47$client===undefined?State.WEBCLIENT():_ref47$client;var params={target:{bot:toBot,userDomain:this._botState.currentUserDomain},messages:messages};var scheduleJobParams={jobId:jobId,capability:'ScheduleBatchJob',conversation:this._botState.conversation,params:params,repeats:repeats,requestUuid:this._botState.getUniqueId(),scheduledCapability:'BroadCastMessageCapability',userEmail:this._botState.user.userEmail,userId:this._botState.user.userId,userDomain:this._botState.conversation.userDomain,botId:this._botState.conversation.bot,client:client,schedule:schedule};return callLambda('SystemCapabilities',scheduleJobParams,this._botState.aws).then(function(response){return JSON.parse(response.Payload);});}},{key:'deleteJob',value:function deleteJob(jobId){var scheduleJobParams={jobId:jobId,capability:'DeleteBatchJob'};console.log(scheduleJobParams);return callLambda('SystemCapabilities',scheduleJobParams,this._botState.aws);}},{key:'scheduleLocalJob',value:function scheduleLocalJob(jobId,interval){var bgTaskOptions={key:jobId,botId:this._botState.context.botManifest.botId,timeInterval:interval,conversationId:this._botState.conversationId};var backgroundTaskQueue=this._botState.context.getCapability('BackgroundTaskQueue');return backgroundTaskQueue.enqueue(bgTaskOptions);}},{key:'stopLocalJob',value:function stopLocalJob(jobId){var backgroundTaskQueue=this._botState.context.getCapability('BackgroundTaskQueue');var bgTaskOptions={key:jobId,botId:this._botState.context.botManifest.botId,conversationId:this._botState.conversationId};return backgroundTaskQueue.dequeue(bgTaskOptions);}}]);return JobScheduler;}();var BotFlow=function(){function BotFlow(botState,name,botFlowFromStorage){_classCallCheck(this,BotFlow);this['_botState']=botState;this['_']=botState._;this['_changed']=false;this['_events']=[];if(!botFlowFromStorage){this['_name']=name;this['_started']=false;this['_entities']=[];this['_steps']=[];this['_currentStep']=0;}else{this['_name']=botFlowFromStorage._name;this['_started']=botFlowFromStorage._started;var allEntitiesFromStorage=[];this._.forEach(botFlowFromStorage._entities,function(entity){var theNewEntity=new BotFlowEntity(botState,entity.name,entity);allEntitiesFromStorage.push(theNewEntity);});this['_entities']=allEntitiesFromStorage;this['_steps']=botFlowFromStorage._steps;this['_currentStep']=botFlowFromStorage._currentStep;}this._onStart=function(){};this._onEnd=function(){};}_createClass(BotFlow,[{key:'getAllProperties',value:function getAllProperties(){var entitiesArray=[];this._.forEach(this._entities,function(entity){entitiesArray.push(entity.getAllFields());});return{_name:this._name,_started:this._started,_entities:entitiesArray,_steps:this._steps,_currentStep:this._currentStep};}},{key:'setBotFlowChanged',value:function setBotFlowChanged(){this._changed=true;}},{key:'start',value:function start(){if(!this._started){this._changed=true;this._currentStep=0;this._started=true;this._onStart(this);if(this._botState.developer._debugMode){this._botState.developer.log({message:'Starting botFlow '+this._name});}}}},{key:'reset',value:function reset(){var _this124=this;if(this._started){this._changed=true;this._.each(this._steps,function(step){_this124._.each(step,function(intent){intent.done=false;});});this._entities=[];if(this._botState.developer._debugMode){this._botState.developer.log({message:'Ending botFlow '+this._name});}this._started=false;}}},{key:'end',value:function end(){if(this._started){this._changed=true;this.reset();this._onEnd(this);}}},{key:'getCurrentStep',value:function getCurrentStep(){return this._steps[this._currentStep];}},{key:'getFirstStep',value:function getFirstStep(){return this._steps[0];}},{key:'addStep',value:function addStep(intentsArray,events){var intentsStepArray=[];this._.each(intentsArray,function(intent){var intentsStep={intentId:intent.intentId,done:false};intentsStepArray.push(intentsStep);});var theEvents=events;if(!events){theEvents={};}this._events.push(theEvents);this._steps.push(intentsStepArray);}},{key:'markCurrentStepAsCompleted',value:function markCurrentStepAsCompleted(){this._changed=true;this._.each(this.getCurrentStep(),function(intent){intent.done=true;});if(this._currentStep<this._.size(this._steps)-1){this._currentStep++;}else{this.end();}}},{key:'goToStep',value:function goToStep(stepNumber){if(stepNumber<this._botState._.size(this._steps)&&stepNumber>this._currentStep){while(this._currentStep<stepNumber){this.markCurrentStepAsCompleted();}}}},{key:'markIntentResolved',value:function markIntentResolved(intentId){if(this.isStarted){this._changed=true;var step=this._steps[this._currentStep];var intentIndex=this._.findIndex(step,function(intentStep){return intentStep.intentId===intentId;});if(intentIndex>-1){var intentStep=step[intentIndex];intentStep.done=true;var stepCompleted=true;this._.forEach(step,function(intentStep){if(!intentStep.done){stepCompleted=false;}});if(stepCompleted){if(this._currentStep<this._.size(this._steps)-1){this._currentStep+=1;}else{this.end();}}}}}},{key:'getEntity',value:function getEntity(entityName){var i=this._.findIndex(this._entities,function(entity){return entity.name===entityName;});return this._entities[i]||null;}},{key:'addEntity',value:function addEntity(entity){this._entities.push(entity);}},{key:'name',get:function get(){return this._name;}},{key:'isStarted',get:function get(){return this._started;}},{key:'isChanged',get:function get(){return this._changed;}},{key:'onStart',set:function set(onStartBlock){this._onStart=onStartBlock;}},{key:'onEnd',set:function set(onEndBlock){this['_onEnd']=onEndBlock;}},{key:'currentStepIndex',get:function get(){return this._currentStep;}},{key:'steps',get:function get(){return this._steps;}}]);return BotFlow;}();var BotFlowEntity=function(){_createClass(BotFlowEntity,null,[{key:'LOCKED',value:function LOCKED(){return'Locked';}},{key:'CACHED',value:function CACHED(){return'Cached';}},{key:'IDLE',value:function IDLE(){return'Idle';}}]);function BotFlowEntity(botState,name,entityFromStorage){_classCallCheck(this,BotFlowEntity);this['_linkedForm']='';this['_botState']=botState;this['_promptIndex']=0;this['_']=botState._;this['name']=name;this['state']=BotFlowEntity.IDLE();if(entityFromStorage){this.addFieldsFromObject(entityFromStorage);}}_createClass(BotFlowEntity,[{key:'addFieldsFromObject',value:function addFieldsFromObject(record){for(var field in record){this[field]=record[field];}}},{key:'getAllFields',value:function getAllFields(){var allFields={};for(var field in this){if(field!=='_'&&field!=='_botState'){if(this[field]!==''){allFields[field]=this[field];}}}return allFields;}},{key:'addFieldsFromForm',value:function addFieldsFromForm(record){var _this125=this;this._.each(record.fields,function(field){_this125[field.id]=field.value;});}},{key:'moveToNextPrompt',value:function moveToNextPrompt(){this._promptIndex++;}},{key:'cancelPrompt',value:function cancelPrompt(){this._botState.blockSuggestions=true;this._promptIndex=0;}},{key:'restartPrompt',value:function restartPrompt(){this._promptIndex=0;}},{key:'goToPromptState',value:function goToPromptState(stepNum){this._promptIndex=stepNum;}},{key:'read',value:function read(){}},{key:'readWithLock',value:function readWithLock(){}},{key:'save',value:function save(){}},{key:'delete',value:function _delete(){}},{key:'form',set:function set(form){this._linkedForm=form;},get:function get(){return this._linkedForm;}},{key:'promptIndex',get:function get(){return this._promptIndex;}},{key:'onSave',get:function get(){return this['_onSave'];},set:function set(onSaveBlock){this['_onSave']=onSaveBlock;}},{key:'onDelete',get:function get(){return this['_onDelete'];},set:function set(onSaveBlock){this['_onDelete']=onSaveBlock;}}]);return BotFlowEntity;}();var FormFieldTypes=function(){function FormFieldTypes(){_classCallCheck(this,FormFieldTypes);}_createClass(FormFieldTypes,null,[{key:'TEXT_FIELD',value:function TEXT_FIELD(){return'text_field';}},{key:'NUMBER_FIELD',value:function NUMBER_FIELD(){return'number';}},{key:'TEXT_AREA',value:function TEXT_AREA(){return'text_area';}},{key:'CHECKBOX',value:function CHECKBOX(){return'checkbox';}},{key:'RADIOBUTTON',value:function RADIOBUTTON(){return'radiobutton';}},{key:'DROPDOWN',value:function DROPDOWN(){return'dropdown';}},{key:'SWITCH',value:function SWITCH(){return'switch';}},{key:'SLIDER',value:function SLIDER(){return'slider';}},{key:'DATE',value:function DATE(){return'date';}},{key:'DATETIME',value:function DATETIME(){return'datetime';}},{key:'TIME',value:function TIME(){return'time';}},{key:'MULTI_SELECTION',value:function MULTI_SELECTION(){return'multi_selection';}},{key:'PASSWORD_FIELD',value:function PASSWORD_FIELD(){return'password_field';}},{key:'LOOKUP',value:function LOOKUP(){return'lookup';}},{key:'IMAGE_FIELD',value:function IMAGE_FIELD(){return'image_field';}},{key:'FILE_FIELD',value:function FILE_FIELD(){return'file_field';}},{key:'BUTTONS_FIELD',value:function BUTTONS_FIELD(){return'buttons_field';}},{key:'CHAT_FIELD',value:function CHAT_FIELD(){return'chat_field';}},{key:'VIDEO_CALL_FIELD',value:function VIDEO_CALL_FIELD(){return'video_call_field';}},{key:'VOICE_CALL_FIELD',value:function VOICE_CALL_FIELD(){return'voice_call_field';}},{key:'ROW_MENU_FIELD',value:function ROW_MENU_FIELD(){return'row_menu_field';}}]);return FormFieldTypes;}();var Form=function(){_createClass(Form,null,[{key:'CONFIRM_FORM_ACTION',value:function CONFIRM_FORM_ACTION(){return'confirm';}},{key:'CANCEL_FORM_ACTION',value:function CANCEL_FORM_ACTION(){return'cancel';}},{key:'CLOSE_FORM_ACTION',value:function CLOSE_FORM_ACTION(){return'close';}},{key:'MOVE_FORM_ACTION',value:function MOVE_FORM_ACTION(){return'move';}},{key:'SEARCH_FORM_ACTION',value:function SEARCH_FORM_ACTION(){return'search';}}]);function Form(botState,options,formFromStorage){_classCallCheck(this,Form);this['_botState']=botState;this['_']=botState._;if(!formFromStorage){this['_options']=options||{};this['_fields']=[];this['_open']=false;}else{this['_options']=formFromStorage._options;this['_fields']=formFromStorage._fields||[];this['_open']=formFromStorage._open;}}_createClass(Form,[{key:'getAllProperties',value:function getAllProperties(){return{_options:this._options,_fields:this._fields,_open:this._open};}},{key:'fieldsAsObject',value:function fieldsAsObject(){var fields={};this._.each(this._fields,function(field){fields[field.id]=field.value;});return fields;}},{key:'openForm',value:function openForm(){this._open=true;}},{key:'closeForm',value:function closeForm(){this._open=false;}},{key:'cancelForm',value:function cancelForm(){if(this._botState.client===State.MOBILECLIENT()){this._botState.addResponse('close_form',{formId:this._options.formId,action:'close'});}}},{key:'getField',value:function getField(fieldId){var index=this._botState._.findIndex(this._fields,function(field){return fieldId===field.id;});if(index>-1){return this._fields[index];}else{return null;}}},{key:'clearAllFields',value:function clearAllFields(){this._botState._.each(this._fields,function(field){delete field.value;});}},{key:'assignValueToField',value:function assignValueToField(fieldId,value){var field=this.getField(fieldId);if(field){field.value=value;}}},{key:'addField',value:function addField(newField){var field=this.getField(newField.id);if(field===null){this._fields.push(newField);}else{field.options=newField.options;field.values=newField.values;}}},{key:'title',set:function set(title){this._options.title=title;}},{key:'description',set:function set(description){this._options.description=description;}},{key:'formId',get:function get(){return this._options.formId;}},{key:'isOpen',get:function get(){return this._open;}},{key:'options',get:function get(){return this._options;},set:function set(options){return this._options=options;}},{key:'fields',get:function get(){return this._fields;},set:function set(fields){this._fields=fields;}},{key:'onSubmit',set:function set(onSubmitBlock){this['_onSubmit']=onSubmitBlock;},get:function get(){return this['_onSubmit'];}},{key:'onCancel',set:function set(onCancelBlock){this['_onCancel']=onCancelBlock;},get:function get(){return this['_onCancel'];}},{key:'onClose',set:function set(onCloseBlock){this['_onClose']=onCloseBlock;},get:function get(){return this['_onClose'];}}]);return Form;}();var Schedules=function(){_createClass(Schedules,null,[{key:'SCHD_INDEX',value:function SCHD_INDEX(){return'scheduler';}}]);function Schedules(botState){_classCallCheck(this,Schedules);this['_botState']=botState;this['_']=botState._;this['context']=botState.context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['location']=botState.location;}_createClass(Schedules,[{key:'validateResources',value:function validateResources(resourceData){if(!resourceData.domain||!resourceData.resourceName||!resourceData.resourceId||!resourceData.resourceType||!resourceData.resourceSubType||!resourceData.availStartTime||!resourceData.availEndTime)return false;else return true;}},{key:'createSingleResource',value:function createSingleResource(resource){var newResource,isValid,writeResp;return regeneratorRuntime.async(function createSingleResource$(_context182){while(1){switch(_context182.prev=_context182.next){case 0:this._botState.developer.log({message:'From Schedules, createSingleRes with',data:resource});newResource={};isValid=this.validateResources(resource);if(!isValid){_context182.next=28;break;}newResource.id=this._botState.getUniqueId();newResource.origId=resource.origId||this._botState.getUniqueId();newResource.domain=resource.domain;newResource.resourceId=resource.resourceId;newResource.resourceName=resource.resourceName;newResource.resourceType=resource.resourceType;newResource.resourceSubType=resource.resourceSubType;newResource.availStartTime=resource.availStartTime;newResource.availEndTime=resource.availEndTime;newResource.multiTask=resource.multiTask;newResource.availableStatus=resource.availableStatus;newResource.eventId=resource.eventId||null;_context182.next=18;return regeneratorRuntime.awrap(this._botState.db.updateDataInIndex(Schedules.SCHD_INDEX(),'_doc',newResource));case 18:writeResp=_context182.sent;if(!(!writeResp.error&&!writeResp.errorMessage)){_context182.next=24;break;}this._botState.developer.log({message:'From Schedules Class Create success',data:writeResp});return _context182.abrupt('return',{'status':'success',newId:newResource.id});case 24:this._botState.developer.log({message:'From Schedules Class Create ERROR',data:writeResp});return _context182.abrupt('return',{'status':'error',newId:undefined});case 26:_context182.next=30;break;case 28:this._botState.developer.log({message:'From Schedules Class Create ERROR',data:"Incomplete details"});return _context182.abrupt('return',{'status':'error',newId:undefined});case 30:case'end':return _context182.stop();}}},null,this);}},{key:'updateSingleResource',value:function updateSingleResource(resource){var updResource,isValid,writeResp;return regeneratorRuntime.async(function updateSingleResource$(_context183){while(1){switch(_context183.prev=_context183.next){case 0:this._botState.developer.log({message:'From Schedules, updateSingleRes with',data:resource});updResource={};isValid=this.validateResources(resource);if(!(isValid&&resource.id)){_context183.next=28;break;}updResource.id=resource.id;updResource.origId=resource.origId;updResource.domain=resource.domain;updResource.resourceId=resource.resourceId;updResource.resourceName=resource.resourceName;updResource.resourceType=resource.resourceType;updResource.resourceSubType=resource.resourceSubType;updResource.availStartTime=resource.availStartTime;updResource.availEndTime=resource.availEndTime;updResource.multiTask=resource.multiTask;updResource.availableStatus=resource.availableStatus;updResource.eventId=resource.eventId||null;_context183.next=18;return regeneratorRuntime.awrap(this._botState.db.updateDataInIndex(Schedules.SCHD_INDEX(),'_doc',updResource));case 18:writeResp=_context183.sent;if(!(!writeResp.error&&!writeResp.errorMessage)){_context183.next=24;break;}this._botState.developer.log({message:'From Schedules Class Update success',data:writeResp});return _context183.abrupt('return',true);case 24:this._botState.developer.log({message:'From Schedules Class Update ERROR',data:writeResp});return _context183.abrupt('return',false);case 26:_context183.next=30;break;case 28:this._botState.developer.log({message:'From Schedules Class Create ERROR',data:"Incomplete details"});return _context183.abrupt('return',false);case 30:case'end':return _context183.stop();}}},null,this);}},{key:'deleteSingleResource',value:function deleteSingleResource(resourceId){var delResp;return regeneratorRuntime.async(function deleteSingleResource$(_context184){while(1){switch(_context184.prev=_context184.next){case 0:this._botState.developer.log({message:'From Schedules, deleteSingleRes with',data:resourceId});if(resourceId){_context184.next=3;break;}return _context184.abrupt('return',false);case 3:_context184.next=5;return regeneratorRuntime.awrap(this._botState.db.deleteDataFromIndexByID(Schedules.SCHD_INDEX(),'_doc',resourceId));case 5:delResp=_context184.sent;if(!(!delResp.error&&!delResp.errorMessage)){_context184.next=11;break;}this._botState.developer.log({message:'From Schedules Class Delete success',data:delResp});return _context184.abrupt('return',true);case 11:this._botState.developer.log({message:'From Schedules Class Delete ERROR',data:delResp});return _context184.abrupt('return',false);case 13:case'end':return _context184.stop();}}},null,this);}},{key:'createRecurringResource',value:function createRecurringResource(){return regeneratorRuntime.async(function createRecurringResource$(_context185){while(1){switch(_context185.prev=_context185.next){case 0:case'end':return _context185.stop();}}},null,this);}},{key:'updateRecurringResource',value:function updateRecurringResource(){return regeneratorRuntime.async(function updateRecurringResource$(_context186){while(1){switch(_context186.prev=_context186.next){case 0:case'end':return _context186.stop();}}},null,this);}},{key:'deleteRecurringResource',value:function deleteRecurringResource(){return regeneratorRuntime.async(function deleteRecurringResource$(_context187){while(1){switch(_context187.prev=_context187.next){case 0:case'end':return _context187.stop();}}},null,this);}},{key:'searchResourcesByInterval',value:function searchResourcesByInterval(startTime,endTime){var queryObj,responsesArray;return regeneratorRuntime.async(function searchResourcesByInterval$(_context188){while(1){switch(_context188.prev=_context188.next){case 0:if(!(startTime>=endTime)){_context188.next=2;break;}return _context188.abrupt('return',[]);case 2:queryObj={"query":{"bool":{"must":{"match_all":{}},"filter":[{"range":{"availStartTime":{"lte":startTime}}},{"range":{"availEndTime":{"gte":endTime}}},{"match":{"availableStatus":"true"}}]}},"sort":[{"availStartTime":{"order":"asc"}}],"size":1000};this._botState.developer.log({message:'From Schedules Class searchResourcesByInterval QUERY',data:queryObj});_context188.next=6;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj));case 6:responsesArray=_context188.sent;this._botState.developer.log({message:'From Schedules Class searchResourcesByInterval RESP',data:responsesArray});if(!(responsesArray&&responsesArray.length>0)){_context188.next=12;break;}return _context188.abrupt('return',responsesArray);case 12:return _context188.abrupt('return',[]);case 13:case'end':return _context188.stop();}}},null,this);}},{key:'searchResourcesByIntervalByType',value:function searchResourcesByIntervalByType(resType,startTime,endTime){var queryObj,responsesArray;return regeneratorRuntime.async(function searchResourcesByIntervalByType$(_context189){while(1){switch(_context189.prev=_context189.next){case 0:if(!(startTime>=endTime||!resType)){_context189.next=2;break;}return _context189.abrupt('return',[]);case 2:queryObj={"query":{"bool":{"must":{"match":{"resourceType":resType}},"filter":[{"range":{"availStartTime":{"lte":startTime}}},{"range":{"availEndTime":{"gte":endTime}}},{"match":{"availableStatus":"true"}}]}},"sort":[{"availStartTime":{"order":"asc"}}],"size":1000};_context189.next=5;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj));case 5:responsesArray=_context189.sent;if(!(responsesArray&&responsesArray.length>0)){_context189.next=10;break;}return _context189.abrupt('return',responsesArray);case 10:return _context189.abrupt('return',[]);case 11:case'end':return _context189.stop();}}},null,this);}},{key:'searchResourcesByIntervalBySubType',value:function searchResourcesByIntervalBySubType(resSubType,startTime,endTime){var queryObj,responsesArray;return regeneratorRuntime.async(function searchResourcesByIntervalBySubType$(_context190){while(1){switch(_context190.prev=_context190.next){case 0:if(!(startTime>=endTime||!resSubType)){_context190.next=2;break;}return _context190.abrupt('return',[]);case 2:queryObj={"query":{"bool":{"must":{"match":{"resourceSubType":resSubType}},"filter":[{"range":{"availStartTime":{"lte":startTime}}},{"range":{"availEndTime":{"gte":endTime}}},{"match":{"availableStatus":"true"}}]}},"sort":[{"availStartTime":{"order":"asc"}}],"size":1000};_context190.next=5;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj));case 5:responsesArray=_context190.sent;if(!(responsesArray&&responsesArray.length>0)){_context190.next=10;break;}return _context190.abrupt('return',responsesArray);case 10:return _context190.abrupt('return',[]);case 11:case'end':return _context190.stop();}}},null,this);}},{key:'searchResourcesByIntervalByResId',value:function searchResourcesByIntervalByResId(resId,startTime,endTime){var queryObj,responsesArray;return regeneratorRuntime.async(function searchResourcesByIntervalByResId$(_context191){while(1){switch(_context191.prev=_context191.next){case 0:if(!(startTime>=endTime||!resId)){_context191.next=2;break;}return _context191.abrupt('return',[]);case 2:queryObj={"query":{"bool":{"must":{"match":{"resourceId":resId}},"filter":[{"range":{"availStartTime":{"lte":startTime}}},{"range":{"availEndTime":{"gte":endTime}}},{"match":{"availableStatus":"true"}}]}},"sort":[{"availStartTime":{"order":"asc"}}],"size":1000};_context191.next=5;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj));case 5:responsesArray=_context191.sent;if(!(responsesArray&&responsesArray.length>0)){_context191.next=10;break;}return _context191.abrupt('return',responsesArray);case 10:return _context191.abrupt('return',[]);case 11:case'end':return _context191.stop();}}},null,this);}},{key:'searchResourcesByIntervalByTypeSubType',value:function searchResourcesByIntervalByTypeSubType(resType,resSubType,startTime,endTime){var queryObj,responsesArray;return regeneratorRuntime.async(function searchResourcesByIntervalByTypeSubType$(_context192){while(1){switch(_context192.prev=_context192.next){case 0:if(!(startTime>=endTime||!resType||!resSubType)){_context192.next=2;break;}return _context192.abrupt('return',[]);case 2:queryObj={"query":{"bool":{"must":[{"match":{"resourceType":resType}},{"match":{"resourceSubType":resSubType}}],"filter":[{"range":{"availStartTime":{"lte":startTime}}},{"range":{"availEndTime":{"gte":endTime}}},{"match":{"availableStatus":"true"}}]}},"sort":[{"availStartTime":{"order":"asc"}}],"size":1000};_context192.next=5;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj));case 5:responsesArray=_context192.sent;if(!(responsesArray&&responsesArray.length>0)){_context192.next=10;break;}return _context192.abrupt('return',responsesArray);case 10:return _context192.abrupt('return',[]);case 11:case'end':return _context192.stop();}}},null,this);}},{key:'searchResourcesByIntervalByTypeSubTypeResId',value:function searchResourcesByIntervalByTypeSubTypeResId(resType,resSubType,resId,startTime,endTime){var queryObj,responsesArray;return regeneratorRuntime.async(function searchResourcesByIntervalByTypeSubTypeResId$(_context193){while(1){switch(_context193.prev=_context193.next){case 0:if(!(startTime>=endTime||!resType||!resSubType||!resId)){_context193.next=2;break;}return _context193.abrupt('return',[]);case 2:queryObj={"query":{"bool":{"must":[{"match":{"resourceType":resType}},{"match":{"resourceSubType":resSubType}},{"match":{"resourceId":resId}}],"filter":[{"range":{"availStartTime":{"lte":startTime}}},{"range":{"availEndTime":{"gte":endTime}}},{"match":{"availableStatus":"true"}}]}},"sort":[{"availStartTime":{"order":"asc"}}],"size":1000};_context193.next=5;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj));case 5:responsesArray=_context193.sent;if(!(responsesArray&&responsesArray.length>0)){_context193.next=10;break;}return _context193.abrupt('return',responsesArray);case 10:return _context193.abrupt('return',[]);case 11:case'end':return _context193.stop();}}},null,this);}},{key:'searchResourcesByEventId',value:function searchResourcesByEventId(eventId){var queryObj,responsesArray;return regeneratorRuntime.async(function searchResourcesByEventId$(_context194){while(1){switch(_context194.prev=_context194.next){case 0:if(!(!eventId||eventId==='')){_context194.next=2;break;}return _context194.abrupt('return',[]);case 2:queryObj={"query":{"bool":{"must":{"match_all":{}},"filter":[{"match":{"eventId":eventId}}]}},"sort":[{"availStartTime":{"order":"asc"}}],"size":1000};_context194.next=5;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj));case 5:responsesArray=_context194.sent;if(!(responsesArray&&responsesArray.length>0)){_context194.next=10;break;}return _context194.abrupt('return',responsesArray);case 10:return _context194.abrupt('return',[]);case 11:case'end':return _context194.stop();}}},null,this);}},{key:'searchResourcesByIds',value:function searchResourcesByIds(idArrayIn){var idArray,queryObj,responsesArray;return regeneratorRuntime.async(function searchResourcesByIds$(_context195){while(1){switch(_context195.prev=_context195.next){case 0:if(idArrayIn){_context195.next=2;break;}return _context195.abrupt('return',[]);case 2:idArray=void 0;if(Array.isArray(idArrayIn)){idArray=idArrayIn;}else{idArray=[idArrayIn];}if(!(idArray.length<1)){_context195.next=6;break;}return _context195.abrupt('return',[]);case 6:queryObj={"query":{"ids":{"values":idArray}},"sort":[{"availStartTime":{"order":"asc"}}],"size":1000};_context195.next=9;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj));case 9:responsesArray=_context195.sent;if(!(responsesArray&&responsesArray.length>0)){_context195.next=14;break;}return _context195.abrupt('return',responsesArray);case 14:return _context195.abrupt('return',[]);case 15:case'end':return _context195.stop();}}},null,this);}},{key:'_splitAndBlock',value:function _splitAndBlock(resId,startTime,endTime,eventId){var TIME_CUT,beforeID,afterID,curResObjArr,curResObj,beforeBlockStartTime,beforeBlockEndTime,afterBlockStartTime,afterBlockEndTime,beforeResource,_creResp,afterResource,_creResp2,newResource,creResp,respP,respA,delResp;return regeneratorRuntime.async(function _splitAndBlock$(_context196){while(1){switch(_context196.prev=_context196.next){case 0:this._botState.developer.log({message:'From Schedules, _splitAndBlock with',data:resId});TIME_CUT=60*1000;beforeID=void 0;afterID=void 0;_context196.next=6;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithID(Schedules.SCHD_INDEX(),'_doc',resId));case 6:curResObjArr=_context196.sent;curResObj=curResObjArr[0];if(!(startTime<curResObj.availStartTime||endTime>curResObj.availEndTime)){_context196.next=10;break;}return _context196.abrupt('return',{'result':'error','msg':'Resource not availble during requested time'});case 10:beforeBlockStartTime=curResObj.availStartTime;beforeBlockEndTime=startTime-TIME_CUT;afterBlockStartTime=endTime+TIME_CUT;afterBlockEndTime=curResObj.availEndTime;if(!(beforeBlockEndTime>beforeBlockStartTime&&!curResObj.multiTask)){_context196.next=23;break;}beforeResource=this._.cloneDeep(curResObj);beforeResource.availStartTime=beforeBlockStartTime;beforeResource.availEndTime=beforeBlockEndTime;_context196.next=20;return regeneratorRuntime.awrap(this.createSingleResource(beforeResource));case 20:_creResp=_context196.sent;if(_creResp.status==='error')this._botState.developer.log({message:'error',data:'Could not create Prior split'});else beforeID=_creResp.newId;this._botState.developer.log({message:'PRIOR created',data:beforeID});case 23:if(!(afterBlockEndTime>afterBlockStartTime&&!curResObj.multiTask)){_context196.next=32;break;}afterResource=this._.cloneDeep(curResObj);afterResource.availStartTime=afterBlockStartTime;afterResource.availEndTime=afterBlockEndTime;_context196.next=29;return regeneratorRuntime.awrap(this.createSingleResource(afterResource));case 29:_creResp2=_context196.sent;if(_creResp2.status==='error')this._botState.developer.log({message:'error',data:'Could not create After split'});else afterID=_creResp2.newId;this._botState.developer.log({message:'AFTER created',data:afterID});case 32:newResource=this._.cloneDeep(curResObj);newResource.availStartTime=startTime;newResource.availEndTime=endTime;newResource.availableStatus=false;if(eventId)newResource.eventId=eventId;_context196.next=39;return regeneratorRuntime.awrap(this.createSingleResource(newResource));case 39:creResp=_context196.sent;if(!(creResp.status==='error')){_context196.next=53;break;}this._botState.developer.log({message:'error',data:'Could not block the slot, delete PRIOR & AFTER'});_context196.next=44;return regeneratorRuntime.awrap(this.deleteSingleResource(beforeID));case 44:respP=_context196.sent;if(respP)this._botState.developer.log({message:'success',data:'Temp Prior deleted - '+beforeID});else this._botState.developer.log({message:'error',data:'Temp Prior could not be deleted - '+beforeID});_context196.next=48;return regeneratorRuntime.awrap(this.deleteSingleResource(afterID));case 48:respA=_context196.sent;if(respA)this._botState.developer.log({message:'success',data:'Temp Prior deleted - '+afterID});else this._botState.developer.log({message:'error',data:'Temp Prior could not be deleted - '+afterID});return _context196.abrupt('return',{'result':'error','msg':'Resource NOT booked during requested time'});case 53:if(curResObj.multiTask){_context196.next=58;break;}_context196.next=56;return regeneratorRuntime.awrap(this.deleteSingleResource(resId));case 56:delResp=_context196.sent;if(delResp)this._botState.developer.log({message:'success',data:'Original availability deleted - '+resId});else this._botState.developer.log({message:'error',data:'Original availability could not be deleted - '+resId});case 58:return _context196.abrupt('return',{'result':'success',newId:creResp.newId});case 59:case'end':return _context196.stop();}}},null,this);}},{key:'blockResource',value:function blockResource(resIdArrayIn,startTime,endTime,eventId){var resIdArray,resultsArray,i,currentID,resp;return regeneratorRuntime.async(function blockResource$(_context197){while(1){switch(_context197.prev=_context197.next){case 0:resIdArray=void 0;if(Array.isArray(resIdArrayIn)){resIdArray=resIdArrayIn;}else{resIdArray=[resIdArrayIn];}if(!(startTime>=endTime||resIdArray.length<1)){_context197.next=4;break;}return _context197.abrupt('return',false);case 4:resultsArray=[];i=0;case 6:if(!(i<resIdArray.length)){_context197.next=16;break;}currentID=resIdArray[i];resp={};_context197.next=11;return regeneratorRuntime.awrap(this._splitAndBlock(currentID,startTime,endTime,eventId));case 11:resp[currentID]=_context197.sent;resultsArray.push(resp);case 13:i++;_context197.next=6;break;case 16:return _context197.abrupt('return',resultsArray);case 17:case'end':return _context197.stop();}}},null,this);}},{key:'_deleteAndStitch',value:function _deleteAndStitch(resId){var TIME_CUT,curResObjArr,curResObj,delBlockStartTime,delBlockStartTimeMinus1min,delBlockEndTime,delBlockEndTimePlus1min,delBlockOrigId,origResourcePriorExtended,origResourceAfterExtended,resp,queryObj1,priorSlot,response1,updResp,queryObj2,afterSlot,response2,_updResp,delResp,_updResp2,_delResp,_updResp3;return regeneratorRuntime.async(function _deleteAndStitch$(_context198){while(1){switch(_context198.prev=_context198.next){case 0:TIME_CUT=60*1000;_context198.next=3;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithID(Schedules.SCHD_INDEX(),'_doc',resId));case 3:curResObjArr=_context198.sent;curResObj=curResObjArr[0];delBlockStartTime=curResObj.availStartTime;delBlockStartTimeMinus1min=delBlockStartTime-TIME_CUT;delBlockEndTime=curResObj.availEndTime;delBlockEndTimePlus1min=delBlockEndTime+TIME_CUT;delBlockOrigId=curResObj.origId;origResourcePriorExtended=false;origResourceAfterExtended=false;if(!curResObj.multiTask){_context198.next=23;break;}_context198.next=15;return regeneratorRuntime.awrap(this.deleteSingleResource(resId));case 15:resp=_context198.sent;if(!resp){_context198.next=20;break;}return _context198.abrupt('return',{'result':'success','msg':'Resource released'});case 20:return _context198.abrupt('return',{'result':'error','msg':'Resource could not be released'});case 21:_context198.next=97;break;case 23:queryObj1={"query":{"bool":{"must":[{"match":{"origId":delBlockOrigId}}],"filter":[{"term":{"availableStatus":true}},{"term":{"availEndTime":delBlockStartTimeMinus1min}}]}}};priorSlot=void 0;_context198.next=27;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj1));case 27:response1=_context198.sent;if(!(response1&&response1.length===1)){_context198.next=41;break;}priorSlot=response1[0];priorSlot.availEndTime=delBlockEndTime;priorSlot.availableStatus=true;priorSlot.eventId=null;_context198.next=35;return regeneratorRuntime.awrap(this.updateSingleResource(priorSlot));case 35:updResp=_context198.sent;if(updResp){_context198.next=38;break;}return _context198.abrupt('return',{'result':'error','msg':'Previous resource could not be merged'});case 38:origResourcePriorExtended=true;_context198.next=45;break;case 41:if(!(response1&&response1.length>1)){_context198.next=45;break;}this._botState.developer.log({message:"Schedule Error",data:"Found multiple entries for Prior Split"});this._botState.developer.log({message:"Multiple entries",data:response1});return _context198.abrupt('return',{'result':'error','msg':'Data inconsistency - multiple prior splits'});case 45:queryObj2={"query":{"bool":{"must":[{"match":{"origId":delBlockOrigId}}],"filter":[{"term":{"availableStatus":true}},{"term":{"availStartTime":delBlockEndTimePlus1min}}]}}};afterSlot=void 0;_context198.next=49;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj2));case 49:response2=_context198.sent;if(!(response2&&response2.length===1)){_context198.next=77;break;}afterSlot=response2[0];afterSlot.availableStatus=true;afterSlot.eventId=null;if(!origResourcePriorExtended){_context198.next=68;break;}afterSlot.availStartTime=priorSlot.availStartTime;_context198.next=58;return regeneratorRuntime.awrap(this.updateSingleResource(afterSlot));case 58:_updResp=_context198.sent;if(_updResp){_context198.next=61;break;}return _context198.abrupt('return',{'result':'error','msg':'Subsequent resource could not be merged'});case 61:_context198.next=63;return regeneratorRuntime.awrap(this.deleteSingleResource(priorSlot.id));case 63:delResp=_context198.sent;if(delResp){_context198.next=66;break;}return _context198.abrupt('return',{'result':'error','msg':'Original resource could not be deleted'});case 66:_context198.next=74;break;case 68:afterSlot.availStartTime=delBlockStartTime;_context198.next=71;return regeneratorRuntime.awrap(this.updateSingleResource(afterSlot));case 71:_updResp2=_context198.sent;if(_updResp2){_context198.next=74;break;}return _context198.abrupt('return',{'result':'error','msg':'Subsequent resource could not be merged'});case 74:origResourceAfterExtended=true;_context198.next=81;break;case 77:if(!(response2&&response2.length>1)){_context198.next=81;break;}this._botState.developer.log({message:"Schedule Error",data:"Found multiple entries for After Split"});this._botState.developer.log({message:"Multiple entries",data:response2});return _context198.abrupt('return',{'result':'error','msg':'Data inconsistency - multiple after splits'});case 81:if(!(origResourcePriorExtended||origResourceAfterExtended)){_context198.next=89;break;}_context198.next=84;return regeneratorRuntime.awrap(this.deleteSingleResource(resId));case 84:_delResp=_context198.sent;if(_delResp){_context198.next=87;break;}return _context198.abrupt('return',{'result':'error','msg':'Original resource could not be deleted'});case 87:_context198.next=96;break;case 89:curResObj.availableStatus=true;curResObj.eventId=null;_context198.next=93;return regeneratorRuntime.awrap(this.updateSingleResource(curResObj));case 93:_updResp3=_context198.sent;if(_updResp3){_context198.next=96;break;}return _context198.abrupt('return',{'result':'error','msg':'Subsequent resource could not be merged'});case 96:return _context198.abrupt('return',{'result':'success','msg':'Resource released'});case 97:case'end':return _context198.stop();}}},null,this);}},{key:'unBlockResource',value:function unBlockResource(resIdArrayIn){var resultsArray,resIdArray,i,currentID,resp;return regeneratorRuntime.async(function unBlockResource$(_context199){while(1){switch(_context199.prev=_context199.next){case 0:resultsArray=[];resIdArray=void 0;if(Array.isArray(resIdArrayIn)){resIdArray=resIdArrayIn;}else{resIdArray=[resIdArrayIn];}if(!(resIdArray.length<1)){_context199.next=5;break;}return _context199.abrupt('return',false);case 5:i=0;case 6:if(!(i<resIdArray.length)){_context199.next=16;break;}currentID=resIdArray[i];resp={};_context199.next=11;return regeneratorRuntime.awrap(this._deleteAndStitch(currentID));case 11:resp[currentID]=_context199.sent;resultsArray.push(resp);case 13:i++;_context199.next=6;break;case 16:return _context199.abrupt('return',resultsArray);case 17:case'end':return _context199.stop();}}},null,this);}},{key:'searchResourcesByResIdEventId',value:function searchResourcesByResIdEventId(eventId,resId){var queryObj,responsesArray;return regeneratorRuntime.async(function searchResourcesByResIdEventId$(_context200){while(1){switch(_context200.prev=_context200.next){case 0:if(!(!eventId||eventId===''||!resId||resId==='')){_context200.next=2;break;}return _context200.abrupt('return',[]);case 2:queryObj={"query":{"bool":{"must":{"match_all":{}},"filter":[{"match":{"resourceId":resId}},{"match":{"eventId":eventId}}]}},"sort":[{"availStartTime":{"order":"asc"}}],"size":1000};_context200.next=5;return regeneratorRuntime.awrap(this._botState.db.getDataFromIndexWithQueryObject(Schedules.SCHD_INDEX(),queryObj));case 5:responsesArray=_context200.sent;if(!(responsesArray&&responsesArray.length>0)){_context200.next=10;break;}return _context200.abrupt('return',responsesArray);case 10:return _context200.abrupt('return',[]);case 11:case'end':return _context200.stop();}}},null,this);}}]);return Schedules;}();var Orders=function(){_createClass(Orders,null,[{key:'PAYMENT_CODES',value:function PAYMENT_CODES(){return{TOP_UP_WALLET:'100',PURCHASE_PRODUCT:'101'};}},{key:'CURRENT_STRIPE_TRANSACTIONS',value:function CURRENT_STRIPE_TRANSACTIONS(){return'currentStripeTransactions';}}]);function Orders(botState){_classCallCheck(this,Orders);this['_botState']=botState;this['context']=botState.context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['location']=botState.location;this._botState.developer.log({message:'Initialising Orders'});if(this._botState.client===State.MOBILECLIENT()&&this.location===Intent.EDGE()){if(this._botState.client===State.MOBILECLIENT()){this._botState.developer.log({message:'Initialising InAppPurchases'});this['inAppPurchaseCap']=this.context.getCapability('InAppPurchase');this['productTypes']=this.inAppPurchaseCap.ProductTypes;}else{this['inAppPurchaseCap']='false';this['productTypes']=[];}}}_createClass(Orders,[{key:'createNewStripeTransaction',value:function createNewStripeTransaction(amount,currency,description){var currentTransactions=this._botState.getField(Orders.CURRENT_STRIPE_TRANSACTIONS())||[];var transactionId=this._botState.UUID();currentTransactions.push({transactionId:transactionId,amount:amount,currency:currency,description:description});this._botState.setField(Orders.CURRENT_STRIPE_TRANSACTIONS(),currentTransactions);return transactionId;}},{key:'getStripeTransaction',value:function getStripeTransaction(transactionId){var currentTransactions=this._botState.getField(Orders.CURRENT_STRIPE_TRANSACTIONS())||[];var index=this._botState._.findIndex(currentTransactions,function(transaction){return transaction.transactionId===transactionId;});return index===-1?null:currentTransactions[index];}},{key:'removeStripeTransaction',value:function removeStripeTransaction(transactionId){var currentTransactions=this._botState.getField(Orders.CURRENT_STRIPE_TRANSACTIONS())||[];var index=this._botState._.findIndex(currentTransactions,function(transaction){return transaction.transactionId===transactionId;});this._botState._.pullAt(currentTransactions,[index]);this._botState.setField(Orders.CURRENT_STRIPE_TRANSACTIONS(),currentTransactions);}},{key:'inAppPurchase',value:function inAppPurchase(product){if(this.location===Intent.CLOUD()||this._botState.client===State.WEBCLIENT()){this._botState.addSystemErrorToStack(13);return;}this._botState.developer.log({message:'About to buy product '+product+' of type '+this.productTypes.VOIP});return this.inAppPurchaseCap.buyProduct({productCode:product,productName:this.productTypes.VOIP});}},{key:'processStripePayment',value:function processStripePayment(){console.log('Before stripe request: '+JSON.stringify(this._botState.messageFromUser));var _botState$messageFrom=this._botState.messageFromUser,transactionId=_botState$messageFrom.transactionId,currency=_botState$messageFrom.currency,amount=_botState$messageFrom.amount,paymentSuccessful=_botState$messageFrom.paymentSuccessful;if(paymentSuccessful){var stateTransaction=this.getStripeTransaction(transactionId);if(stateTransaction===null){return{error:'Invalid transaction id'};}var stateTransactionId=stateTransaction.transactionId,stateCurrency=stateTransaction.currency,stateAmount=stateTransaction.amount;if(stateTransactionId!==transactionId){return{error:'Invalid transaction id'};}if(stateAmount!==amount){return{error:'There is a discrepancy in amounts. Please report to the support team'};}if(stateCurrency!==currency){return{error:'There is a discrepancy in currencies. Please report to the support team'};}this.removeStripeTransaction(transactionId);return{error:0};}else{this.removeStripeTransaction(transactionId);return{error:'Your stripe payment was not successful'};}}}]);return Orders;}();var Accounts=function(){function Accounts(botState){_classCallCheck(this,Accounts);this['_botState']=botState;this['context']=botState.context;this['userId']=botState.user.userId;this['conversation']=botState.conversation;this['location']=botState.location;}_createClass(Accounts,[{key:'getBalance',value:function getBalance(account){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'getSpecificQuota',sync:true,userId:userId,conversation:conversation,botId:account};return this._botState.callCapability(params);}},{key:'storeBalance',value:function storeBalance(account,balance){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'incrementUserAssignedQuota',sync:true,userId:userId,conversation:conversation,stats:{}};params.stats[account]=balance;return this._botState.callCapability(params);}},{key:'updateBalance',value:function updateBalance(account,balance){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'updateUserUsedQuota',sync:true,userId:userId,conversation:conversation,stats:{}};params.stats[account]=balance;return this._botState.callCapability(params);}},{key:'resetBalance',value:function resetBalance(account,balance){var conversation=this.conversation;var userId=this.userId;var params={capability:'MessageQuotaCapability',capabilityFileName:'messageQuotaCapability',action:'setUserAssignedClearUsedQuota',sync:true,userId:userId,conversation:conversation,stats:{}};params.stats[account]=balance;return this._botState.callCapability(params);}},{key:'getCallRates',value:function getCallRates(isoCountry){try{var conversation=this.conversation;var userId=this.userId;var params={capability:'VoipCapability',capabilityFileName:'voipCapability',action:'getCallTariffsForCountry',isoCountry:isoCountry,userDomains:this._botState.userDomains,sync:true,userId:userId,conversation:conversation};return this._botState.callCapability(params);}catch(error){this._botState.addSystemErrorToStack(8,error.message);}}},{key:'getCallHistory',value:function getCallHistory(){try{var params={action:'getCallHistory',capability:'VoipCapability',capabilityFileName:'voipCapability',userId:this.userId,conversation:this.conversation,sync:true,email:this._botState.user.userEmail};return this._botState.callCapability(params);}catch(error){this._botState.addSystemErrorToStack(8,error.message);}}}]);return Accounts;}();var Error=function(){_createClass(Error,null,[{key:'getErrorMessageforCodeAndLang',value:function getErrorMessageforCodeAndLang(errorCode,lang){var errorsLibrary={0:{en:'No error'},1:{en:'The valid values for RunLocation are Edge and Cloud'},2:{en:'RunLocation attribute is mandatory'},3:{en:'The onResolution function is mandatory'},4:{en:'To process your request, I need to reach the cloud and you appear to be offline at this moment. Please try again later'},5:{en:'Error in edge bot logic with message '},6:{en:'NLP cannot be called with other data than string'},7:{en:'Error processing botResolver in backend'},8:{en:'Error in cloud bot logic with message '},9:{en:'The name for the bot name already exists for your domain, please change it and try again'},10:{en:'An unknown problem has appeared during the bot publication process. Please contact FrontM support.'},11:{en:'Logic error in onError function'},12:{en:'Wrong debug command'},13:{en:'I Cannot run inApp purchases in the cloud'},14:{en:'Invalid message adding a response'},15:{en:'I have not received the authorisation to activate the notifications. You can request me to activate the notifications in any time.'},16:{en:'I could not register your device for notifications at this moment. Please try again later'},17:{en:'I could not modify your password. Please be sure that your old password is correct and that you are following the FrontM password policy'},18:{en:'Capability not available on the cloud'},19:{en:'I encountered a problem unregistering your device for notifications'},20:{en:'I could not deregister your device for notifications at this moment. Please try again later'},21:{en:'Invalid intent object found'},22:{en:'Ambiguous NLP results'},23:{en:'This method requires an array of Strings'},24:{en:'Invalid NLP Id'},25:{en:'Invalid backend capability'},26:{en:'Backend capabilities are not present on edge'},27:{en:'Error running predictors with message '},28:{en:'Bad table action '},29:{en:'Bad form action '},30:{en:'Error on video call'},31:{en:'Error while encrypting data'},32:{en:'Error while decrypting data'},33:{en:'Could not send push notification '},34:{en:'Ambiguous intent matching. Please review your forms, tables and containers looking for duplicated names'},35:{en:'Ambiguous intent matching. Please review your intentIds looking for duplicated names or check your matching rules'},36:{en:'Could not write data in DB'},37:{en:'Error calling service'},38:{en:'Unidentified intent or control'}};return errorsLibrary[errorCode][lang];}}]);function Error(botState,errorCode,errorMessage){_classCallCheck(this,Error);this._errorCode=errorCode;if(errorCode<1000){if(errorMessage){this._errorMessage=Error.getErrorMessageforCodeAndLang(errorCode,botState.lang)+' '+errorMessage;}else{this._errorMessage=Error.getErrorMessageforCodeAndLang(errorCode,botState.lang);}}else{this._errorMessage=errorMessage;}}_createClass(Error,[{key:'errorCode',get:function get(){return this._errorCode;}},{key:'errorMessage',get:function get(){return this._errorMessage;}}]);return Error;}();var MessageTypes=function(){function MessageTypes(){_classCallCheck(this,MessageTypes);}_createClass(MessageTypes,null,[{key:'MESSAGE_TYPE_STRING',value:function MESSAGE_TYPE_STRING(){return 10;}},{key:'MESSAGE_TYPE_IMAGE',value:function MESSAGE_TYPE_IMAGE(){return 30;}},{key:'MESSAGE_TYPE_VIDEO',value:function MESSAGE_TYPE_VIDEO(){return 40;}},{key:'MESSAGE_TYPE_AUDIO',value:function MESSAGE_TYPE_AUDIO(){return 60;}},{key:'MESSAGE_TYPE_HTML',value:function MESSAGE_TYPE_HTML(){return 140;}},{key:'BACKEND_RESPONSE',value:function BACKEND_RESPONSE(){return 150;}},{key:'BOT_TO_BOT',value:function BOT_TO_BOT(){return 160;}},{key:'MESSAGE_TYPE_LIST',value:function MESSAGE_TYPE_LIST(){return 200;}},{key:'MESSAGE_TYPE_SLIDER',value:function MESSAGE_TYPE_SLIDER(){return 210;}},{key:'MESSAGE_TYPE_BUTTON',value:function MESSAGE_TYPE_BUTTON(){return 220;}},{key:'MESSAGE_TYPE_FORM',value:function MESSAGE_TYPE_FORM(){return 230;}},{key:'MESSAGE_TYPE_MAP',value:function MESSAGE_TYPE_MAP(){return 240;}},{key:'MESSAGE_TYPE_SMART_SUGGESTIONS',value:function MESSAGE_TYPE_SMART_SUGGESTIONS(){return 250;}},{key:'MESSAGE_TYPE_WEB_CARD',value:function MESSAGE_TYPE_WEB_CARD(){return 260;}},{key:'MESSAGE_TYPE_STD_NOTIFICATION',value:function MESSAGE_TYPE_STD_NOTIFICATION(){return 270;}},{key:'MESSAGE_TYPE_CRITICAL_NOTIFICATION',value:function MESSAGE_TYPE_CRITICAL_NOTIFICATION(){return 280;}},{key:'MESSAGE_TYPE_LOCATION',value:function MESSAGE_TYPE_LOCATION(){return 290;}},{key:'MESSAGE_TYPE_PDF',value:function MESSAGE_TYPE_PDF(){return 300;}},{key:'MESSAGE_TYPE_TEXT',value:function MESSAGE_TYPE_TEXT(){return 320;}},{key:'MESSAGE_TYPE_OTHER_FILE',value:function MESSAGE_TYPE_OTHER_FILE(){return 330;}},{key:'MESSAGE_TYPE_CSV',value:function MESSAGE_TYPE_CSV(){return 340;}},{key:'MESSAGE_TYPE_JAVASCRIPT',value:function MESSAGE_TYPE_JAVASCRIPT(){return 350;}},{key:'MESSAGE_TYPE_FORM2',value:function MESSAGE_TYPE_FORM2(){return 400;}},{key:'MESSAGE_TYPE_MENU',value:function MESSAGE_TYPE_MENU(){return 410;}},{key:'MESSAGE_TYPE_TABLE',value:function MESSAGE_TYPE_TABLE(){return 420;}},{key:'MESSAGE_TYPE_CONTACT_CARD',value:function MESSAGE_TYPE_CONTACT_CARD(){return 430;}},{key:'MESSAGE_TYPE_DATA_CARD',value:function MESSAGE_TYPE_DATA_CARD(){return 440;}},{key:'MESSAGE_TYPE_FORM_RESPONSE',value:function MESSAGE_TYPE_FORM_RESPONSE(){return 450;}},{key:'MESSAGE_TYPE_STRIPE',value:function MESSAGE_TYPE_STRIPE(){return 460;}},{key:'MESSAGE_TYPE_STRIPE_RESPONSE',value:function MESSAGE_TYPE_STRIPE_RESPONSE(){return 470;}},{key:'MESSAGE_TYPE_CLOSE_FORM',value:function MESSAGE_TYPE_CLOSE_FORM(){return 480;}},{key:'MESSAGE_TYPE_MAP_RESPONSE',value:function MESSAGE_TYPE_MAP_RESPONSE(){return 490;}},{key:'MESSAGE_TYPE_SEARCH_BOX',value:function MESSAGE_TYPE_SEARCH_BOX(){return 510;}},{key:'MESSAGE_TYPE_SEARCH_BOX_RESPONSE',value:function MESSAGE_TYPE_SEARCH_BOX_RESPONSE(){return 520;}},{key:'MESSAGE_TYPE_CARDS',value:function MESSAGE_TYPE_CARDS(){return 530;}},{key:'MESSAGE_TYPE_CARD_ACTION',value:function MESSAGE_TYPE_CARD_ACTION(){return 540;}},{key:'MESSAGE_RUN_MODE',value:function MESSAGE_RUN_MODE(){return 550;}}]);return MessageTypes;}();var State=function(){_createClass(State,null,[{key:'MOBILECLIENT',value:function MOBILECLIENT(){return'mobile';}},{key:'WEBCLIENT',value:function WEBCLIENT(){return'web';}}]);function State(message,conversation,user,location,stateFromStorage,context,args){var _this126=this;_classCallCheck(this,State);this['conversationId']=conversation.conversationId;this['conversation']=conversation;this['client']=this.conversation.client;this['args']=args;this['lang']='en';this['_activeIntent']='';this['_intentHistory']=[];this['_intentStats']={};this['error']=false;this['errorStack']=[];this['responsesArray']=[];this['smartSuggestionsArray']=[];this['_blockSuggestions']=false;this['toCustomCap']=false;this['_silentIntent']=false;this['user']=user;this['intentResolved']=false;this['waitingCustomCap']=0;this['location']=location;this['requestIdsArray']=[];this['context']=null;this['_']=null;this['R']=null;this['Immutable']=null;this['moment']=null;this['momentTimezone']=null;this['messageTypes']={};this['lastGreetingTime']=0;this['lastUserActivity']=0;this['MessageCapability']=null;this['_forms']=[];this['_botFlows']=[];this['_log']=[];this['fields']={};this['_oldFields']={};this['logoutInProcess']=false;this['currentWorkspace']='';this.setContext(context);this['lastSession']=this._.toNumber(this._.now());this['developer']=new Developer(this);this['accounts']=new Accounts(this);this['orders']=new Orders(this);this['sftp']=new SFTP(this);this['notification']=new Notification(this);this['marketplace']=new Marketplace(this);this['jobScheduler']=new JobScheduler(this);this['contacts']=new Contacts(this);this['api']=new API(this);this['db']=new DB(this);this['file']=new File(this);this['sites']=new Sites(this);this['sensors']=new Sensors(this);this['locationServices']=new LocationServices(this);this['trackingServices']=new TrackingServices(this);this['security']=new Security(this);this['nlp']=new NLP(this);this['cc']=new ContactCentre(this);this['companies']=new Companies(this);this['schedules']=new Schedules(this);this['promptAlive']='';this['amIOnline']=true;this['_searchBoxes']=[];this['_currentSearchBox']='';this['sendMessageParam']=null;this['compatibilityMode']=false;this['disambiguate']=false;this['disambiguationNLPId']='';this['_nlpResults']={};this['_lastNLPResults']={};this['_intentDurations']=[];this['_conversational']=true;this['_background']={};this['waitingIcon']={};this['_inputHistory']=[];this['_currentControlId']=null;this['_suggestionsLayout']='horizontal';this['_sidebar']={hidden:false,frozen:false};this['_navbar']={hidden:false,frozen:false};this['fromGreeting']=false;this['oldFormsCompatibility']=false;this['chatButtonHidden']=false;this['_unitTestMode']=false;this['_inSilence']=false;this['_cssFilePath']=null;this['_modal']=true;this['_routesQueue']={};if(stateFromStorage){for(var propertyName in stateFromStorage){if(propertyName==='_botFlows'){this._.each(stateFromStorage[propertyName],function(botFlowFromStorage){var botFlow=new BotFlow(_this126,botFlowFromStorage._name,botFlowFromStorage);_this126._botFlows.push(botFlow);});}else if(propertyName==='_forms'){this._.each(stateFromStorage[propertyName],function(formFromStorage){var form=new Form(_this126,null,formFromStorage);_this126._forms.push(form);});}else if(propertyName==='_debugMode'){this.developer._debugMode=true;}else{this[propertyName]=stateFromStorage[propertyName];}}}if(message){console.log('About to set the message');if(message.messageType){this['messageTypeFromUser']=message.messageType;this['messageFromUser']=message.messageFromUser||'';}else{this['messageTypeFromUser']=message.getMessageType();this['messageFromUser']=message.getMessage();this['messageIdFromUser']=message.getMessageId();var getMessageContentType=function getMessageContentType(message){var MessageTypeConstantsToInt=_this126.context.getCapability('MessageTypeConstantsToInt');return MessageTypeConstantsToInt[message.getMessageType()]||0;};this['messageTypeIntFromUser']=getMessageContentType(message);this['messageCreatedOnFromUser']=message.getMessageDate().valueOf();this['messageCreatedByFromUser']=message.getCreatedBy();var msgContent=message.getMessage();var temp=JSON.stringify(msgContent);temp=temp.replace(/\"\"/g,'" "');msgContent=JSON.parse(temp);this['messageContentFromUser']=this._.isArray(msgContent)?msgContent:[msgContent];this['messageOptionsFromUser']=message.getMessageOptions();}this._inputHistory.push({type:this.R.toString(this.messageTypeFromUser),content:this.R.toString(this.messageFromUser)});this._oldFields=this.fields;if(this._inputHistory.length>5){this._inputHistory.splice(0,1);}}if(this.messageFromUser&&!this.messageFromUser.intentId){this.lastUserActivity=Date.now();}console.log('*************** message type: '+this['messageTypeFromUser']);console.log('*************** message: '+JSON.stringify(this['messageFromUser']));this.defaultOnError=function(){if(_this126.developer.runProfile!==Developer.PROD()){_this126._.forEach(_this126.errorStack,function(error){_this126.addStringResponse(error.errorMessage);});}else{_this126.addStringResponse('Requested information is currently unavailable. Please check back later');}};this.resetOnErrorMethod();}_createClass(State,[{key:'callCapability',value:function callCapability(params){try{var capabilities=this.context.capabilities.capabilities;var capabilityDependencies=this.context.capabilities;if(!capabilities){capabilities=this.context.capabilities;capabilityDependencies=this.context;}var capFileName=params.capabilityFileName;var capabilityModule=capabilities[capFileName];if(capabilityModule){console.log('Executing the capability module');return capabilityModule.execute(params,capabilityDependencies);}}catch(err){this.addSystemErrorToStack(26,'4 '+err.name+': '+err.message);}}},{key:'resetOnErrorMethod',value:function resetOnErrorMethod(){this.clearError();this._onError=this.defaultOnError;}},{key:'getNlpResultsForId',value:function getNlpResultsForId(nlpId){if(this._nlpResults){if(this._nlpResults[nlpId]){return this._nlpResults[nlpId];}}return{};}},{key:'online',value:function online(){if(this.client===State.MOBILECLIENT()&&this.location===Intent.EDGE()){var network=this.context.getCapability('Network');return network.isConnected().then(function(connected){return connected;});}else{return Promise.resolve(true);}}},{key:'addSearchBox',value:function addSearchBox(searchBox){var existingSearchBox=this.getSearchBox(searchBox.id);if(!existingSearchBox){this._searchBoxes.push(searchBox);}else{existingSearchBox.onSearch=searchBox.onSearch;existingSearchBox.onCompletion=searchBox.onCompletion;existingSearchBox.onCancel=searchBox.onCancel;}}},{key:'getSearchBox',value:function getSearchBox(searchBoxId){var i=this._.findIndex(this._searchBoxes,function(searchBox){return searchBox.id===searchBoxId;});return this._searchBoxes[i]||null;}},{key:'addBotFlow',value:function addBotFlow(botFlow){var existingBotFlow=this.getBotFlow(botFlow.name);if(!existingBotFlow){this._botFlows.push(botFlow);}else{existingBotFlow.onStart=botFlow._onStart;}}},{key:'getBotFlow',value:function getBotFlow(botFlowName){var i=this._.findIndex(this._botFlows,function(botFlow){return botFlow.name===botFlowName;});return this._botFlows[i]||null;}},{key:'runLocationVerification',value:function runLocationVerification(method,location){var locationPassed=location===this.location;if(!locationPassed){this.addErrorToStack(1,'Method '+method+' cannot run on the '+this.location);}return locationPassed;}},{key:'setNetworkModeTo',value:function setNetworkModeTo(mode){return this.context.getCapability('Settings').setPollingStrategy(mode);}},{key:'setContext',value:function setContext(context){var _this127=this;this.context=context;if(this.location===Intent.EDGE()){this['userName']=this.user.info.userName;this.user.userName=this.user.info.userName;var utils=this.context.getCapability('Utils');this._=utils.Lodash;this.R=this.context.getCapability('R')||{};this.immutable=this.context.getCapability('Immutable')||{};this.UUID=utils.UUID;this.messageTypes=this.context.getCapability('MessageTypeConstants');this.MessageCapability=this.context.getCapability('Message');this.userDomains=this.user.info.domains;this.moment=this.context.getCapability('Moment');this.momentTimezone=this.context.getCapability('MomentTimezone');if(this.client===State.WEBCLIENT()){this.aws=this.context.getCapability('aws');this.frontmlib=this.context.getCapability('frontmlib');}this.currentWorkspace=this.user.info.lastLoggedInDomain;}else{this._=this.context._;this.R=this.context.R||{};this.immutable=this.context.immutable||{};this.UUID=function(){var ShortUUID=_this127.context.UUID;var uuid=ShortUUID.uuid();return ShortUUID().fromUUID(uuid);};this.userDomains=this.user.userDomains;this.moment=this.context.moment;this.momentTimezone=this.context['momentTimeZone'];this.aws=this.context['aws'];this.frontmlib=this.context['frontmlib'];}}},{key:'syncWithBackendState',value:function syncWithBackendState(state){var _this128=this;if(this.messageTypeFromUser===MessageTypes.BACKEND_RESPONSE()){console.log(JSON.stringify(state));if(state.intentResolved){this.intentResolved=state.intentResolved;}console.log('About to sync botFlows');if(state._botFlows){console.log('Botflows from backend '+JSON.stringify(state._botFlows));var botFlowArray=[];this._.each(state._botFlows,function(botFlowFromBackend){var botFlow=new BotFlow(_this128,botFlowFromBackend._name,botFlowFromBackend);botFlowArray.push(botFlow);});this._botFlows=botFlowArray;}if(state.responsesArray){this._.each(state.responsesArray,function(response){if(response.type==='form2'){var form={};if(_this128.oldFormsCompatibility){form=_this128.getForm(response.message._options.formId);if(form){form.options=response.message._options;form.fields=response.message._fields;}else{form=new Form(_this128,null,response.message);_this128.addForm(form);}}else{form.options=response.message.options;form.fields=response.message.fields;}_this128.addResponse('form2',form);}else if(response.type==='prompt'){_this128._.each(_this128.botFlows,function(botFlow){var entity=botFlow.getEntity(response.message.name);if(entity){var newMessage={type:response.type,message:entity};_this128.responsesArray.push(newMessage);}});}else{_this128.responsesArray.push(response);}});}if(state._activeIntent){this.addActiveIntent(state._activeIntent);}if(state._silentIntent){this._silentIntent=true;}if(state.nlpResponse){this.nlpResponse=state.nlpResponse;}if(state._nlpResults){this._nlpResults=state._nlpResults;this._lastNLPResults=state._nlpResults;}if(state.errorStack){this._.each(state.errorStack,function(error){_this128.addErrorToStack(error._errorCode,error._errorMessage);});}if(state.smartSuggestionsArray){this.smartSuggestionsArray=state.smartSuggestionsArray;}console.log('Starting with logs');if(state._log){this._.each(state._log,function(logEntry){_this128._log.push(logEntry);});}console.log('After logs');this.fields=this.R.merge(this.fields,state.fields);if(state.sendMessageParam){this.sendMessageParam=state.sendMessageParam;}if(state._blockSuggestions){this.blockSuggestions=true;}if(state.clearPrompt){this.promptAlive='';}if(Array.isArray(state.requestIdsArray)){this.requestIdsArray=this.requestIdsArray.concat(state.requestIdsArray);}if(state._intentDurations){this._intentDurations=state._intentDurations;}if(typeof state._conversational==='boolean'){this._conversational=state._conversational;}if(state._background){this._background=state._background;}if(state._sidebar){this._sidebar=state._sidebar;}if(state._navbar){this._navbar=state._navbar;}if(state.fromGreeting){this.fromGreeting=state.fromGreeting;}if(state._inSilence){this._inSilence=state._inSilence;}}else{console.log('I have not synced anything');}}},{key:'getNewRequestId',value:function getNewRequestId(){if(this.UUID){return this.UUID();}else{return null;}}},{key:'getAllProperties',value:function getAllProperties(){var botFlowArray=[];this._.forEach(this._botFlows,function(botFlow){botFlowArray.push(botFlow.getAllProperties());});var formsArray=[];this._.forEach(this._forms,function(form){formsArray.push(form.getAllProperties());});var response={conversationId:this['conversationId'],toCustomCap:this['toCustomCap'],intentResolved:this['intentResolved'],waitingCustomCap:this['waitingCustomCap'],lastGreetingTime:this['lastGreetingTime'],lastUserActivity:this['lastUserActivity'],_log:this._log,_intentDurations:this['_intentDurations']};if(this.promptAlive!==''){response.promptAlive=this.promptAlive;}if(this._activeIntent!==''){response._activeIntent=this._activeIntent;}response.errorStack=this['errorStack'];response.requestIdsArray=this['requestIdsArray'];response._botFlows=botFlowArray;response._forms=formsArray;response.fields=this.fields;response._silentIntent=this._silentIntent;response._lastNLPResults=this._lastNLPResults;response._background=this._background;response._conversational=this._conversational;response._sidebar=this._sidebar;response._inputHistory=this._inputHistory;response._routesQueue=this._routesQueue;if(this.developer._debugMode){response._debugMode=true;}if(this._currentSearchBox!==''){response._currentSearchBox=this._currentSearchBox;}response._intentHistory=this._intentHistory;response.fromGreeting=this.fromGreeting;response._inSilence=this._inSilence;return response;}},{key:'runFunctionOnceAnHour',value:function runFunctionOnceAnHour(functionBlock){var latestTime=this._.now();if(this._.toNumber(latestTime)-this._.toNumber(this.lastGreetingTime)>3600000){this.lastGreetingTime=latestTime;functionBlock();}}},{key:'runFunctionOnceADay',value:function runFunctionOnceADay(functionBlock){var latestTime=this._.now();if(this._.toNumber(latestTime)-this._.toNumber(this.lastGreetingTime)>86400000){this.lastGreetingTime=latestTime;functionBlock();}}},{key:'getDeviceLocation',value:function getDeviceLocation(){return this.context.getCapability('DeviceLocation').getDeviceLocation();}},{key:'updatePassword',value:function updatePassword(oldPassword,newPassword){var _this129=this;var updatedUser={email:this.user.info.emailAddress,oldPassword:oldPassword,newPassword:newPassword};return this.context.getCapability('authContext').updatePassword(updatedUser,this.context).then(function(response){console.log('Password response :',JSON.stringify(response));}).catch(function(error){console.log('Password update error :',JSON.stringify(error));_this129.addSystemErrorToStack(17);});}},{key:'logout',value:function logout(){var _this130=this;this['logoutInProcess']=true;return this.context.getCapability('authContext').logout(this.context).then(function(){_this130.addResponse('silent',{});});}},{key:'sendMessage',value:function sendMessage(message){console.log('============> setting send  message param');this.developer.log({message:'User sending message with '+JSON.stringify(message)});this.sendMessageParam=message;}},{key:'continueInIntentWithIdAndMessage',value:function continueInIntentWithIdAndMessage(intentId,message){var object={intentId:intentId};this.sendMessage(this.R.merge(object,message));}},{key:'processIntentWithIdAndMessage',value:function processIntentWithIdAndMessage(intentId,message){var object={intentId:intentId};this.sendMessage(this.R.merge(object,message));}},{key:'processIntentWithId',value:function processIntentWithId(intentId){var object={intentId:intentId};this.sendMessage(object);}},{key:'cleanFieldsForSave',value:function cleanFieldsForSave(fields){var _this131=this;var cleanFields={};if(typeof fields==='string'){if(fields===''){fields=' ';}return fields;}else if(typeof fields==='object'){if(Array.isArray(fields)){var newArray=[];this._.each(fields,function(entry){var newEntry=_this131.cleanFieldsForSave(entry);newArray.push(newEntry);});return newArray;}else{for(var properyName in fields){var theField=fields[properyName];switch(typeof theField){case'string':{cleanFields[properyName]=this.cleanFieldsForSave(theField);break;}case'object':{cleanFields[properyName]=this.cleanFieldsForSave(theField);break;}default:{cleanFields[properyName]=theField;break;}}}}}else{return fields;}return cleanFields;}},{key:'save',value:function save(){var _this132=this;if(!this['logoutInProcess']){this.fields=this.cleanFieldsForSave(this.fields);this._lastNLPResults=this.cleanFieldsForSave(this._lastNLPResults);return deviceStorageUtil.setInContext(this.getAllProperties(),this.context).then(function(){console.log('State Saved');_this132.developer.info({message:'State saved'});_this132.error=false;return _this132;}).catch(function(err){console.log('State not Saved '+err.message);_this132.developer.info({message:'Error saving the state: '+err.message});_this132.error=true;return _this132;});}}},{key:'getUniqueId',value:function getUniqueId(){return this.UUID();}},{key:'setField',value:function setField(fieldName,fieldValue){this.fields[fieldName]=fieldValue;}},{key:'clearField',value:function clearField(fieldName){delete this.fields[fieldName];}},{key:'getField',value:function getField(fieldName){var field=this.fields[fieldName];if(typeof field!=='undefined'){return field;}else{return null;}}},{key:'hasFieldInPath',value:function hasFieldInPath(path){return!!this.R.path(path,this.fields);}},{key:'addSmartSuggestions',value:function addSmartSuggestions(newSmartSuggestion){this.smartSuggestionsArray.push(newSmartSuggestion);}},{key:'addSmartSuggestionsArray',value:function addSmartSuggestionsArray(newSmartSuggestions){var _this133=this;this.developer.log({message:'Adding smart suggestions',data:newSmartSuggestions});var _=this._;_.each(newSmartSuggestions,function(suggestionObject){if(suggestionObject.lang===_this133.lang){_this133.smartSuggestionsArray=_this133.smartSuggestionsArray.concat(suggestionObject.list);}});}},{key:'addEnglishSmartSuggestions',value:function addEnglishSmartSuggestions(newSmartSuggestions){var smartSuggestionsArray=[{lang:'en',list:newSmartSuggestions}];this.addSmartSuggestionsArray(smartSuggestionsArray);}},{key:'clearSmartSuggestionsArray',value:function clearSmartSuggestionsArray(){console.log('Clearing Suggestions');this.smartSuggestionsArray=[];this._blockSuggestions=false;}},{key:'getForm',value:function getForm(formId){var i=this._.findIndex(this._forms,function(form){return form.formId===formId;});return this._forms[i]||null;}},{key:'addForm',value:function addForm(newForm){var _this134=this;var form=this.getForm(newForm.formId);var createSearchBox=function createSearchBox(field){if(field.type==='search_box'){var searchBox=new SearchBox(_this134,field.id,field.prompt,'single');searchBox.onSearch=field.onSearch;_this134.addSearchBox(searchBox);}};if(form){form.onSubmit=newForm.onSubmit;form.onCancel=newForm.onCancel;form.onClose=newForm.onClose;this._.each(form.fields,function(field){var newField=newForm.getField(field.id);if(newField){field.title=newField.title;field.type=newField.type;field.mandatory=newField.mandatory;field.validation=newField.validation;field.readOnly=newField.readOnly;field.options=newField.options;field.info=newField.info;field.onCompletion=newField.onCompletion;field.onSearch=newField.onSearch;field.onMoveOut=newField.onMoveOut;}createSearchBox(field);});}else{this._.each(newForm.fields,function(field){createSearchBox(field);});this._forms.push(newForm);}}},{key:'removeForm',value:function removeForm(formToDelete){var i=this._.findIndex(this._forms,function(form){return formToDelete.formId===form.formId;});if(i>-1){this._forms.splice(i,1);}}},{key:'addActiveIntent',value:function addActiveIntent(intentId){var _this135=this;var logHistory=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var silent=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;this._silentIntent=silent;var cutIn10=function cutIn10(){if(_this135._intentHistory.length>10){_this135._intentHistory.splice(0,1);cutIn10();}};if(intentId==='main'){if(this._intentHistory.length>0){this._activeIntent=this.previousActiveIntent;}else{this._activeIntent=intentId;if(logHistory){this._intentHistory.push(intentId);}}}else{this._activeIntent=intentId;if(logHistory){this._intentHistory.push(intentId);}}cutIn10();}},{key:'removeActiveIntent',value:function removeActiveIntent(){if(this._activeIntent!==''){this._activeIntent='';}}},{key:'addSystemErrorToStack',value:function addSystemErrorToStack(code,message,data){var errorObject=new Error(this,code,message);this.developer.systemError({message:errorObject.errorMessage,errorCode:code,data:data});this.errorStack.push(errorObject);}},{key:'addErrorToStack',value:function addErrorToStack(code,message,data){var errorObject={};if(code<999){errorObject=new Error(this,1000,message);}else{errorObject=new Error(this,code,message);}this.developer.userError({message:errorObject.errorMessage,errorCode:code,data:data});this.errorStack.push(errorObject);}},{key:'clearError',value:function clearError(){this.errorStack=[];}},{key:'addStringResponse',value:function addStringResponse(message){this.addResponse('string',message);}},{key:'addStandardNotificationResponse',value:function addStandardNotificationResponse(message){this.addResponse(this.messageTypes.MESSAGE_TYPE_STD_NOTIFICATION,message);}},{key:'addCriticalNotificationResponse',value:function addCriticalNotificationResponse(message){this.addResponse(this.messageTypes.MESSAGE_TYPE_CRITICAL_NOTIFICATION,message);}},{key:'addAuthorizationRequestResponse',value:function addAuthorizationRequestResponse(message){this.addResponse('authorization_request',message);}},{key:'addFormResponse',value:function addFormResponse(message){this.addResponse('form2',message);}},{key:'addFormChangeResponse',value:function addFormChangeResponse(message){this.developer.log({message:'Form change message',data:message});this.addResponse('form_live_changes',message);}},{key:'addMapResponse',value:function addMapResponse(message){this.addResponse('map',message);}},{key:'addChartResponse',value:function addChartResponse(message){this.addResponse('chart',message);}},{key:'addTableResponse',value:function addTableResponse(message){this.addResponse('table',message);}},{key:'addTrackingViewResponse',value:function addTrackingViewResponse(message){this.addResponse('trackerForm',message);}},{key:'addCardsResponse',value:function addCardsResponse(message){this.addResponse('cards',message);}},{key:'addHTMLResponse',value:function addHTMLResponse(message){this.addResponse('html',{message:{},options:message});}},{key:'addContainerResponse',value:function addContainerResponse(message){this.addResponse('container',message);}},{key:'addVideoCallResponse',value:function addVideoCallResponse(message){this.addResponse('videoCall',message);}},{key:'addMenuResponse',value:function addMenuResponse(message){this.addResponse('menuMessage',message);}},{key:'addSoundResponse',value:function addSoundResponse(message){var soundMessage=message;if(!message){soundMessage={sound:'FrontM_Ring.mp3'};}this.addResponse('sound',soundMessage);}},{key:'addCsvResponse',value:function addCsvResponse(message){this.addResponse('csv',message);}},{key:'addFloorPlanResponse',value:function addFloorPlanResponse(message){this.addResponse(FloorPlan.FLOOR_PLAN_MESSAGE(),message);}},{key:'addGeofenceResponse',value:function addGeofenceResponse(message){this.addResponse(Geofence.GEOFENCE_MESSAGE(),message);}},{key:'addGallerySelectionResponse',value:function addGallerySelectionResponse(message){this.addResponse(GallerySelection.GALLERY_SELECTION_MESSAGE(),message);}},{key:'addJourneyPlanResponse',value:function addJourneyPlanResponse(message){this.addResponse(JourneyPlan.JOURNEY_PLAN_MESSAGE(),message);}},{key:'addRunModeResponse',value:function addRunModeResponse(){var runModeMessage={conversational:this.conversational,background:this.background,sidebar:this.sidebar,navbar:this.navbar,chatButtonHidden:this.chatButtonHidden,waitingIcon:this._waitingIcon,cssFilePath:this._cssFilePath,suggestionsLayout:this._suggestionsLayout,modal:this._modal};console.log('Runmode===========> '+this.R.toString(runModeMessage));var Message=this.context.getCapability('Message');var message=new Message();message.runMode(runModeMessage);this.context.tell(message);}},{key:'addStringResponseFromArray',value:function addStringResponseFromArray(messages){var error=false;if(Array.isArray(messages)){var index=Math.round(Math.random()*(messages.length-1));var message=messages[index];if(typeof message==='string'){this.addResponse('string',message);}else{error=true;}}else{error=true;}if(error){this.addErrorToStack(23,Error.getErrorMessageforCodeAndLang(23,this.lang));}}},{key:'addSilentResponse',value:function addSilentResponse(){this.developer.info({message:'Adding Silent response'});this.addResponse('silent',{});}},{key:'addResponse',value:function addResponse(type,message){if(this.developer.runProfile){if(type==='string'){this.developer.info({message:'Added response '+message});}else if(type==='form2'&&this.oldFormsCompatibility){this.developer.info({message:'Added response '+JSON.stringify(message.getAllProperties())+' of type '+type});}else{this.developer.info({message:'Added message type '+type});}}if(message){if(message.options){this.developer.debug({message:"My currentControlId",data:this.currentControlId});message.options['parentControlId']=this.currentControlId;if(!message.options.controlId){message.options.controlId=this.getUniqueId();}}var messageToView=message;if(type==='form2'&&this.location===Intent.CLOUD()&&this.oldFormsCompatibility){messageToView=message.getAllProperties();}this.responsesArray.push({type:type,message:messageToView});}else{this.addSystemErrorToStack(14,type);}}},{key:'clearRoutesQueue',value:function clearRoutesQueue(){this._routesQueue={};}},{key:'clearResponseArray',value:function clearResponseArray(){this.responsesArray=[];}},{key:'setWaitingCustomCap',value:function setWaitingCustomCap(){if(!this.silentIntent){this.waitingCustomCap+=1;}}},{key:'resetWaitingForCustomCapCounter',value:function resetWaitingForCustomCapCounter(){this.waitingCustomCap=0;}},{key:'addRequestId',value:function addRequestId(requestId){this.requestIdsArray.unshift(requestId);if(this.requestIdsArray.length>10){this.requestIdsArray.pop();}}},{key:'markRequestIdProcessed',value:function markRequestIdProcessed(requestId){var indexOfRequestId=this.requestIdsArray.indexOf(requestId);if(indexOfRequestId===-1){this.addRequestId(requestId);console.log('Adding requestId');if(this.waitingCustomCap>0){this.waitingCustomCap-=1;}return true;}else{console.log('did not find requestId');return false;}}},{key:'stateToBackEnd',value:function stateToBackEnd(){var botFlowArray=[];this._.each(this._botFlows,function(botFlow){botFlowArray.push(botFlow.getAllProperties());});var formsArray=[];this._.each(this._forms,function(form){formsArray.push(form.getAllProperties());});var stateToBackend={lang:this.lang,intentResolved:this.intentResolved,messageTypeFromUser:this.messageTypeFromUser,messageFromUser:this.messageFromUser,messageIdFromUser:this.messageIdFromUser,messageTypeIntFromUser:this.messageTypeIntFromUser,messageCreatedOnFromUser:this.messageCreatedOnFromUser,messageCreatedByFromUser:this.messageCreatedByFromUser,messageContentFromUser:this.messageContentFromUser,messageOptionsFromUser:this.messageOptionsFromUser,userName:this.userName,fields:this.fields,_intentHistory:this._intentHistory};if(this.fromGreeting){stateToBackend.fromGreeting=this.fromGreeting;}if(this._.size(botFlowArray)>0){stateToBackend._botFlows=botFlowArray;}if(this.promptAlive!==''){stateToBackend.promptAlive=this.promptAlive;}if(this._activeIntent!==''){stateToBackend._activeIntent=this._activeIntent;}if(this._intentDurations!==''){stateToBackend._intentDurations=this._intentDurations;}if(this._.size(formsArray)>0){stateToBackend._forms=formsArray;}if(this.developer._debugMode){stateToBackend._debugMode=true;}if(this.client===State.WEBCLIENT()){stateToBackend.client=this.client;}if(this._currentSearchBox!==''){stateToBackend._currentSearchBox=this._currentSearchBox;}stateToBackend.client=this.client;stateToBackend.currentWorkspace=this.currentWorkspace;stateToBackend._inSilence=this._inSilence;return{state:stateToBackend};}},{key:'getFinalResponse',value:function getFinalResponse(){var _=this._;var finalResponse={};if(this.excuteIntentAsApi){finalResponse.responsesArray=this['responsesArray']||[];return finalResponse;}if(this['_activeIntent']!==''){finalResponse._activeIntent=this['_activeIntent'];}if(this.nlpResponse){finalResponse.nlpResponse=this.nlpResponse;}if(this._nlpResults){finalResponse._nlpResults=this._nlpResults;}if(_.size(this['errorStack'])>0){finalResponse.errorStack=this['errorStack'];}finalResponse.fields=this['fields'];if(_.size(this['_log'])>0){finalResponse._log=this['_log'];}if(_.size(this['responsesArray'])>0){finalResponse.responsesArray=this['responsesArray'];}if(this['smartSuggestionsArray']&&_.size(this['smartSuggestionsArray'])>0){finalResponse.smartSuggestionsArray=this['smartSuggestionsArray'];}if(this['intentResolved']){finalResponse.intentResolved=this['intentResolved'];}var botFlowArray=[];this._.forEach(this._botFlows,function(botFlow){if(botFlow.isChanged){botFlowArray.push(botFlow.getAllProperties());}});if(botFlowArray.length>0){finalResponse._botFlows=botFlowArray;}if(this.developer._debugMode){finalResponse._debugMode=true;}if(this.sendMessageParam){finalResponse.sendMessageParam=this.sendMessageParam;}if(this.blockSuggestions){finalResponse._blockSuggestions=true;}if(this.silentIntent){finalResponse._silentIntent=true;}if(this.clearPrompt){finalResponse.clearPrompt=true;}if(this.requestIdsArray.length>0){finalResponse.requestIdsArray=this.requestIdsArray;}if(this._intentDurations){finalResponse._intentDurations=this._intentDurations;}if(this.fromGreeting){finalResponse._conversational=this._conversational;finalResponse._background=this._background;finalResponse._sidebar=this._sidebar;finalResponse.fromGreeting=this.fromGreeting;}if(this._inSilence){finalResponse._inSilence=this._inSilence;}return finalResponse;}},{key:'getGreetingIntent',value:function getGreetingIntent(Bot){var _this136=this;var _=this._;var greetingIntent=null;_.each(Bot(this),function(intent){if(_.get(intent,'intentId')==='main'){greetingIntent=intent;return false;}else if(!_.get(intent,'intentId')){_this136.addSystemErrorToStack(38);}else{_this136.developer.debug({message:'Looping intents',data:_.get(intent,'intentId')});}});return greetingIntent;}},{key:'silenceBot',value:function silenceBot(){this._inSilence=true;}},{key:'wakeUpBot',value:function wakeUpBot(){this._inSilence=false;}},{key:'resumeBot',value:function resumeBot(){this._inSilence=false;}},{key:'setVerticalSuggestions',value:function setVerticalSuggestions(){this._suggestionsLayout='vertical';}},{key:'addMeToTheConversation',value:function addMeToTheConversation(conversationId){var CONVERSATIONS_TABLE,query,conversationObject,participants,doc,key,cachedConversation,parsedCacheConversation;return regeneratorRuntime.async(function addMeToTheConversation$(_context201){while(1){switch(_context201.prev=_context201.next){case 0:console.log('Start assignment');CONVERSATIONS_TABLE='Conversations';query=[{operand:'conversationId',value:conversationId,operator:'eq'},{operand:'userDomain',value:this.currentUserDomain,operator:'eq'}];_context201.next=5;return regeneratorRuntime.awrap(this.db.getData(CONVERSATIONS_TABLE,query));case 5:conversationObject=_context201.sent;console.log('Got data');console.log(this.R.toString(conversationObject));if(!conversationObject.items){_context201.next=28;break;}participants=this._.get(conversationObject.items[0],'participants');if(!(participants.indexOf(this.user.userId)===-1)){_context201.next=28;break;}participants.push(this.user.userId);console.log(this.R.toString(participants));doc=[{key:{conversationId:conversationId,userDomain:this.currentUserDomain},document:{participants:participants}}];console.log('Write data');_context201.next=17;return regeneratorRuntime.awrap(this.db.writeData(CONVERSATIONS_TABLE,doc));case 17:key='Conversations_'+conversationId+'_'+this.currentUserDomain;_context201.next=20;return regeneratorRuntime.awrap(this.db.getValueFromCache(key));case 20:cachedConversation=_context201.sent;parsedCacheConversation=JSON.parse(cachedConversation.content);parsedCacheConversation.participants=participants;console.log('Conversation to save in cache '+this.R.toString(parsedCacheConversation));_context201.next=26;return regeneratorRuntime.awrap(this.db.setOneValueInCache(key,parsedCacheConversation));case 26:console.log('Write cache');console.log('Conversation from cache '+this.R.toString(cachedConversation));case 28:case'end':return _context201.stop();}}},null,this);}},{key:'onError',set:function set(onErrorBlock){this._onError=onErrorBlock;},get:function get(){return this._onError;}},{key:'forms',get:function get(){return this._forms;}},{key:'silentIntent',get:function get(){return this._silentIntent;}},{key:'activeIntent',get:function get(){return this._activeIntent;}},{key:'nlpResults',get:function get(){return this._nlpResults;},set:function set(nlpResults){this._nlpResults=nlpResults;}},{key:'previousActiveIntent',get:function get(){var l=this._intentHistory.length;var r='';if(l>1){if(this._activeIntent===''){r=this._intentHistory[l-1];}else{r=this._intentHistory[l-2];}}else{if(l===1){if(this._activeIntent===''){r=this._intentHistory[0];}}}return r;}},{key:'botFlows',get:function get(){return this._botFlows;}},{key:'searchBoxes',get:function get(){return this._searchBoxes;}},{key:'currentSearchBox',set:function set(searchBox){this._currentSearchBox=searchBox;},get:function get(){return this._currentSearchBox;}},{key:'blockSuggestions',set:function set(flag){this._blockSuggestions=flag;},get:function get(){return this._blockSuggestions;}},{key:'inError',get:function get(){return this._.size(this.errorStack)>0;}},{key:'conversational',set:function set(flag){this._conversational=flag;},get:function get(){return this._conversational;}},{key:'waitingIcon',set:function set(waitingIcon){this._waitingIcon=waitingIcon;},get:function get(){return this._waitingIcon;}},{key:'background',set:function set(message){this._background=message;},get:function get(){return this._background;}},{key:'sidebar',set:function set(message){this._sidebar=message;},get:function get(){return this._sidebar;}},{key:'navbar',set:function set(message){this._navbar=message;},get:function get(){return this._navbar;}},{key:'cssFilePath',set:function set(message){this._cssFilePath=message;},get:function get(){return this._cssFilePath;}},{key:'intentHistory',get:function get(){return this.intentHistory;}},{key:'currentUserDomain',get:function get(){return this.conversation.userDomain;}},{key:'isPublic',get:function get(){if(this.user.userName.substring(0,5)==='Anon_'){return true;}return false;}},{key:'unitTestMode',get:function get(){return this._unitTestMode;},set:function set(mode){this._unitTestMode=true;}},{key:'inSilence',get:function get(){return this._inSilence;}},{key:'modal',get:function get(){return this._modal;},set:function set(modal){this._modal=modal;}},{key:'currentControlId',get:function get(){return this._currentControlId;},set:function set(currentControlId){this._currentControlId=currentControlId;}}]);return State;}();var SYNC=false;var NO_INTENT_MESSAGE="Sorry, I didn't get that";var iAmTheOne=null;var waitForRunmode=500;var timeout=function timeout(ms){return new Promise(function(resolve){return setTimeout(resolve,ms);});};var deviceStorageUtil={conversation:'',getContext:function getContext(botContext,DeviceStorage){DeviceStorage=DeviceStorage||botContext.getCapability('DeviceStorage');return DeviceStorage.get(deviceStorageUtil.conversation);},setInContext:function setInContext(state,botContext){var DeviceStorage=botContext.getCapability('DeviceStorage');return DeviceStorage.save(state.conversationId,state);},resetContext:function resetContext(conversationId,botContext){var DeviceStorage=botContext.getCapability('DeviceStorage');return DeviceStorage.save(conversationId,{});},removeFromContext:function removeFromContext(key,botContext){var DeviceStorage=botContext.getCapability('DeviceStorage');return deviceStorageUtil.getContext(botContext,DeviceStorage).then(function(state){delete state[key];return DeviceStorage.save(deviceStorageUtil.conversation,state);});}};var callLambda=function callLambda(functionName,params,aws){var lambda=new aws.Lambda();console.log('Calling lambda');return lambda.invoke({FunctionName:functionName,Payload:JSON.stringify(params,null,0)}).promise();};var runMatchers=function runMatchers(state){console.log('************* Matchers method ****************');state.developer.info({message:'Starting matching event'});var start=Date.now();var _=state._;var promiseProcessed=false;return new Promise(function(resolve,reject){if(state.messageTypeFromUser===MessageTypes.BACKEND_RESPONSE()||state.activeIntent!==''){promiseProcessed=true;resolve();}else if(state.developer.isDeveloperIntent()){var devIntent=state.developer.identifyDeveloperIntent();if(devIntent){state.addActiveIntent(devIntent,false);}else{state.addSystemErrorToStack(12);state.addActiveIntent(Intent.NO_INTENT());}promiseProcessed=true;resolve();}else{_.each(Bot(state),function(intent){if(intent.intentId){if(intent.runLocation){if(intent.runLocation!==Intent.EDGE()&&intent.runLocation!==Intent.CLOUD()){state.addSystemErrorToStack(1);resolve();promiseProcessed=true;return false;}if(typeof intent.onMatching==='function'&&intent.intentId!=='main'){state.developer.info({message:'Trying to match',data:intent.intentId});if(intent.onMatching(state)){if(promiseProcessed){state.developer.info({message:'Second intent matched to '+intent.intentId});if(state.messageTypeFromUser===Form2.FORM_RESPONSE()||state.messageTypeFromUser===Table.TABLE_RESPONSE()||state.messageTypeFromUser===Container.CONTAINER_RESPONSE()){state.addSystemErrorToStack(34);}else{state.addSystemErrorToStack(35);}state.removeActiveIntent();return false;}else{state.developer.info({message:'Intent matched to '+intent.intentId});state.addActiveIntent(intent.intentId,intent.logHistory,intent.silentIntent);promiseProcessed=true;if(intent.runLocation===Intent.CLOUD()&&state.client===State.MOBILECLIENT())state.toCustomCap=true;}}}}else{state.addSystemErrorToStack(2);resolve();promiseProcessed=true;return false;}}else{state.addSystemErrorToStack(21);resolve();promiseProcessed=true;return false;}});}return state.online().then(function(online){if(!promiseProcessed){if(online&&state.messageTypeFromUser===state.messageTypes.MESSAGE_TYPE_STRING&&state.client===State.MOBILECLIENT()){state.toCustomCap=true;}}else{if(!online&&state.toCustomCap){state.toCustomCap=false;}}resolve();state.developer.logCurrentEventDurationWithStartTime('runMatchers',start,Date.now());});});};var callCustomCap=function callCustomCap(state){console.log('************* Calling custom cap ****************');state.developer.info({message:'Calling cloud capabilities'});var start=Date.now();var agentGuardService=state.context.getCapability('agentGuardService');var requestId=state.getNewRequestId();console.log('State to backend '+JSON.stringify(state.stateToBackEnd()));return agentGuardService.executeBackendBot(state.stateToBackEnd(),SYNC,requestId,state.context,state.user).then(function(response){console.log('Here within the then '+JSON.stringify(response));state.setWaitingCustomCap();state.developer.logCurrentEventDurationWithStartTime('callCustomCap',start,Date.now());}).catch(function(error){console.log('Here within the catch '+JSON.stringify(error));if(agentGuardService.AG_ERRORS.QUEUED_REQUEST===error){return state.offline().then(function(online){if(!online){state.addStringResponse("Your device appears to be offline, but don't worry, I will process your message as soon as the connection is back and I will let you know.");}});}else{state.addSystemErrorToStack(5,error);}state.developer.logCurrentEventDurationWithStartTime('callCustomCap',start,Date.now());});};var runValidators=function runValidators(state){console.log('************* Validators method ****************');state.developer.info({message:'Starting validation event'});var start=Date.now();var _=state._;var activeIntent=state.activeIntent;var validationResult=true;if(activeIntent!==Intent.NO_INTENT()){_.each(Bot(state),function(intent){if(intent.intentId===activeIntent){if(intent.onError){state.onError=intent.onError;}try{if(intent.onValidation){state.developer.info({message:'Starting onValidation for intent '+intent.intentId});intent.onValidation(state);if(state._.size(state.errorStack)>0){}}}catch(error){state.addSystemErrorToStack(5,error.message);}}});}state.developer.logCurrentEventDurationWithStartTime('runValidators',start,Date.now());return validationResult;};var runResolvers=function runResolvers(state){console.log('************* Resolvers method ****************');state.developer.info({message:'Starting resolution event'});var start=Date.now();var _=state._;return new Promise(function(resolve,reject){console.log('In promise');var activeIntent=state.activeIntent;if(activeIntent.substring(0,5)==='_dev_'){if(activeIntent.substring(0,13)==='_dev_backend_'){return callCustomCap(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('controller',start,Date.now());});}else{state.developer.processCommand(activeIntent);}resolve();}else if(activeIntent===''){console.log('Empty intent');state.addActiveIntent(Intent.NO_INTENT());resolve();}else if(activeIntent!==Intent.NO_INTENT()){console.log('Before loop');_.each(Bot(state),function(intent){if(intent.intentId===activeIntent){console.log('Found intent');if(intent.onResolution){console.log('Found onResolution');state.developer.info({message:'Starting onResolution for intent '+intent.intentId});return intent.onResolution(state).then(function(){console.log('Passed onResolution');state.developer.info({message:'Resolution passed'});resolve();state.developer.logCurrentEventDurationWithStartTime('runResolvers',start,Date.now());}).catch(function(error){state.addSystemErrorToStack(5,'Error processing resolution on edge '+error.message);resolve();state.developer.logCurrentEventDurationWithStartTime('runResolvers',start,Date.now());});}else{state.addSystemErrorToStack(3);resolve();state.developer.logCurrentEventDurationWithStartTime('runResolvers',start,Date.now());}}});}});};var msgState={msgList:[]};var tellOrTest=function tellOrTest(state,msg,botContext){if(state.unitTestMode){var currentUnitTest=void 0;_.get(Bot(state),function(intent){if(intent.intentId===state.activeIntent&&intent.runLocation===Intent.EDGE()){currentUnitTest=intent;return false;}});if(currentUnitTest){return currentUnitTest.onVerification().then(function(){tell(UnitTest.VERIFICATION_RUN_MSG(),botContext);});}}else{tell(msg,botContext);}};var tell=function tell(msg,botContext){botContext.tell(msg);};var processGreeting=function processGreeting(state){var start,greetingIntent,onResolution,_start;return regeneratorRuntime.async(function processGreeting$(_context202){while(1){switch(_context202.prev=_context202.next){case 0:console.log('Processing greeting');start=Date.now();greetingIntent=state.getGreetingIntent(Bot);state.developer.logCurrentEventDurationWithStartTime('searchForMainIntent',start,Date.now());state.addActiveIntent(greetingIntent.intentId,greetingIntent.logHistory,greetingIntent.silentIntent);state._routesQueue={};if(!greetingIntent){_context202.next=17;break;}state.addRunModeResponse();if(!(greetingIntent.runLocation===Intent.CLOUD()&&state.client===State.MOBILECLIENT())){_context202.next=13;break;}state.context.wait(true);return _context202.abrupt('return',callCustomCap(state));case 13:onResolution=greetingIntent.onResolution;_start=Date.now();if(!onResolution){_context202.next=17;break;}return _context202.abrupt('return',onResolution(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('mainOnResolution',_start,Date.now());}));case 17:case'end':return _context202.stop();}}},null,_this);};var initialiseGreetingState=function initialiseGreetingState(conversation,user,stateParam,botContext,args){console.log('Initialising State');var emptyMessage=null;var state=new State(emptyMessage,conversation,user,'Edge',stateParam,botContext,args);state.resetWaitingForCustomCapCounter();return state;};var startInfoLogs=function startInfoLogs(state,event,stateFromStorage){Bot(state);if(event==='Greeting'){state.developer.info({message:'State initialised (Greeting)'});}else{state.developer.info({message:'State initialised (Next)'});}state.developer.info({message:'State from storage: ',data:stateFromStorage});state.developer.info({message:'Message type from user: ',data:state.messageTypeFromUser});state.developer.info({message:'Message from User: ',data:state.messageFromUser});};var continueGreeting=function continueGreeting(botContext,previousMessages,args){var start=Date.now();var conversation=null;var user=null;var state={};var sendMessageParam=null;var startStorageCap=0;var endStorageCap=0;var startConvCap=0;var endConvCap=0;var startAuthCap=Date.now();var endAuthCap=0;var authContext=botContext.getCapability('authContext');return authContext.getAuthUser(botContext).then(function(usr){endAuthCap=Date.now();startConvCap=Date.now();user=usr;var conversationContext=botContext.getCapability('ConversationContext');return conversationContext.getConversationContext(botContext,user);}).then(function(context){endConvCap=Date.now();startStorageCap=Date.now();conversation=context;console.log('Conversation: '+JSON.stringify(conversation));deviceStorageUtil.conversation=conversation.conversationId;return deviceStorageUtil.getContext(botContext);}).then(function(stateFromStorage){endStorageCap=Date.now();var startState=Date.now();console.log('State from storage'+JSON.stringify(stateFromStorage));user.userName=user.info.name;user.userId=user.info.userId;user.userEmail=user.info.emailAddress;state=initialiseGreetingState(conversation,user,stateFromStorage,botContext,args);startInfoLogs(state,'Greeting',stateFromStorage);state.developer.logCurrentEventDurationWithStartTime('loadAuthCap',startAuthCap,endAuthCap);state.developer.logCurrentEventDurationWithStartTime('loadConversationCap',startConvCap,endConvCap);state.developer.logCurrentEventDurationWithStartTime('loadStorageCap',startStorageCap,endStorageCap);state.developer.logCurrentEventDurationWithStartTime('initialiseGreetingState',startState,Date.now());state.fromGreeting=true;state.clearRoutesQueue();if(!state.inSilence)return processGreeting(state);}).then(function(){console.log(JSON.stringify(state.getAllProperties()));return view(state,botContext);}).then(function(){if(state.intentResolved){state.intentResolved=false;}if(state.sendMessageParam){sendMessageParam=state.sendMessageParam;state.sendMessageParam=null;}state.developer.logCurrentEventDurationWithStartTime('allGreeting',start,Date.now());return state.save();}).then(function(){console.log('============> Before If');if(sendMessageParam){console.log('============> Found the send message '+JSON.stringify(sendMessageParam));var message={messageFromUser:sendMessageParam};if(typeof sendMessageParam==='string'){message.messageType='string';}else{message.messageType='object';}return next(message,{},previousMessages,botContext);}}).then(function(){return{status:200};}).catch(function(error){if(state){state.developer.systemError({message:'Critical error running Greeting',data:error.message});}return tellOrTest(state,'Something wrong has happened '+error.message,botContext);});};var greeting=function greeting(state,previousMessages,botContext){console.log('************* Greeting method ****************');iAmTheOne='Initialised';if(state.reset){return continueGreeting(botContext,previousMessages,state.args);}else{var archiveUtils=botContext.getCapability('archiveUtils');return archiveUtils.overrideBotForArchive(this,msgState,botContext).then(function(){console.log('************* First then ****************');return archiveUtils.overrideTellForArchive(tell,msgState,botContext);}).then(function(newTell){tell=newTell;return continueGreeting(botContext,previousMessages,state.args);});}};var runPredictors=function runPredictors(state){var start,_,R,predictors,sortedPredictions,theBot,index,intent,predictionObject,predictor,_index;return regeneratorRuntime.async(function runPredictors$(_context203){while(1){switch(_context203.prev=_context203.next){case 0:start=Date.now();_=state._;R=state.R;console.log('*************** Running predictors ******************');state.developer.info({message:'Starting prediction event'});if(!(_.size(state.smartSuggestionsArray)===0&&!state.blockSuggestions)){_context203.next=38;break;}predictors=false;sortedPredictions=[];theBot=Bot(state);index=0;case 10:if(!(index<theBot.length)){_context203.next=37;break;}intent=theBot[index];predictionObject={};console.log('Checking intent '+intent.intentId);console.log('Intent suggestions'+intent.suggestionsArray);if(!(_.size(intent.suggestionsArray)>0)){_context203.next=34;break;}predictor=intent.onPrediction;if(!predictor){_context203.next=30;break;}_context203.prev=18;predictors=true;_context203.next=22;return regeneratorRuntime.awrap(predictor());case 22:predictionObject.weight=_context203.sent;_context203.next=28;break;case 25:_context203.prev=25;_context203.t0=_context203['catch'](18);state.addSystemErrorToStack(27,_context203.t0.errorMessage);case 28:_context203.next=31;break;case 30:predictionObject.weight=1;case 31:predictionObject.suggestionsArray=intent.suggestionsArray;if(predictionObject.weight>0){_index=_.sortedIndexBy(sortedPredictions,predictionObject,'weight');sortedPredictions.splice(_index,0,predictionObject);}console.log('Intent suggestions'+predictionObject.suggestionsArray);case 34:index++;_context203.next=10;break;case 37:if(predictors){_.each(sortedPredictions,function(predictionObject){state.addSmartSuggestionsArray(predictionObject.suggestionsArray);});console.log('Intent suggestions'+state.smartSuggestionsArray);state.smartSuggestionsArray=_.reverse(state.smartSuggestionsArray);}case 38:console.log('*************** Leaving predictors ******************');state.developer.logCurrentEventDurationWithStartTime('runPredictors',start,Date.now());case 40:case'end':return _context203.stop();}}},null,_this,[[18,25]]);};var controller=function controller(state){var start=Date.now();var _=state._;console.log('************* Controller method ****************');state.developer.info({message:'Starting controller event'});return state.online().then(function(online){state.amIOnline=online;return matchingLogic(state).then(function(){if(state.activeIntent!==Intent.SPEECH()&&state.activeIntent!==Intent.NO_INTENT()){if(state.toCustomCap){return callCustomCap(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('controller',start,Date.now());});}else{if(!state.promptAlive||state.activeIntent.substring(0,5)==='_dev_'){if(runValidators(state)){return runResolvers(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('controller',start,Date.now());});}}}}}).catch(function(error){state.addSystemErrorToStack(5,error.message);});});};var view=function view(state,botContext){console.log('************* View method ****************');state.developer.info({message:'Starting view event'});var _=state._;var start=Date.now();return new Promise(function _callee124(resolve,reject){var noResponse,smartSuggestions,MessageForSuggestions,messageForSuggestions;return regeneratorRuntime.async(function _callee124$(_context204){while(1){switch(_context204.prev=_context204.next){case 0:if(!(state.fromGreeting&&!state.conversational&&!state.inError&&state.waitingCustomCap>0)){_context204.next=2;break;}return _context204.abrupt('return');case 2:console.log('Suggestions before predictors: '+JSON.stringify(state.smartSuggestionsArray));console.log('Intent History '+JSON.stringify(state._intentHistory));console.log('Active Intent '+state.activeIntent);if(state.inSilence){_context204.next=8;break;}_context204.next=8;return regeneratorRuntime.awrap(runPredictors(state));case 8:console.log('Suggestions after predictors: '+JSON.stringify(state.smartSuggestionsArray));state.developer.info({message:'Start processing responses'});if(state.inError){console.log(JSON.stringify(state.errorStack));state.onError(state);}else{if(!state.fromGreeting&&state.responsesArray.length===0&&state.smartSuggestionsArray.length===0&&!state.sendMessageParam&&!state.toCustomCap){console.log('Going to no intent');noResponse={fromGreeting:state.fromGreeting,responsesQ:state.responsesArray.length,suggestionsQ:state.smartSuggestionsArray.length,sendMSG:state.sendMessageParam,toCustomCap:state.toCustomCap,activeIntent:state.activeIntent};state.developer.info({message:'Found No Intent',data:noResponse});state.addStringResponse(NO_INTENT_MESSAGE);}}state.removeActiveIntent();if(!state.silentIntent){_context204.next=18;break;}console.log('Exiting view due to silent intent');state.clearResponseArray();state.clearError();resolve();return _context204.abrupt('return');case 18:if(state.fromGreeting){state.fromGreeting=false;}smartSuggestions=state.smartSuggestionsArray;console.log('Before evaluating responses for '+state.responsesArray.length+' message');if(_.size(state.responsesArray)>0){state.intentResolved=true;_.each(state.responsesArray,function(response){var Message=state.context.getCapability('Message');var message=new Message();if(response.type===state.messageTypes.MESSAGE_TYPE_STRING){console.log('I am trying to tell something here: '+response.message);tellOrTest(state,response.message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_WEB_CARD){var cards=response.message.cards;var previews=response.message.previews;message.webCard(cards,previews);tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_FORM2){console.log('************* Form capability ****************');var form=response.message;console.log('In view Form instance of Form? '+form instanceof Form);if(state.oldFormsCompatibility){form.openForm();}console.log(JSON.stringify(form.fields));console.log(JSON.stringify(form.options));message.form2Message(form.fields,form.options);tellOrTest(state,message,state.context);}else if(response.type==='form_live_changes'){if(response.message.result){message.form2Message(response.message.result,response.message.options);}else{message.form2Message(response.message.options);}tellOrTest(state,message,state.context);}else if(response.type==='form_close'){if(message.closeFormMessage){message.closeFormMessage(response.message);tellOrTest(state,message,state.context);}}else if(response.type===state.messageTypes.MESSAGE_TYPE_SMART_SUGGESTIONS){smartSuggestions=response.message;}else if(response.type===state.messageTypes.MESSAGE_TYPE_TABLE){console.log('printing a table');var table=response.message;if(table.options&&table.options.style===Table.CALENDAR_TABLE_STYLE()){message.calendarMessage(table.rows,table.options);}else{message.tableMessage(table.rows,table.options);}tellOrTest(state,message,state.context);}else if(response.type==='data_card'){console.log('printing a card');if(state.conversation.client===State.MOBILECLIENT()){var list=response.message;console.log(JSON.stringify(list));message.dataCard(list);tellOrTest(state,message,state.context);}else{var msg='Data cards are not yet available in your client';state.addSystemErrorToStack(5,msg);tellOrTest(state,msg,state.context);}}else if(response.type===state.messageTypes.MESSAGE_TYPE_CARDS){console.log('printing the new cards');var _list=response.message.cards;var options=response.message.options;console.log(JSON.stringify(_list));message.cards(_list,options);tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_MAP){var map=response.message;var mapObject={region:map.region,markers:_.get(map,'markers'),polylines:_.get(map,'polylines'),planeRoutes:_.get(map,'planeRoutes'),cards:_.get(map,'cards'),geoJsonUrl:_.get(map,'geoJsonUrl','')};console.log('Printing Map '+JSON.stringify(mapObject));message.mapMessage(mapObject,map.options);tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_STD_NOTIFICATION){console.log('Printing standard notification:: ',response.message);message.standardNotification(response.message);tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_CRITICAL_NOTIFICATION){message.criticalNotification(response.message);tellOrTest(state,message,state.context);}else if(response.type==='authorization_request'){message.authorizationRequest(response.message);tellOrTest(state,message,state.context);}else if(response.type==='stripe'){if(state.client===State.MOBILECLIENT()){var _msg='Message type not supported on this client';state.addSystemErrorToStack(5,_msg);tellOrTest(state,_msg,state.context);}else{var _response$message=response.message,amount=_response$message.amount,currency=_response$message.currency,description=_response$message.description,paymentCode=_response$message.paymentCode;if(_.isUndefined(paymentCode)||_.isEmpty(paymentCode)){paymentCode=Orders.PAYMENT_CODES().TOP_UP_WALLET;}var transactionId=state.orders.createNewStripeTransaction(amount,currency,description);var payments=state.context.getCapability('Stripe');payments.startPayment(transactionId,amount,currency,description,state.context,paymentCode);}}else if(response.type===state.messageTypes.MESSAGE_TYPE_CHART){var chart=response.message;message.chartMessage(chart.data,chart.options);tellOrTest(state,message,state.context);}else if(response.type==='prompt'){var promptEntity=response.message;var fields=state.getForm(promptEntity.form).fields;var field=fields[promptEntity.promptIndex];state.promptAlive=promptEntity.name;tellOrTest(state,field.prompt,state.context);if(field.type==='search_box'){var searchBox=state.getSearchBox(field.id);message.searchBoxMessage(searchBox.getMessageWith());state.currentSearchBox=searchBox.id;smartSuggestions=[];tellOrTest(state,message,state.context);}}else if(response.type==='search_box'){var _searchBox=void 0;if(response.message.action){_searchBox=state.getSearchBox(response.message.id);}else{_searchBox=state.getSearchBox(response.message);}message.searchBoxMessage(_searchBox.getMessageWith(response.message.action,response.message.results));state.currentSearchBox=_searchBox.id;smartSuggestions=[];tellOrTest(state,message,state.context);}else if(response.type==='slider'){message.sliderMessage(response.message.list,response.message.options);tellOrTest(state,message,state.context);}else if(response.type==='oldChart'){message.chartMessage({chart_type:'scatter',data:response.message});tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_VIDEO){message.videoMessage(response.message);tellOrTest(state,message,state.context);}else if(response.type==='trackerForm'){message.trackingViewMessage(response.message.data,response.message.options);console.log('Sending trackerForm');tellOrTest(state,message,state.context);}else if(response.type==='html'){message.htmlMessage(response.message.message,response.message.options);console.log('Sending html');tellOrTest(state,message,state.context);}else if(response.type==='container'){message.containerMessage(response.message.fields,response.message.options);console.log('Sending container');tellOrTest(state,message,state.context);}else if(response.type==='close_control'){message.closeControlMessage(response.message);console.log('Sending cloose control');}else if(response.type==='videoCall'){message.videoCallMessage(response.message);console.log('Sending video call');tellOrTest(state,message,state.context);}else if(response.type==='menuMessage'){message.menuMessage(response.message);console.log('Sending menu');tellOrTest(state,message,state.context);}else if(response.type==='sound'){message.soundResponse(response.message);console.log('Sending sound');tellOrTest(state,message,state.context);}else if(response.type==='image'){message.imageMessage(response.message);console.log('Sending image');tellOrTest(state,message,state.context);}else if(response.type===state.messageTypes.MESSAGE_TYPE_CSV){message.csvMessage(response.message);console.log('Sending csv');tellOrTest(state,message,state.context);}else if(response.type===FloorPlan.FLOOR_PLAN_MESSAGE()){message.floorplan(response.message);console.log('Sending floorPlan');tellOrTest(state,message,state.context);}else if(response.type===Geofence.GEOFENCE_MESSAGE()){message.geofenceMessage(response.message.coordinates,response.message.options);console.log('Sending Geofence');tellOrTest(state,message,state.context);}else if(response.type!=='silent'){var _msg2='Message type not supported';state.addSystemErrorToStack(5,_msg2);tellOrTest(state,_msg2,state.context);}});}else{console.log('Nothing in view');}state.clearResponseArray();state.clearError();MessageForSuggestions=state.context.getCapability('Message');messageForSuggestions=new MessageForSuggestions();if(_.size(state.smartSuggestionsArray)>0){messageForSuggestions.smartSuggestions(smartSuggestions);console.log(JSON.stringify(smartSuggestions));state.developer.info({message:'Displaying suggestions '+JSON.stringify(smartSuggestions)});tellOrTest(state,messageForSuggestions,state.context);}else{if(state.blockSuggestions||state.inSilence){messageForSuggestions.smartSuggestions([]);tellOrTest(state,messageForSuggestions,state.context);}}state.clearSmartSuggestionsArray();state.resetOnErrorMethod();state.developer.info({message:'Finished processing responses'});state.toCustomCap=false;resolve();state.developer.logCurrentEventDurationWithStartTime('view',start,Date.now());case 33:case'end':return _context204.stop();}}},null,_this);});};var next=function next(msg,stateParam,previousMessages,botContext){console.log('************* Next method ****************');var start=Date.now();var startStorageCap=0;var endStorageCap=0;var startConvCap=0;var endConvCap=0;var startAuthCap=Date.now();var endAuthCap=0;var authContext=botContext.getCapability('authContext');var conversation=null;var user=null;var state=null;var sendMessageParam=null;return authContext.getAuthUser(botContext).then(function(usr){endAuthCap=Date.now();user=usr;var conversationContext=botContext.getCapability('ConversationContext');startConvCap=Date.now();return conversationContext.getConversationContext(botContext,user);}).then(function(context){endConvCap=Date.now();conversation=context;deviceStorageUtil.conversation=conversation.conversationId;console.log(JSON.stringify(conversation));startStorageCap=Date.now();return deviceStorageUtil.getContext(botContext);}).then(function(stateFromStorage){console.log('State from storage '+JSON.stringify(stateFromStorage));var startState=Date.now();endStorageCap=Date.now();user.userName=user.info.name;user.userId=user.info.userId;user.userEmail=user.info.emailAddress;state=new State(msg,conversation,user,'Edge',stateFromStorage,botContext);startInfoLogs(state,'Next',stateFromStorage);state.developer.logCurrentEventDurationWithStartTime('loadAuthCap',startAuthCap,endAuthCap);state.developer.logCurrentEventDurationWithStartTime('loadConversationCap',startConvCap,endConvCap);state.developer.logCurrentEventDurationWithStartTime('loadStorageCap',startStorageCap,endStorageCap);state.developer.logCurrentEventDurationWithStartTime('initialiseState',startState,Date.now());state.developer.info({message:'State initialised (Next)'});}).then(function(){if(msg.requestId){if(!state.markRequestIdProcessed(msg.requestId)){return Promise.resolve('ignore');}}console.log('Before syncing the state');state.syncWithBackendState(stateParam);if(state.intentResolved||state._.size(state.errorStack)>0){console.log('Intent resolved apparently');return Promise.resolve();}else{return controller(state);}}).then(function(noNeedForView){console.log('Entered view block');if(noNeedForView){console.log('Got a duplicated call');return noNeedForView;}return view(state,botContext);}).then(function(noNeedForView){console.log('Entered state save block');console.log('Last print '+JSON.stringify(state.getAllProperties()));botContext.wait(false);console.log(JSON.stringify(state.messageFromUser));console.log(state.sendMessageParam);if(!state.silentIntent&&!state.intentResolved&&(state.waitingCustomCap>0&&state.messageTypeFromUser!=='search_box_response'&&state.messageFromUser.action!=='close'&&state.messageFromUser.action!=='move'&&state.messageFromUser.action!=='cancel'&&state.messageTypeFromUser!==MessageTypes.BOT_TO_BOT()||state.sendMessageParam)){console.log('Setting to wait');botContext.wait(true);}if(state.intentResolved){state.intentResolved=false;}if(state.sendMessageParam){sendMessageParam=state.sendMessageParam;state.sendMessageParam=null;}state.developer.logCurrentEventDurationWithStartTime('totalNextMethod',start,Date.now());if(noNeedForView!=='ignore'){return state.save();}}).then(function(){console.log('Entered sendMessage block');if(sendMessageParam){console.log('Sending a new message');var message={messageFromUser:sendMessageParam};var toGreeting=false;if(typeof sendMessageParam==='string'){message.messageType='string';}else{message.messageType='object';if(sendMessageParam.intentId&&sendMessageParam.intentId==='@@reset'){toGreeting=true;}}if(toGreeting){return greeting({reset:true},previousMessages,botContext);}else{return next(message,{},previousMessages,botContext);}}}).then(function(){return{status:200};}).catch(function(error){console.log('Catch block');if(state instanceof State){state.addSystemErrorToStack(5,error.message);return view(state,botContext).then(function(){state.save();});}else{console.log('Something very wrong '+error.message);}}).then(function(){console.log('Are we here?');return{status:200};});};var asyncResult=function asyncResult(result,stateParam,previousMessages,botContext){console.log('************ Async Results *************');var utils=botContext.getCapability('Utils');var _=utils.Lodash;var state=_.get(result,'details[0].message');if(_.get(state,'success')){return;}var requestId=_.get(result,'requestUuid');if(state&&requestId&&requestId!==''){var contentType=_.get(result,'contentType');var createdOn=_.get(result,'createdOn');var createdBy=_.get(result,'createdBy');var messageId=_.get(result,'messageId');var message={messageDate:createdOn,createdBy:createdBy,uuid:messageId,requestId:requestId,contentType:contentType};if(contentType===MessageTypes.BACKEND_RESPONSE()){message.messageType=MessageTypes.BACKEND_RESPONSE();}else{message.messageType=MessageTypes.BOT_TO_BOT();message.messageFromUser=state;}console.log('************* Data Received ****************');console.log(JSON.stringify(result));console.log('************* Data Received ****************');return next(message,state,previousMessages,botContext);}};var debug=function debug(state){return{localState:state};};var runNlp=function runNlp(state){var D=state.developer;console.log('Inside runNLP');var nlpBotsList=state.nlp.nlpIds;state.developer.info({message:'Starting NLP event',data:nlpBotsList});if(!state.inSilence&&state.messageTypeFromUser==='string'){if(state.nlp.nlpEngine===NLP.DIALOGFLOW()){if(nlpBotsList.length>0){var params={capability:'NLP2',capabilityFileName:'nlpv2',queryString:state.messageFromUser,nlpIds:nlpBotsList,sync:true,userId:state.user.userId,conversation:state.conversation};console.log('Calling NLP saying '+state.messageFromUser);return state.callCapability(params);}else{state.developer.warning({message:'No NLP Engine added to the bot'});}return[];}else{return new Promise(function(resolve,reject){var params={botAlias:state.nlp.nlpAlias,botName:state.nlp.nlpIds[0],inputText:state.messageFromUser,userId:state.conversationId,sessionAttributes:{}};var lexRuntime=new state.aws.LexRuntime();lexRuntime.postText(params,function(err,data){if(err)resolve(err);else resolve(data);});});}}};var processNLPResponse=function processNLPResponse(state,dataArray){var _=state._;var R=state.R;var startNLP=Date.now();if(state.nlp.nlpEngine===NLP.DIALOGFLOW()){_.each(dataArray,function(nlpResponse){state.developer.info({message:'Response from NLP',data:nlpResponse});if(nlpResponse.error==='Invalid NLP ID'){state.addSystemErrorToStack(24,nlpResponse.nlpId);return;}var nlpParameters='';var action=nlpResponse.action;var nlpId=nlpResponse.nlpId;state.developer.info({message:'Found NLP action: ',data:action});if(nlpResponse.parameters&&_.size(nlpResponse.parameters)>0){nlpParameters=nlpResponse.parameters;state.developer.info({message:'Found NLP parameters: ',data:nlpParameters});}var suggestions=[];if(nlpResponse.messages){_.forEach(nlpResponse.messages,function(entry){if(entry.type===4){if(entry.payload.messages){state.addSmartSuggestionsArray([{lang:state.lang,list:entry.payload.messages}]);suggestions=entry.payload.messages;}}});}state.nlpResults[nlpId]={speech:''};if(nlpResponse.speech&&nlpResponse.speech!==''){state.nlpResults[nlpId].speech=nlpResponse.speech;}state.nlpResults[nlpId].action=action;state.nlpResults[nlpId].nlpParameters=state.nlp.getNlpParameters(nlpParameters);state.nlpResults[nlpId].nlpSuggestions=suggestions;});}else{var nlpId=state.nlp.nlpIds[0];state.nlpResults[nlpId]={action:dataArray.intentName,nlpParameters:dataArray.slots};if(dataArray.message!==''){state.nlpResults[nlpId].speech=dataArray.message;}}state.developer.logCurrentEventDurationWithStartTime('nlpAnalysis',startNLP,Date.now());};var matchingLogic=function matchingLogic(state){var _,R,D,startNLP,dataArray,unambiguousResults,latestNoIntentSpeech;return regeneratorRuntime.async(function matchingLogic$(_context205){while(1){switch(_context205.prev=_context205.next){case 0:_=state._;R=state.R;D=state.developer;if(!(state.fromGreeting&&!state.inSilence)){_context205.next=6;break;}_context205.next=26;break;case 6:if(!(state.activeIntent==='')){_context205.next=26;break;}_context205.next=9;return regeneratorRuntime.awrap(runMatchers(state));case 9:if(!(state.activeIntent==='')){_context205.next=25;break;}startNLP=Date.now();if(!(state.location===Intent.CLOUD()||state.client===State.WEBCLIENT())){_context205.next=17;break;}_context205.next=14;return regeneratorRuntime.awrap(runNlp(state));case 14:_context205.t0=_context205.sent;_context205.next=18;break;case 17:_context205.t0=[];case 18:dataArray=_context205.t0;D.logCurrentEventDurationWithStartTime('nlpCalls',startNLP,Date.now());if(!(Array.isArray(dataArray)&&dataArray.length>0)){_context205.next=25;break;}D.debug({message:'Before processing NLP',data:dataArray});processNLPResponse(state,dataArray);_context205.next=25;return regeneratorRuntime.awrap(runMatchers(state));case 25:if(state.activeIntent===''){if(_.size(state.nlpResults)>0){console.log('Got nlp results');unambiguousResults=true;latestNoIntentSpeech="Sorry, I didn't get that";_.each(state.nlpResults,function(result){console.log('Processing result '+R.toString(result));if(result.speech!==''){if(result.action===Intent.NO_INTENT()){latestNoIntentSpeech=result.speech;}else{if(unambiguousResults){state.addActiveIntent(Intent.SPEECH());state.addStringResponse(result.speech);unambiguousResults=false;}else{if(!state.disambiguate){state.addSystemErrorToStack(22);}}}}});if(state.responsesArray.length===0){state.addStringResponse(latestNoIntentSpeech);}}}case 26:case'end':return _context205.stop();}}},null,_this);};var asyncRequest=function asyncRequest(params,dependencies){var Promise=dependencies.promise;var _=dependencies._;var R=dependencies.R;var start=Date.now();var stateFromEdge=params.state;var conversationFromEdge=params.conversation;console.log('Conversation from agentGuard '+R.toString(params.conversation));console.log(JSON.stringify(params));var userFromEdge={userId:params.userId,userEmail:params.userEmail,userDomains:params.userDomains,userName:params.state.userName};var emptyMessage=null;var state=new State(emptyMessage,conversationFromEdge,userFromEdge,'Cloud',stateFromEdge,dependencies);state.developer.info({message:'State initialised (cloud)'});var promise=Promise.resolve();var greetingIntent=state.getGreetingIntent(Bot);if(greetingIntent.onInit){var _start2=Date.now();promise=greetingIntent.onInit(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('onInitBackend',_start2,Date.now());});}return promise.then(function(){state.nlpResults={};return matchingLogic(state);}).then(function(){if(state.fromGreeting&&!state.inSilence){var _start3=Date.now();var onResolution=greetingIntent.onResolution;if(onResolution){state.addActiveIntent('main');return onResolution(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('mainOnResolution',_start3,Date.now());});}else{return;}}if(state.inError){return;}var startController=Date.now();if(state.activeIntent!==''&&state.activeIntent!==Intent.SPEECH()&&state.activeIntent!==Intent.NO_INTENT()){console.log('Going to run validators');runValidators(state);if(_.size(state.errorStack)===0){console.log('Going to run resolvers');return runResolvers(state).then(function(){state.developer.logCurrentEventDurationWithStartTime('backendController',startController,Date.now());});}}}).then(function(){console.log('ending in success');if(_.size(state.responsesArray)>0||state.inError||state.sendMessageParam||state.fromGreeting){console.log('Intent resolved');state.intentResolved=true;if(state.activeIntent.substring(0,5)==='_dev_'){state.removeActiveIntent();}}else{console.log('On the else');if(state.cloudIntent){state.intentResolved=false;console.log('Found NO INTENT');state.developer.info({message:'Found No intent'});state.addActiveIntent(Intent.NO_INTENT());}}try{if(state._.size(state.errorStack)>0){state.onError(state);state.resetOnErrorMethod();}}catch(err){state.addSystemErrorToStack(11,err.message);}state.developer.logCurrentEventDurationWithStartTime('fullCustomCap',start,Date.now());var response=state.getFinalResponse();state.developer.info({message:'Response to Edge',data:response});state=null;return response;}).catch(function(error){console.log('ending in error');state.addSystemErrorToStack(8,error);var response=state.getFinalResponse();state=null;return response;});};var farewell=function farewell(msg,state,previousMessages,botContext){};var open=function open(msg,state,previousMessages,botContext){};return{done:farewell,init:greeting,next:next,open:open,debug:debug,asyncResult:asyncResult,asyncRequest:asyncRequest,version:'1.0.0'};})();